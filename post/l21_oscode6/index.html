<!DOCTYPE html>
<html lang="zh-cn" >
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  
  <meta name="author"
        content="Bruce Cheung"/>

  
  <meta name="description" content=""/>
  

  
  
  <meta name="keywords" content="blog, simple, dream"/>
  

  
  <link rel="canonical" href="https://oubc.github.io/post/l21_oscode6/"/>

  

  <title>Linuxç³»ç»Ÿç¼–ç¨‹ (çº¿&amp;è¿›ç¨‹åŒæ­¥ é”) &middot; Love, or death</title>

  <link rel="shortcut icon" href="https://oubc.github.io/images/favicon.ico"/>
  <link rel="stylesheet" href="https://oubc.github.io/css/animate.min.css"/>
  <link rel="stylesheet" href="https://oubc.github.io/css/remixicon.css"/>
  <link rel="stylesheet" href="https://oubc.github.io/css/zozo.css"/>
  <link rel="stylesheet" href="https://oubc.github.io/css/highlight.css"/>

  
  
</head>

<body>
<div class="main animated">
  <div class="nav_container animated fadeInDown">
  <div class="site_nav" id="site_nav">
    <ul>
      
      <li>
        <a href="/">é¦–é¡µ</a>
      </li>
      
      <li>
        <a href="/post/">å½’æ¡£</a>
      </li>
      
      <li>
        <a href="/tags/">æ ‡ç­¾</a>
      </li>
      
      <li>
        <a href="/about/">å…³äº</a>
      </li>
      
    </ul>
  </div>
  <div class="menu_icon">
    <a id="menu_icon"><i class="remixicon-links-line"></i></a>
  </div>
</div>

  <div class="header animated fadeInDown">
  <div class="site_title_container">
    <div class="site_title">
      <h1>
        <a href="https://oubc.github.io/">
          <span>Love, or death</span>
          <img src="https://oubc.github.io/images/logo.svg"/>
        </a>
      </h1>
    </div>
    <div class="description">
      <p class="sub_title">For you, a thousand times over.</p>
      <div class="my_socials">
        
        
        <a href="https://github.com/oubc" title="github" target="_blank"><i class="remixicon-github-fill"></i></a>
        
        
        
        <a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=uYGOjo6OiIuLivnIyJfa1tQ" title="mail" target="_blank"><i class="remixicon-mail-fill"></i></a>
        
        
        
        <a href="http://sighttp.qq.com/msgrd?v=1&amp;uin=877771223" title="qq" target="_blank"><i class="remixicon-qq-fill"></i></a>
        
        
        
        <a href="https://github.com/oubc/oubc.github.io/blob/master/images/wx.jpg?raw=true" title="wechat" target="_blank"><i class="remixicon-wechat-fill"></i></a>
        
        
        
        <a href="https://weibo.com/u/6993631995?topnav=1&amp;wvr=6&amp;topsug=1" title="weibo" target="_blank"><i class="remixicon-weibo-fill"></i></a>
        
        
        <a href="https://oubc.github.io/index.xml" type="application/rss+xml" title="rss" target="_blank"><i class="remixicon-rss-fill"></i></a>
      </div>
    </div>
  </div>
</div>

  <div class="content">
    <div class="post_page">
      <div class="post animated fadeInDown">
        <div class="post_title post_detail_title">
          <h2><a href='/post/l21_oscode6/'>Linuxç³»ç»Ÿç¼–ç¨‹ (çº¿&amp;è¿›ç¨‹åŒæ­¥ é”)</a></h2>
          <span class="date">2019.10.06</span>
        </div>
        <div class="post_content markdown"><p><br>
<br>
<font color = gray size = 2>åˆ—è¡¨ï¼Œå±•å¼€ç‚¹å‡»è·³è½¬</font>
<br>
<details class="menu" close>
      <summary><font color=blue size = 4>çº¿ç¨‹åŒæ­¥</font></summary>
      <ul>
          <li><a href="#bc0">åŒæ­¥æ¦‚å¿µ</a></li>
          <li><a href="#bc1">çº¿ç¨‹åŒæ­¥</a></li>
          <li><a href="#bc2">æ•°æ®æ··ä¹±åŸå› </a></li>
          <li><a href="#bc3">äº’æ–¥é‡ mutex</a></li>
          <li><a href="#bc4">ä¸»è¦å‡½æ•°åŠåº”ç”¨</a></li>
      </ul>
</details>
<details class="menu" close>
      <summary><font color=blue size = 4>æ­»é”</font></summary>
      <ul>
          <li><a href="#bc5">æ­»é”æè¿°åŠå®ç°</a></li>
      </ul>
</details>
<details class="menu" close>
      <summary><font color=blue size = 4>è¯»å†™é”</font></summary>
      <ul>
          <li><a href="#bc6">è¯»å†™é”æ¦‚è¿°</a></li>
          <li><a href="#bc7">è¯»å†™é”çŠ¶æ€</a></li>
          <li><a href="#bc8">ä¸»è¦å‡½æ•°åŠåº”ç”¨</a></li>
      </ul>
</details>
<details class="menu" close>
      <summary><font color=blue size = 4>æ¡ä»¶å˜é‡</font></summary>
      <ul>
          <li><a href="#bc9">æ¡ä»¶å˜é‡æ¦‚è¿°</a></li>
          <li><a href="#bc10">ä¸»è¦å‡½æ•°åŠåº”ç”¨</a></li>
          <li><a href="#bc11">æ¡ä»¶å˜é‡çš„ä¼˜ç‚¹</a></li>
      </ul>
</details>
<details class="menu" close>
      <summary><font color=blue size = 4>ä¿¡å·é‡</font></summary>
      <ul>
          <li><a href="#bc12">ä¿¡å·é‡æ¦‚è¿°</a></li>
          <li><a href="#bc13">ä¿¡å·é‡åŸºæœ¬æ“ä½œã€ä¸»è¦å‡½æ•°åŠåº”ç”¨</a></li>
      </ul>
</details>
<details class="menu" close>
      <summary><font color=blue size = 4>è¿›ç¨‹åŒæ­¥</font></summary>
      <ul>
          <li><a href="#bc14">äº’æ–¥é‡ mutex</a></li>
          <li><a href="#bc15">ä¸»è¦å‡½æ•°åŠåº”ç”¨</a></li>
      </ul>
</details>
<details class="menu" close>
      <summary><font color=blue size = 4>æ–‡ä»¶é”</font></summary>
      <ul>
          <li><a href="#bc16">æ–‡ä»¶é”æ¦‚è¿°</a></li>
          <li><a href="#bc17">ä¸»è¦å‡½æ•°åŠåº”ç”¨</a></li>
      </ul>
</details>
<br>
<br>
<br>
<br>
<br><font color=black size = 5><a name="bc0">åŒæ­¥æ¦‚å¿µ</a></font>
<br> âœ¦ æ‰€è°“åŒæ­¥ï¼Œå³åŒæ—¶èµ·æ­¥ï¼Œåè°ƒä¸€è‡´ã€‚ä¸åŒçš„å¯¹è±¡ï¼Œå¯¹â€œåŒæ­¥â€çš„ç†è§£æ–¹å¼ç•¥æœ‰ä¸åŒï¼Œå¦‚ï¼š
<br>&nbsp;&nbsp;&nbsp;&nbsp; è®¾å¤‡åŒæ­¥æ˜¯æŒ‡åœ¨ä¸¤ä¸ªè®¾å¤‡ä¹‹é—´è§„å®šä¸€ä¸ªå…±åŒçš„æ—¶é—´å‚è€ƒï¼›
<br>&nbsp;&nbsp;&nbsp;&nbsp; æ•°æ®åº“åŒæ­¥æ˜¯æŒ‡è®©ä¸¤ä¸ªæˆ–å¤šä¸ªæ•°æ®åº“å†…å®¹ä¿æŒä¸€è‡´ï¼Œæˆ–è€…æŒ‰éœ€è¦éƒ¨åˆ†ä¿æŒä¸€è‡´ï¼›
<br>&nbsp;&nbsp;&nbsp;&nbsp; æ–‡ä»¶åŒæ­¥æ˜¯æŒ‡è®©ä¸¤ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶å¤¹é‡Œçš„æ–‡ä»¶ä¿æŒä¸€è‡´
<br>&nbsp;&nbsp;&nbsp;&nbsp; è€Œåœ¨ç¼–ç¨‹ã€é€šä¿¡ä¸­çš„åŒæ­¥ä¸­çš„â€œåŒâ€å­—åº”æ˜¯æŒ‡ååŒã€ååŠ©ã€äº’ç›¸é…åˆï¼Œä¸»æ—¨åœ¨ååŒæ­¥è°ƒï¼ŒæŒ‰é¢„å®šçš„å…ˆåæ¬¡åºè¿è¡Œã€‚
<br>
<br><font color=black size = 5><a name="bc1">çº¿ç¨‹åŒæ­¥</a></font>
<br>&nbsp;&nbsp;&nbsp;&nbsp; åŒæ­¥å³ååŒæ­¥è°ƒï¼ŒæŒ‰é¢„å®šçš„å…ˆåæ¬¡åºè¿è¡Œã€‚
<br> âœ¦ çº¿ç¨‹åŒæ­¥ï¼ŒæŒ‡ä¸€ä¸ªçº¿ç¨‹å‘å‡ºæŸä¸€åŠŸèƒ½è°ƒç”¨æ—¶ï¼Œåœ¨æ²¡æœ‰å¾—åˆ°ç»“æœä¹‹å‰ï¼Œè¯¥è°ƒç”¨ä¸è¿”å›ï¼ŒåŒæ—¶å…¶å®ƒçº¿ç¨‹ä¸ºä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œä¸èƒ½è°ƒç”¨è¯¥åŠŸèƒ½ã€‚
<br> âœ¦ ä¸¾ä¾‹1ï¼šé“¶è¡Œå­˜æ¬¾ 5000ã€‚æŸœå°ï¼ŒæŠ˜ï¼šå–3000ï¼›ææ¬¾æœºï¼Œå¡ï¼šå– 3000ã€‚å‰©ä½™ï¼š2000
<br> âœ¦ ä¸¾ä¾‹2ï¼šå†…å­˜ä¸­100å­—èŠ‚ï¼Œçº¿ç¨‹T1æ¬²å¡«å…¥å…¨1ï¼Œçº¿ç¨‹T2æ¬²å¡«å…¥å…¨0ã€‚ä½†å¦‚æœT1æ‰§è¡Œäº†50ä¸ªå­—èŠ‚å¤±å»cpuï¼ŒT2æ‰§è¡Œï¼Œä¼šå°†T1å†™è¿‡çš„å†…å®¹è¦†ç›–ã€‚å½“T1å†æ¬¡è·å¾—cpuç»§ç»­ï¼Œä»å¤±å»cpuçš„ä½ç½®å‘åå†™å…¥1ï¼Œå½“æ‰§è¡Œç»“æŸï¼Œå†…å­˜ä¸­çš„100å­—èŠ‚ï¼Œæ—¢ä¸æ˜¯å…¨1ï¼Œä¹Ÿä¸æ˜¯å…¨0ã€‚
<br> âœ¦ äº§ç”Ÿçš„ç°è±¡å«åšâ€œä¸æ—¶é—´æœ‰å…³çš„é”™è¯¯â€(time related)ï¼Œä¸ºäº†é¿å…è¿™ç§æ•°æ®æ··ä¹±ï¼Œçº¿ç¨‹éœ€è¦åŒæ­¥ã€‚
<br> âœ¦ â€œåŒæ­¥â€çš„ç›®çš„ï¼Œæ˜¯ä¸ºäº†é¿å…æ•°æ®æ··ä¹±ï¼Œè§£å†³ä¸æ—¶é—´æœ‰å…³çš„é”™è¯¯ã€‚å®é™…ä¸Šï¼Œä¸ä»…çº¿ç¨‹é—´éœ€è¦åŒæ­¥ï¼Œè¿›ç¨‹é—´ã€ä¿¡å·é—´ç­‰ç­‰éƒ½éœ€è¦åŒæ­¥æœºåˆ¶ã€‚
<br> âœ¦ å› æ­¤ï¼Œæ‰€æœ‰â€œå¤šä¸ªæ§åˆ¶æµï¼Œå…±åŒæ“ä½œä¸€ä¸ªå…±äº«èµ„æºâ€çš„æƒ…å†µï¼Œéƒ½éœ€è¦åŒæ­¥ã€‚
<br>
<br><font color=black size = 5><a name="bc2">æ•°æ®æ··ä¹±åŸå› </a></font>
<br> 0ã€èµ„æºå…±äº«ï¼ˆç‹¬äº«èµ„æºåˆ™ä¸ä¼šï¼‰
<br> 1ã€è°ƒåº¦éšæœºï¼ˆæ„å‘³ç€æ•°æ®è®¿é—®ä¼šå‡ºç°ç«äº‰ï¼‰
<br> 2ã€çº¿ç¨‹é—´ç¼ºä¹å¿…è¦çš„åŒæ­¥æœºåˆ¶ã€‚
<br> âœ¦ ä»¥ä¸Š3ç‚¹ä¸­ï¼Œå‰ä¸¤ç‚¹ä¸èƒ½æ”¹å˜ï¼Œæ¬²æé«˜æ•ˆç‡ï¼Œä¼ é€’æ•°æ®ï¼Œèµ„æºå¿…é¡»å…±äº«ï¼Œåªè¦å…±äº«èµ„æºï¼Œå°±ä¸€å®šä¼šå‡ºç°ç«äº‰ï¼Œåªè¦å­˜åœ¨ç«äº‰å…³ç³»ï¼Œæ•°æ®å°±å¾ˆå®¹æ˜“å‡ºç°æ··ä¹±ã€‚
<br> âœ¦ æ‰€ä»¥åªèƒ½ä»ç¬¬ä¸‰ç‚¹ç€æ‰‹è§£å†³ã€‚ä½¿å¤šä¸ªçº¿ç¨‹åœ¨è®¿é—®å…±äº«èµ„æºçš„æ—¶å€™ï¼Œå‡ºç°äº’æ–¥ã€‚
<br>
<br><font color=black size = 5><a name="bc3">äº’æ–¥é‡ mutex </a></font>
<br> âœ¦ Linuxä¸­æä¾›ä¸€æŠŠäº’æ–¥é”mutexï¼ˆä¹Ÿç§°ä¹‹ä¸ºäº’æ–¥é‡ï¼‰ã€‚
<br> âœ¦ æ¯ä¸ªçº¿ç¨‹åœ¨å¯¹èµ„æºæ“ä½œå‰éƒ½å°è¯•å…ˆåŠ é”ï¼ŒæˆåŠŸåŠ é”æ‰èƒ½æ“ä½œï¼Œæ“ä½œç»“æŸè§£é”ã€‚
<br> âœ¦ èµ„æºè¿˜æ˜¯å…±äº«çš„ï¼Œçº¿ç¨‹é—´ä¹Ÿè¿˜æ˜¯ç«äº‰çš„
<br> âœ¦ ä½†æ˜¯é€šè¿‡â€œé”â€å°±å°†èµ„æºçš„è®¿é—®å˜æˆäº’æ–¥æ“ä½œï¼Œè€Œåä¸æ—¶é—´æœ‰å…³çš„é”™è¯¯ä¹Ÿä¸ä¼šå†äº§ç”Ÿäº†ã€‚
<br><img src="https://github.com/oubc/oubc.github.io/blob/master/images/L21_OScode.png?raw=true" width="800" height="600" />
<br> ğŸˆ æ³¨æ„ï¼šåŒä¸€æ—¶åˆ»ï¼Œåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æŒæœ‰è¯¥é”ã€‚
<br> âœ¦ å½“Açº¿ç¨‹å¯¹æŸä¸ªå…¨å±€å˜é‡åŠ é”è®¿é—®ï¼ŒBçº¿ç¨‹åœ¨è®¿é—®å‰å°è¯•åŠ é”ï¼Œæ‹¿ä¸åˆ°é”ï¼ŒBçº¿ç¨‹é˜»å¡ï¼ŒCçº¿ç¨‹ä¸å»åŠ é”ï¼Œè€Œç›´æ¥è®¿é—®è¯¥å…¨å±€å˜é‡ï¼Œä¾ç„¶èƒ½å¤Ÿè®¿é—®ï¼Œä½†ä¼šå‡ºç°æ•°æ®æ··ä¹±ã€‚
<br> âœ¦ æ‰€ä»¥ï¼Œäº’æ–¥é”å®è´¨ä¸Šæ˜¯æ“ä½œç³»ç»Ÿæä¾›çš„ä¸€æŠŠâ€œå»ºè®®é”â€ï¼ˆåˆç§°â€œååŒé”â€ï¼‰ï¼Œå»ºè®®ç¨‹åºä¸­æœ‰å¤šçº¿ç¨‹è®¿é—®å…±äº«èµ„æºçš„æ—¶å€™ä½¿ç”¨è¯¥æœºåˆ¶ï¼Œä½†æ˜¯æ²¡æœ‰å¼ºåˆ¶é™å®šã€‚
<br> âœ¦ å› æ­¤ï¼Œå³ä½¿æœ‰äº†mutexï¼Œå¦‚æœæœ‰çº¿ç¨‹ä¸æŒ‰è§„åˆ™æ¥è®¿é—®æ•°æ®ï¼Œä¾ç„¶ä¼šé€ æˆæ•°æ®æ··ä¹±ã€‚
<br>
<br><font color=black size = 5><a name="bc3">ä¸»è¦å‡½æ•°åŠåº”ç”¨</a></font>
<br> âœ¦ pthread_mutex_init() å‡½æ•°
<br> âœ¦ pthread_mutex_destroy() å‡½æ•°
<br> âœ¦ pthread_mutex_lock() å‡½æ•°
<br> âœ¦ pthread_mutex_trylock() å‡½æ•°
<br> âœ¦ pthread_mutex_unlock() å‡½æ•°
<br>  ä»¥ä¸Š5ä¸ªå‡½æ•°çš„è¿”å›å€¼éƒ½æ˜¯ï¼šæˆåŠŸè¿”å›0ï¼Œ å¤±è´¥è¿”å›é”™è¯¯å·ã€‚
<br> âœ¦ pthread_mutex_t ç±»å‹ï¼Œå…¶æœ¬è´¨æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œä¸ºç®€åŒ–ç†è§£ï¼Œåº”ç”¨æ—¶å¯å¿½ç•¥å…¶å®ç°ç»†èŠ‚ï¼Œç®€å•å½“æˆæ•´æ•°çœ‹å¾…ã€‚
<br> âœ¦ pthread_mutex_t mutex; å˜é‡mutexåªæœ‰ä¸¤ç§å–å€¼1ã€0ã€‚
<br> âœ§ pthread_mutex_init() å‡½æ•°
<br>&nbsp;&nbsp;&nbsp;&nbsp; åˆå§‹åŒ–ä¸€ä¸ªäº’æ–¥é”(äº’æ–¥é‡) â†’ åˆå€¼å¯çœ‹ä½œ1
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ğŸˆ int pthread_mutex_init(pthread_mutex_t *restrict mutex, const pthread_mutexattr_t *restrict attr);
<br>&nbsp;&nbsp;&nbsp;&nbsp; å‚æ•°1ï¼šä¼ å‡ºå‚æ•°ï¼Œè°ƒç”¨æ—¶åº”ä¼  &amp;mutex
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  æ³¨æ„ï¼šrestrictå…³é”®å­—ï¼šåªç”¨äºé™åˆ¶æŒ‡é’ˆï¼Œå‘Šè¯‰ç¼–è¯‘å™¨ï¼Œæ‰€æœ‰ä¿®æ”¹è¯¥æŒ‡é’ˆæŒ‡å‘å†…å­˜ä¸­å†…å®¹çš„æ“ä½œï¼Œåªèƒ½é€šè¿‡æœ¬æŒ‡é’ˆå®Œæˆï¼Œä¸èƒ½é€šè¿‡é™¤æœ¬æŒ‡é’ˆä»¥å¤–çš„å…¶ä»–å˜é‡æˆ–æŒ‡é’ˆä¿®æ”¹
<br>&nbsp;&nbsp;&nbsp;&nbsp; å‚æ•°2ï¼šäº’æ–¥é‡å±æ€§ã€‚æ˜¯ä¸€ä¸ªä¼ å…¥å‚æ•°ï¼Œé€šå¸¸ä¼ NULLï¼Œé€‰ç”¨é»˜è®¤å±æ€§(çº¿ç¨‹é—´å…±äº«)ã€‚ å‚ç…§APUE.12.4åŒæ­¥å±æ€§
<br>&nbsp;&nbsp;&nbsp;&nbsp; 0ã€é™æ€åˆå§‹åŒ–ï¼šå¦‚æœäº’æ–¥é” mutex æ˜¯é™æ€åˆ†é…çš„ï¼ˆå®šä¹‰åœ¨å…¨å±€ï¼Œæˆ–åŠ äº†staticå…³é”®å­—ä¿®é¥°ï¼‰ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨å®è¿›è¡Œåˆå§‹åŒ–ã€‚e.g.  pthead_mutex_t muetx = PTHREAD_MUTEX_INITIALIZER;
<br>&nbsp;&nbsp;&nbsp;&nbsp; 1ã€åŠ¨æ€åˆå§‹åŒ–ï¼šå±€éƒ¨å˜é‡åº”é‡‡ç”¨åŠ¨æ€åˆå§‹åŒ–ã€‚e.g.  pthread_mutex_init(&amp;mutex, NULL)
<br> âœ§ pthread_mutex_destroy() å‡½æ•°
<br>&nbsp;&nbsp;&nbsp;&nbsp; é”€æ¯ä¸€ä¸ªäº’æ–¥é”
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ğŸˆ int pthread_mutex_destroy(pthread_mutex_t *mutex);
<br> âœ§ pthread_mutex_lock() å‡½æ•°
<br>&nbsp;&nbsp;&nbsp;&nbsp; åŠ é”ï¼Œå¯ç†è§£ä¸ºå°†mutex--ï¼ˆæˆ–-1ï¼‰
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ğŸˆ int pthread_mutex_lock(pthread_mutex_t *mutex);
<br> âœ§ pthread_mutex_unlockå‡½æ•°
<br>&nbsp;&nbsp;&nbsp;&nbsp; è§£é”ï¼Œå¯ç†è§£ä¸ºå°†mutex ++ï¼ˆæˆ–+1ï¼‰
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ğŸˆ int pthread_mutex_unlock(pthread_mutex_t *mutex);
<br> âœ§ pthread_mutex_trylockå‡½æ•°
<br>&nbsp;&nbsp;&nbsp;&nbsp; å°è¯•åŠ é”
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ğŸˆ int pthread_mutex_trylock(pthread_mutex_t *mutex);
<br>  åŠ é”ä¸è§£é”
<br> âœ§ lockä¸unlockï¼š
<br>&nbsp;&nbsp;&nbsp;&nbsp; lockå°è¯•åŠ é”ï¼Œå¦‚æœåŠ é”ä¸æˆåŠŸï¼Œçº¿ç¨‹é˜»å¡ï¼Œé˜»å¡åˆ°æŒæœ‰è¯¥äº’æ–¥é‡çš„å…¶ä»–çº¿ç¨‹è§£é”ä¸ºæ­¢ã€‚
<br>&nbsp;&nbsp;&nbsp;&nbsp; unlockä¸»åŠ¨è§£é”å‡½æ•°ï¼ŒåŒæ—¶å°†é˜»å¡åœ¨è¯¥é”ä¸Šçš„æ‰€æœ‰çº¿ç¨‹å…¨éƒ¨å”¤é†’ï¼Œè‡³äºå“ªä¸ªçº¿ç¨‹å…ˆè¢«å”¤é†’ï¼Œå–å†³äºä¼˜å…ˆçº§ã€è°ƒåº¦ã€‚é»˜è®¤ï¼šå…ˆé˜»å¡ã€å…ˆå”¤é†’ã€‚
<br>&nbsp;&nbsp;&nbsp;&nbsp; ä¾‹å¦‚ï¼šT1 T2 T3 T4 ä½¿ç”¨ä¸€æŠŠmutexé”ã€‚T1åŠ é”æˆåŠŸï¼Œå…¶ä»–çº¿ç¨‹å‡é˜»å¡ï¼Œç›´è‡³T1è§£é”ã€‚T1è§£é”åï¼ŒT2 T3 T4å‡è¢«å”¤é†’ï¼Œå¹¶è‡ªåŠ¨å†æ¬¡å°è¯•åŠ é”ã€‚
<br>&nbsp;&nbsp;&nbsp;&nbsp; å¯å‡æƒ³mutexé” initæˆåŠŸåˆå€¼ä¸º1ã€lock åŠŸèƒ½æ˜¯å°†mutex--ã€unlockå°†mutex++
<br> âœ§ lockä¸trylockï¼š
<br>&nbsp;&nbsp;&nbsp;&nbsp;lockåŠ é”å¤±è´¥ä¼šé˜»å¡ï¼Œç­‰å¾…é”é‡Šæ”¾ã€‚
<br>&nbsp;&nbsp;&nbsp;&nbsp;trylockåŠ é”å¤±è´¥ç›´æ¥è¿”å›é”™è¯¯å·(å¦‚ï¼šEBUSY)ï¼Œä¸é˜»å¡ã€‚
<br>  åŠ é”æ­¥éª¤æµ‹è¯•ï¼š
<br>&nbsp;&nbsp;&nbsp;&nbsp; ç¨‹åºï¼šè¯¥ç¨‹åºæ˜¯éå¸¸å…¸å‹çš„ï¼Œç”±äºå…±äº«ã€ç«äº‰è€Œæ²¡æœ‰åŠ ä»»ä½•åŒæ­¥æœºåˆ¶ï¼Œå¯¼è‡´äº§ç”Ÿäºæ—¶é—´æœ‰å…³çš„é”™è¯¯ï¼Œé€ æˆæ•°æ®æ··ä¹±ã€‚
<br> ğŸ‘¦ ç¼–ç¨‹å®æˆ˜ï¼šåŠ é”å‰é€ æˆçš„æ•°æ®æ··ä¹±
<br><div style="width:100%;border:1px #e3e3e3 solid;"><div style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;border-bottom:1px solid #e3e3e3;margin-top:5px;color:#000000;">&nbsp;C++ Code&nbsp;</div><table style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;vertical-align:text-top;line-height:15px;" border="0" cellspacing="0" cellpadding="0"><tr><td style="color:#008284;background-color:#e3e3e3;vertical-align:text-top;"><div style="margin:7px;text-align:right;white-space:nowrap;"><nobr>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br></nobr></div></td><td style="background-color:#008284;padding:1px;"><div style="border:1px #008284 solid;"></div></td><td style="background-color:#efefef;width:100%;vertical-align:text-top;color:#000000;"><div style="margin:7px;"><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;stdio.h&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;pthread.h&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;unistd.h&gt;<BR>
<BR>
</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;*tfn(</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;*arg)<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;srand(time(</span><span style="color:#0000ff;">NULL</span><span style="color:#000000;">));<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">while</span><span style="color:#000000;">&nbsp;(</span><span style="color:#ff0000;">1</span><span style="color:#000000;">)&nbsp;{<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(</span><span style="color:#800000;">&quot;hello&nbsp;&quot;</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//æ¨¡æ‹Ÿé•¿æ—¶é—´æ“ä½œå…±äº«èµ„æºï¼Œå¯¼è‡´cpuæ˜“ä¸»ï¼Œäº§ç”Ÿä¸æ—¶é—´æœ‰å…³çš„é”™è¯¯<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sleep(rand()&nbsp;%&nbsp;</span><span style="color:#ff0000;">3</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(</span><span style="color:#800000;">&quot;world\n&quot;</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sleep(rand()&nbsp;%&nbsp;</span><span style="color:#ff0000;">3</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;</span><span style="color:#0000ff;">NULL</span><span style="color:#000000;">;<BR>
}<BR>
</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;main(</span><span style="color:#8000ff;">void</span><span style="color:#000000;">)<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;pthread_t&nbsp;tid;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;srand(time(</span><span style="color:#0000ff;">NULL</span><span style="color:#000000;">));<BR>
&nbsp;&nbsp;&nbsp;&nbsp;pthread_create(&amp;tid,&nbsp;</span><span style="color:#0000ff;">NULL</span><span style="color:#000000;">,&nbsp;tfn,&nbsp;</span><span style="color:#0000ff;">NULL</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">while</span><span style="color:#000000;">&nbsp;(</span><span style="color:#ff0000;">1</span><span style="color:#000000;">)&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(</span><span style="color:#800000;">&quot;HELLO&nbsp;&quot;</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sleep(rand()&nbsp;%&nbsp;</span><span style="color:#ff0000;">3</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(</span><span style="color:#800000;">&quot;WORLD\n&quot;</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sleep(rand()&nbsp;%&nbsp;</span><span style="color:#ff0000;">3</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;pthread_join(tid,&nbsp;</span><span style="color:#0000ff;">NULL</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;<BR>
}</span></div></td></tr></table></div>
<br> ğŸ‘¦ ç¼–ç¨‹å®æˆ˜ï¼šåŠ é”åä¸ä¼šé€ æˆæ•°æ®æ··ä¹±
<br><div style="width:100%;border:1px #e3e3e3 solid;"><div style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;border-bottom:1px solid #e3e3e3;margin-top:5px;color:#000000;">&nbsp;C++ Code&nbsp;</div><table style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;vertical-align:text-top;line-height:15px;" border="0" cellspacing="0" cellpadding="0"><tr><td style="color:#008284;background-color:#e3e3e3;vertical-align:text-top;"><div style="margin:7px;text-align:right;white-space:nowrap;"><nobr>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44<br></nobr></div></td><td style="background-color:#008284;padding:1px;"><div style="border:1px #008284 solid;"></div></td><td style="background-color:#efefef;width:100%;vertical-align:text-top;color:#000000;"><div style="margin:7px;"><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;stdio.h&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;pthread.h&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;unistd.h&gt;<BR>
<BR>
pthread_mutex_t&nbsp;mutex;<BR>
<BR>
</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;*tfn(</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;*arg)<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;srand(time(</span><span style="color:#0000ff;">NULL</span><span style="color:#000000;">));<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">while</span><span style="color:#000000;">&nbsp;(</span><span style="color:#ff0000;">1</span><span style="color:#000000;">)&nbsp;{<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pthread_mutex_lock(&amp;mutex);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(</span><span style="color:#800000;">&quot;hello&nbsp;&quot;</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">/*æ¨¡æ‹Ÿé•¿æ—¶é—´æ“ä½œå…±äº«èµ„æºï¼Œå¯¼è‡´cpuæ˜“ä¸»ï¼Œäº§ç”Ÿä¸æ—¶é—´æœ‰å…³çš„é”™è¯¯*/</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sleep(rand()&nbsp;%&nbsp;</span><span style="color:#ff0000;">3</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(</span><span style="color:#800000;">&quot;world\n&quot;</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pthread_mutex_unlock(&amp;mutex);<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sleep(rand()&nbsp;%&nbsp;</span><span style="color:#ff0000;">3</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;</span><span style="color:#0000ff;">NULL</span><span style="color:#000000;">;<BR>
}<BR>
</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;main(</span><span style="color:#8000ff;">void</span><span style="color:#000000;">)<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;pthread_t&nbsp;tid;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;pthread_mutex_init(&amp;mutex,&nbsp;</span><span style="color:#0000ff;">NULL</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;srand(time(</span><span style="color:#0000ff;">NULL</span><span style="color:#000000;">));<BR>
&nbsp;&nbsp;&nbsp;&nbsp;pthread_create(&amp;tid,&nbsp;</span><span style="color:#0000ff;">NULL</span><span style="color:#000000;">,&nbsp;tfn,&nbsp;</span><span style="color:#0000ff;">NULL</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">while</span><span style="color:#000000;">&nbsp;(</span><span style="color:#ff0000;">1</span><span style="color:#000000;">)&nbsp;{<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pthread_mutex_lock(&amp;mutex);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(</span><span style="color:#800000;">&quot;HELLO&nbsp;&quot;</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sleep(rand()&nbsp;%&nbsp;</span><span style="color:#ff0000;">3</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(</span><span style="color:#800000;">&quot;WORLD\n&quot;</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pthread_mutex_unlock(&amp;mutex);<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sleep(rand()&nbsp;%&nbsp;</span><span style="color:#ff0000;">3</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;pthread_cancel(tid);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;pthread_join(tid,&nbsp;</span><span style="color:#0000ff;">NULL</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;pthread_mutex_destroy(&amp;mutex);<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;<BR>
}</span></div></td></tr></table></div>
<br> ğŸ‘¦ åœ¨è®¿é—®å…±äº«èµ„æºå‰åŠ é”ï¼Œè®¿é—®ç»“æŸåç«‹å³è§£é”ã€é”çš„â€œç²’åº¦â€åº”è¶Šå°è¶Šå¥½ã€‚
<br>
<br><font color=black size = 5><a name="bc5">æ­»é”å®ç°</a></font>
<br> âœ¦ 0ã€çº¿ç¨‹è¯•å›¾å¯¹åŒä¸€ä¸ªäº’æ–¥é‡AåŠ é”ä¸¤æ¬¡ã€‚
<br> âœ¦ 1ã€çº¿ç¨‹1æ‹¥æœ‰Aé”ï¼Œè¯·æ±‚è·å¾—Bé”ï¼›çº¿ç¨‹2æ‹¥æœ‰Bé”ï¼Œè¯·æ±‚è·å¾—Aé”
<br> ğŸ‘¦ ç¼–ç¨‹å®æˆ˜0ï¼šå®ç°ä¸Šè¿°ç¬¬ä¸€ç§æƒ…å†µ
<br><div style="width:100%;border:1px #e3e3e3 solid;"><div style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;border-bottom:1px solid #e3e3e3;margin-top:5px;color:#000000;">&nbsp;C++ Code&nbsp;</div><table style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;vertical-align:text-top;line-height:15px;" border="0" cellspacing="0" cellpadding="0"><tr><td style="color:#008284;background-color:#e3e3e3;vertical-align:text-top;"><div style="margin:7px;text-align:right;white-space:nowrap;"><nobr>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44<br>45<br>46<br>47<br>48<br>49<br>50<br>51<br>52<br>53<br>54<br>55<br>56<br>57<br>58<br>59<br>60<br>61<br>62<br>63<br>64<br>65<br>66<br>67<br>68<br>69<br>70<br>71<br>72<br>73<br>74<br>75<br>76<br>77<br>78<br>79<br></nobr></div></td><td style="background-color:#008284;padding:1px;"><div style="border:1px #008284 solid;"></div></td><td style="background-color:#efefef;width:100%;vertical-align:text-top;color:#000000;"><div style="margin:7px;"><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;iostream&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;stdlib.h&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;pthread.h&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;unistd.h&gt;<BR>
</span><span style="color:#0000ff;">using</span><span style="color:#000000;">&nbsp;</span><span style="color:#0000ff;">namespace</span><span style="color:#000000;">&nbsp;std;<BR>
<BR>
pthread_mutex_t&nbsp;mutex;<BR>
<BR>
</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;*deadLockfun(</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;*arg)<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;ret;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;srand(time(</span><span style="color:#0000ff;">NULL</span><span style="color:#000000;">));<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;This&nbsp;is&nbsp;first&nbsp;lock...&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;pthread_mutex_lock(&amp;mutex);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;ç¬¬ä¸€æ¬¡åŠ é”<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(ret&nbsp;==&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;The&nbsp;first&nbsp;lock&nbsp;success!&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">else</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;The&nbsp;first&nbsp;lock&nbsp;failed!&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(</span><span style="color:#ff0000;">1</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;Now,&nbsp;I&nbsp;try&nbsp;second&nbsp;lock&nbsp;this&nbsp;program...&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;pthread_mutex_lock(&amp;mutex);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(ret&nbsp;==&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;The&nbsp;second&nbsp;lock&nbsp;success!&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">else</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;The&nbsp;second&nbsp;lock&nbsp;failed!&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(</span><span style="color:#ff0000;">1</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;hello&nbsp;&quot;</span><span style="color:#000000;">;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sleep(rand()%</span><span style="color:#ff0000;">2</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;world!&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;pthread_mutex_unlock(&amp;mutex);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(ret&nbsp;==&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;Unlock&nbsp;success!&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">else</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;Unlock&nbsp;failed!&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(</span><span style="color:#ff0000;">1</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
}<BR>
<BR>
</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;main()<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;ret;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pthread_t&nbsp;tid;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;pthread_mutex_init(&amp;mutex,&nbsp;</span><span style="color:#0000ff;">NULL</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(</span><span style="color:#ff0000;">0</span><span style="color:#000000;">&nbsp;==&nbsp;ret)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;Lock&nbsp;init&nbsp;success!&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">else</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;Lock&nbsp;init&nbsp;failed!&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(</span><span style="color:#ff0000;">1</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pthread_create(&amp;tid,&nbsp;</span><span style="color:#0000ff;">NULL</span><span style="color:#000000;">,&nbsp;deadLockfun,&nbsp;</span><span style="color:#0000ff;">NULL</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sleep(</span><span style="color:#ff0000;">2</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">/*ret&nbsp;=&nbsp;pthread_mutex_destroy(&amp;mutex);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(0&nbsp;==&nbsp;ret)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;&quot;Lock&nbsp;destroy&nbsp;success!&quot;&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;&quot;Lock&nbsp;destroy&nbsp;failed!&quot;&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(1);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}*/</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">while</span><span style="color:#000000;">(</span><span style="color:#ff0000;">1</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;<BR>
}</span></div></td></tr></table></div>
<br> ğŸ‘¦ ç¼–ç¨‹å®æˆ˜1ï¼šå®ç°ä¸Šè¿°ç¬¬äºŒç§æƒ…å†µ
<br><div style="width:100%;border:1px #e3e3e3 solid;"><div style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;border-bottom:1px solid #e3e3e3;margin-top:5px;color:#000000;">&nbsp;C++ Code&nbsp;</div><table style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;vertical-align:text-top;line-height:15px;" border="0" cellspacing="0" cellpadding="0"><tr><td style="color:#008284;background-color:#e3e3e3;vertical-align:text-top;"><div style="margin:7px;text-align:right;white-space:nowrap;"><nobr>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44<br>45<br>46<br>47<br>48<br>49<br>50<br>51<br>52<br>53<br>54<br>55<br>56<br>57<br>58<br>59<br>60<br>61<br>62<br>63<br>64<br>65<br>66<br>67<br>68<br>69<br>70<br>71<br>72<br>73<br>74<br>75<br>76<br>77<br>78<br>79<br>80<br>81<br>82<br>83<br>84<br>85<br>86<br>87<br>88<br>89<br>90<br>91<br>92<br>93<br>94<br>95<br>96<br>97<br>98<br>99<br>100<br>101<br>102<br>103<br>104<br>105<br>106<br>107<br>108<br>109<br>110<br>111<br>112<br>113<br>114<br>115<br>116<br>117<br></nobr></div></td><td style="background-color:#008284;padding:1px;"><div style="border:1px #008284 solid;"></div></td><td style="background-color:#efefef;width:100%;vertical-align:text-top;color:#000000;"><div style="margin:7px;"><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;iostream&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;stdlib.h&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;pthread.h&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;unistd.h&gt;<BR>
</span><span style="color:#0000ff;">using</span><span style="color:#000000;">&nbsp;</span><span style="color:#0000ff;">namespace</span><span style="color:#000000;">&nbsp;std;<BR>
<BR>
pthread_mutex_t&nbsp;mutex0;<BR>
pthread_mutex_t&nbsp;mutex1;<BR>
<BR>
</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;*deadLockfun0(</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;*arg)<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;ret;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;srand(time(</span><span style="color:#0000ff;">NULL</span><span style="color:#000000;">));<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;I'm&nbsp;child&nbsp;pthread0...&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;pthread_mutex_lock(&amp;mutex0);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(ret&nbsp;==&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;The&nbsp;lock0&nbsp;success!&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">else</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;The&nbsp;lock0&nbsp;failed!&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(</span><span style="color:#ff0000;">1</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;Now,&nbsp;I&nbsp;try&nbsp;request&nbsp;lock1&nbsp;this&nbsp;program...&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sleep(</span><span style="color:#ff0000;">2</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;pthread_mutex_lock(&amp;mutex1);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(ret&nbsp;==&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;The&nbsp;lock1&nbsp;success!&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">else</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;The&nbsp;lock1&nbsp;failed!&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(</span><span style="color:#ff0000;">1</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
}<BR>
<BR>
</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;*deadLockfun1(</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;*arg)<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;ret;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;srand(time(</span><span style="color:#0000ff;">NULL</span><span style="color:#000000;">));<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;I'm&nbsp;child&nbsp;pthread1...&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;pthread_mutex_lock(&amp;mutex1);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(ret&nbsp;==&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;The&nbsp;lock1&nbsp;success!&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">else</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;The&nbsp;lock1&nbsp;failed!&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(</span><span style="color:#ff0000;">1</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;Now,&nbsp;I&nbsp;try&nbsp;request&nbsp;lock0&nbsp;this&nbsp;program...&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sleep(</span><span style="color:#ff0000;">2</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;pthread_mutex_lock(&amp;mutex0);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(ret&nbsp;==&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;The&nbsp;lock0&nbsp;success!&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">else</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;The&nbsp;lock0&nbsp;failed!&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(</span><span style="color:#ff0000;">1</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
}<BR>
<BR>
</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;main()<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;ret;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pthread_t&nbsp;tid;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;pthread_mutex_init(&amp;mutex0,&nbsp;</span><span style="color:#0000ff;">NULL</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(</span><span style="color:#ff0000;">0</span><span style="color:#000000;">&nbsp;==&nbsp;ret)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;Lock0&nbsp;init&nbsp;success!&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">else</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;Lock0&nbsp;init&nbsp;failed!&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(</span><span style="color:#ff0000;">1</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;pthread_mutex_init(&amp;mutex1,&nbsp;</span><span style="color:#0000ff;">NULL</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(</span><span style="color:#ff0000;">0</span><span style="color:#000000;">&nbsp;==&nbsp;ret)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;Lock1&nbsp;init&nbsp;success!&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">else</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;Lock1&nbsp;init&nbsp;failed!&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(</span><span style="color:#ff0000;">1</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pthread_create(&amp;tid,&nbsp;</span><span style="color:#0000ff;">NULL</span><span style="color:#000000;">,&nbsp;deadLockfun0,&nbsp;</span><span style="color:#0000ff;">NULL</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pthread_create(&amp;tid,&nbsp;</span><span style="color:#0000ff;">NULL</span><span style="color:#000000;">,&nbsp;deadLockfun1,&nbsp;</span><span style="color:#0000ff;">NULL</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sleep(</span><span style="color:#ff0000;">2</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">/*ret&nbsp;=&nbsp;pthread_mutex_destroy(&amp;mutex0);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(0&nbsp;==&nbsp;ret)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;&quot;Lock&nbsp;destroy&nbsp;success!&quot;&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;&quot;Lock&nbsp;destroy&nbsp;failed!&quot;&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(1);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;pthread_mutex_destroy(&amp;mutex1);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(0&nbsp;==&nbsp;ret)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;&quot;Lock&nbsp;destroy&nbsp;success!&quot;&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;&quot;Lock&nbsp;destroy&nbsp;failed!&quot;&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(1);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}*/</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">while</span><span style="color:#000000;">(</span><span style="color:#ff0000;">1</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;<BR>
}</span></div></td></tr></table></div>
<br>
<br><font color=black size = 5><a name="bc6">è¯»å†™é”æ¦‚è¿°</a></font>
<br> âœ¦ ä¸äº’æ–¥é‡ç±»ä¼¼ï¼Œä½†è¯»å†™é”å…è®¸æ›´é«˜çš„å¹¶è¡Œæ€§ã€‚å…¶ç‰¹æ€§ä¸ºï¼šå†™ç‹¬å ï¼Œè¯»å…±äº«ã€‚
<br>
<br><font color=black size = 5><a name="bc7">è¯»å†™é”çŠ¶æ€</a></font>
<br> âœ¦ ä¸€æŠŠè¯»å†™é”å…·å¤‡ä¸‰ç§çŠ¶æ€ï¼š
<br>&nbsp;&nbsp;&nbsp;&nbsp; 0ã€è¯»æ¨¡å¼ä¸‹åŠ é”çŠ¶æ€ (è¯»é”)
<br>&nbsp;&nbsp;&nbsp;&nbsp; 1ã€å†™æ¨¡å¼ä¸‹åŠ é”çŠ¶æ€ (å†™é”)
<br>&nbsp;&nbsp;&nbsp;&nbsp; 2ã€ä¸åŠ é”çŠ¶æ€
<br>
<br><font color=black size = 5><a name="bc7">è¯»å†™é”ç‰¹æ€§</a></font>
<br>  0ã€è¯»å†™é”æ˜¯â€œå†™æ¨¡å¼åŠ é”â€æ—¶ï¼Œ è§£é”å‰ï¼Œæ‰€æœ‰å¯¹è¯¥é”åŠ é”çš„çº¿ç¨‹éƒ½ä¼šè¢«é˜»å¡ã€‚
<br>  1ã€è¯»å†™é”æ˜¯â€œè¯»æ¨¡å¼åŠ é”â€æ—¶ï¼Œ å¦‚æœçº¿ç¨‹ä»¥è¯»æ¨¡å¼å¯¹å…¶åŠ é”ä¼šæˆåŠŸï¼›å¦‚æœçº¿ç¨‹ä»¥å†™æ¨¡å¼åŠ é”ä¼šé˜»å¡ã€‚
<br>  2ã€è¯»å†™é”æ˜¯â€œè¯»æ¨¡å¼åŠ é”â€æ—¶ï¼Œ æ—¢æœ‰è¯•å›¾ä»¥å†™æ¨¡å¼åŠ é”çš„çº¿ç¨‹ï¼Œä¹Ÿæœ‰è¯•å›¾ä»¥è¯»æ¨¡å¼åŠ é”çš„çº¿ç¨‹ã€‚é‚£ä¹ˆè¯»å†™é”ä¼šé˜»å¡éšåçš„è¯»æ¨¡å¼é”è¯·æ±‚ã€‚ä¼˜å…ˆæ»¡è¶³å†™æ¨¡å¼é”ã€‚è¯»é”ã€å†™é”å¹¶è¡Œé˜»å¡ï¼Œå†™é”ä¼˜å…ˆçº§é«˜
<br> âœ¦ è¯»å†™é”ä¹Ÿå«å…±äº«-ç‹¬å é”ã€‚å½“è¯»å†™é”ä»¥è¯»æ¨¡å¼é”ä½æ—¶ï¼Œå®ƒæ˜¯ä»¥å…±äº«æ¨¡å¼é”ä½çš„ï¼›å½“å®ƒä»¥å†™æ¨¡å¼é”ä½æ—¶ï¼Œå®ƒæ˜¯ä»¥ç‹¬å æ¨¡å¼é”ä½çš„ã€‚å†™ç‹¬å ã€è¯»å…±äº«ã€‚
<br> âœ¦ è¯»å†™é”éå¸¸é€‚åˆäºå¯¹æ•°æ®ç»“æ„è¯»çš„æ¬¡æ•°è¿œå¤§äºå†™çš„æƒ…å†µã€‚
<br>
<br><font color=black size = 5><a name="bc8">ä¸»è¦å‡½æ•°åŠåº”ç”¨</a></font>
<br> âœ¦ pthread_rwlock_init() å‡½æ•°
<br> âœ¦ pthread_rwlock_destroy() å‡½æ•°
<br> âœ¦ pthread_rwlock_rdlock() å‡½æ•°
<br> âœ¦ pthread_rwlock_wrlock() å‡½æ•°
<br> âœ¦ pthread_rwlock_tryrdlock() å‡½æ•°
<br> âœ¦ pthread_rwlock_trywrlock() å‡½æ•°
<br> âœ¦ pthread_rwlock_unlock() å‡½æ•°
<br>  ä»¥ä¸Š7 ä¸ªå‡½æ•°çš„è¿”å›å€¼éƒ½æ˜¯ï¼šæˆåŠŸè¿”å›0ï¼Œ å¤±è´¥ç›´æ¥è¿”å›é”™è¯¯å·ã€‚
<br> âœ¦ pthread_rwlock_tç±»å‹ ç”¨äºå®šä¹‰ä¸€ä¸ªè¯»å†™é”å˜é‡ã€‚
<br> âœ¦ pthread_rwlock_t rwlock;
<br> âœ§ pthread_rwlock_init() å‡½æ•°
<br>&nbsp;&nbsp;&nbsp;&nbsp; åˆå§‹åŒ–ä¸€æŠŠè¯»å†™é”
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ğŸˆ int pthread_rwlock_init(pthread_rwlock_t *restrict rwlock, const pthread_rwlockattr_t *restrict attr);
<br>&nbsp;&nbsp;&nbsp;&nbsp; å‚æ•°2ï¼šattrè¡¨è¯»å†™é”å±æ€§ï¼Œé€šå¸¸ä½¿ç”¨é»˜è®¤å±æ€§ï¼Œä¼ NULLå³å¯ã€‚
<br> âœ§ pthread_rwlock_destroy() å‡½æ•°
<br>&nbsp;&nbsp;&nbsp;&nbsp; é”€æ¯ä¸€æŠŠè¯»å†™é”
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ğŸˆ int pthread_rwlock_destroy(pthread_rwlock_t *rwlock);
<br> âœ§ pthread_rwlock_rdlock() å‡½æ•°
<br>&nbsp;&nbsp;&nbsp;&nbsp; ä»¥è¯»æ–¹å¼è¯·æ±‚è¯»å†™é”ã€‚ï¼ˆå¸¸ç®€ç§°ä¸ºï¼šè¯·æ±‚è¯»é”ï¼‰
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ğŸˆ int pthread_rwlock_rdlock(pthread_rwlock_t *rwlock);
<br> âœ§ pthread_rwlock_wrlock() å‡½æ•°
<br>&nbsp;&nbsp;&nbsp;&nbsp; ä»¥å†™æ–¹å¼è¯·æ±‚è¯»å†™é”ã€‚ï¼ˆå¸¸ç®€ç§°ä¸ºï¼šè¯·æ±‚å†™é”ï¼‰
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ğŸˆ int pthread_rwlock_wrlock(pthread_rwlock_t *rwlock);
<br> âœ§ pthread_rwlock_unlock() å‡½æ•°
<br>&nbsp;&nbsp;&nbsp;&nbsp; è§£é”
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ğŸˆ int pthread_rwlock_unlock(pthread_rwlock_t *rwlock);
<br> âœ§ pthread_rwlock_tryrdlock() å‡½æ•°
<br>&nbsp;&nbsp;&nbsp;&nbsp; éé˜»å¡ä»¥è¯»æ–¹å¼è¯·æ±‚è¯»å†™é”ï¼ˆéé˜»å¡è¯·æ±‚è¯»é”ï¼‰
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ğŸˆ int pthread_rwlock_tryrdlock(pthread_rwlock_t *rwlock);
<br> âœ§ pthread_rwlock_trywrlock() å‡½æ•°
<br>&nbsp;&nbsp;&nbsp;&nbsp; éé˜»å¡ä»¥å†™æ–¹å¼è¯·æ±‚è¯»å†™é”ï¼ˆéé˜»å¡è¯·æ±‚å†™é”ï¼‰
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ğŸˆ int pthread_rwlock_trywrlock(pthread_rwlock_t *rwlock);
<br> ğŸ‘¦ ç¼–ç¨‹å®æˆ˜ï¼šè¯»å†™é”ç¤ºä¾‹ï¼ŒåŒæ—¶æœ‰å¤šä¸ªçº¿ç¨‹å¯¹åŒä¸€å…¨å±€æ•°æ®è¯»ã€å†™æ“ä½œã€‚
<br><div style="width:100%;border:1px #e3e3e3 solid;"><div style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;border-bottom:1px solid #e3e3e3;margin-top:5px;color:#000000;">&nbsp;C++ Code&nbsp;</div><table style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;vertical-align:text-top;line-height:15px;" border="0" cellspacing="0" cellpadding="0"><tr><td style="color:#008284;background-color:#e3e3e3;vertical-align:text-top;"><div style="margin:7px;text-align:right;white-space:nowrap;"><nobr>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44<br>45<br>46<br>47<br>48<br>49<br>50<br></nobr></div></td><td style="background-color:#008284;padding:1px;"><div style="border:1px #008284 solid;"></div></td><td style="background-color:#efefef;width:100%;vertical-align:text-top;color:#000000;"><div style="margin:7px;"><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;stdio.h&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;unistd.h&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;pthread.h&gt;<BR>
<BR>
</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;counter;<BR>
pthread_rwlock_t&nbsp;rwlock;<BR>
<BR>
</span><span style="color:#008000;">/*&nbsp;3ä¸ªçº¿ç¨‹ä¸å®šæ—¶å†™åŒä¸€å…¨å±€èµ„æºï¼Œ5ä¸ªçº¿ç¨‹ä¸å®šæ—¶è¯»åŒä¸€å…¨å±€èµ„æº&nbsp;*/</span><span style="color:#000000;"><BR>
</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;*th_write(</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;*arg)<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;t,&nbsp;i&nbsp;=&nbsp;(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">)arg;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">while</span><span style="color:#000000;">&nbsp;(</span><span style="color:#ff0000;">1</span><span style="color:#000000;">)&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pthread_rwlock_wrlock(&amp;rwlock);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t&nbsp;=&nbsp;counter;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;usleep(</span><span style="color:#ff0000;">1000</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(</span><span style="color:#800000;">&quot;---write&nbsp;%d:&nbsp;%lu:&nbsp;counter=%d&nbsp;++counter=%d\n&quot;</span><span style="color:#000000;">,<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i,&nbsp;pthread_self(),&nbsp;t,&nbsp;++counter);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pthread_rwlock_unlock(&amp;rwlock);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;usleep(</span><span style="color:#ff0000;">10000</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;</span><span style="color:#0000ff;">NULL</span><span style="color:#000000;">;<BR>
}<BR>
</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;*th_read(</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;*arg)<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;i&nbsp;=&nbsp;(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">)arg;<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">while</span><span style="color:#000000;">&nbsp;(</span><span style="color:#ff0000;">1</span><span style="color:#000000;">)&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pthread_rwlock_rdlock(&amp;rwlock);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(</span><span style="color:#800000;">&quot;---read&nbsp;%d:&nbsp;%lu:&nbsp;%d\n&quot;</span><span style="color:#000000;">,&nbsp;i,&nbsp;pthread_self(),&nbsp;counter);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pthread_rwlock_unlock(&amp;rwlock);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;usleep(</span><span style="color:#ff0000;">2000</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;</span><span style="color:#0000ff;">NULL</span><span style="color:#000000;">;<BR>
}<BR>
</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;main(</span><span style="color:#8000ff;">void</span><span style="color:#000000;">)<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;i;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;pthread_t&nbsp;tid[</span><span style="color:#ff0000;">8</span><span style="color:#000000;">];<BR>
&nbsp;&nbsp;&nbsp;&nbsp;pthread_rwlock_init(&amp;rwlock,&nbsp;</span><span style="color:#0000ff;">NULL</span><span style="color:#000000;">);<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">for</span><span style="color:#000000;">&nbsp;(i&nbsp;=&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;&nbsp;i&nbsp;&lt;&nbsp;</span><span style="color:#ff0000;">3</span><span style="color:#000000;">;&nbsp;i++)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pthread_create(&amp;tid[i],&nbsp;</span><span style="color:#0000ff;">NULL</span><span style="color:#000000;">,&nbsp;th_write,&nbsp;(</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;*)i);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">for</span><span style="color:#000000;">&nbsp;(i&nbsp;=&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;&nbsp;i&nbsp;&lt;&nbsp;</span><span style="color:#ff0000;">5</span><span style="color:#000000;">;&nbsp;i++)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pthread_create(&amp;tid[i+</span><span style="color:#ff0000;">3</span><span style="color:#000000;">],&nbsp;</span><span style="color:#0000ff;">NULL</span><span style="color:#000000;">,&nbsp;th_read,&nbsp;(</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;*)i);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">for</span><span style="color:#000000;">&nbsp;(i&nbsp;=&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;&nbsp;i&nbsp;&lt;&nbsp;</span><span style="color:#ff0000;">8</span><span style="color:#000000;">;&nbsp;i++)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pthread_join(tid[i],&nbsp;</span><span style="color:#0000ff;">NULL</span><span style="color:#000000;">);<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;pthread_rwlock_destroy(&amp;rwlock);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;<BR>
}</span></div></td></tr></table></div>
<br>
<br><font color=black size = 5><a name="bc9">æ¡ä»¶å˜é‡æ¦‚è¿°</a></font>
<br> âœ¦ æ¡ä»¶å˜é‡æœ¬èº«ä¸æ˜¯é”ï¼Œä½†æ˜¯å®ƒä¹Ÿå¯ä»¥é€ æˆçº¿ç¨‹é˜»å¡ï¼Œé€šå¸¸ä¸äº’æ–¥é”é…åˆä½¿ç”¨ï¼Œç»™å¤šçº¿ç¨‹æä¾›ä¸€ä¸ªä¼šåˆçš„åœºæ‰€ã€‚
<br>
<br><font color=black size = 5><a name="bc10">ä¸»è¦å‡½æ•°åŠåº”ç”¨</a></font>
<br> âœ¦ pthread_cond_init() å‡½æ•°
<br> âœ¦ pthread_cond_destroy() å‡½æ•°
<br> âœ¦ pthread_cond_wait() å‡½æ•°
<br> âœ¦ pthread_cond_timedwait() å‡½æ•°
<br> âœ¦ pthread_cond_signal() å‡½æ•°
<br> âœ¦ pthread_cond_broadcast() å‡½æ•°
<br>  ä»¥ä¸Š6 ä¸ªå‡½æ•°çš„è¿”å›å€¼éƒ½æ˜¯ï¼šæˆåŠŸè¿”å›0ï¼Œ å¤±è´¥ç›´æ¥è¿”å›é”™è¯¯å·ã€‚
<br> âœ¦ pthread_cond_t ç±»å‹ï¼Œç”¨äºå®šä¹‰æ¡ä»¶å˜é‡
<br> âœ¦ pthread_cond_t cond;
<br> âœ§ pthread_cond_init() å‡½æ•°
<br>&nbsp;&nbsp;&nbsp;&nbsp; åˆå§‹åŒ–ä¸€ä¸ªæ¡ä»¶å˜é‡
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ğŸˆ int pthread_cond_init(pthread_cond_t *restrict cond, const pthread_condattr_t *restrict attr);
<br>&nbsp;&nbsp;&nbsp;&nbsp; å‚æ•°2ï¼šattrè¡¨æ¡ä»¶å˜é‡å±æ€§ï¼Œé€šå¸¸ä¸ºé»˜è®¤å€¼ï¼Œä¼ NULLå³å¯
<br>&nbsp;&nbsp;&nbsp;&nbsp; ä¹Ÿå¯ä»¥ä½¿ç”¨é™æ€åˆå§‹åŒ–çš„æ–¹æ³•ï¼Œåˆå§‹åŒ–æ¡ä»¶å˜é‡ï¼š
<br>&nbsp;&nbsp;&nbsp;&nbsp; pthread_cond_t cond = PTHREAD_COND_INITIALIZER;
<br> âœ§ pthread_cond_destroy() å‡½æ•°
<br>&nbsp;&nbsp;&nbsp;&nbsp; é”€æ¯ä¸€ä¸ªæ¡ä»¶å˜é‡
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ğŸˆ int pthread_cond_destroy(pthread_cond_t *cond);
<br> âœ§ pthread_cond_wait() å‡½æ•°
<br>&nbsp;&nbsp;&nbsp;&nbsp; é˜»å¡ç­‰å¾…ä¸€ä¸ªæ¡ä»¶å˜é‡
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ğŸˆ int pthread_cond_wait(pthread_cond_t *restrict cond, pthread_mutex_t *restrict mutex);
<br>&nbsp;&nbsp;&nbsp; å‡½æ•°ä½œç”¨ï¼š
<br>&nbsp;&nbsp;&nbsp;&nbsp; 0ã€é˜»å¡ç­‰å¾…æ¡ä»¶å˜é‡cond(å‚æ•°1)æ»¡è¶³
<br>&nbsp;&nbsp;&nbsp;&nbsp; 1ã€é‡Šæ”¾å·²æŒæ¡çš„äº’æ–¥é” (è§£é”äº’æ–¥é‡) ç›¸å½“äºpthread_mutex_unlock(&amp;mutex);
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0å’Œ1 ä¸¤æ­¥ä¸ºä¸€ä¸ªåŸå­æ“ä½œã€‚
<br>&nbsp;&nbsp;&nbsp;&nbsp; 2ã€å½“è¢«å”¤é†’ï¼Œpthread_cond_wait() å‡½æ•°è¿”å›æ—¶ï¼Œè§£é™¤é˜»å¡å¹¶é‡æ–°ç”³è¯·è·å–äº’æ–¥é”pthread_mutex_lock(&amp;mutex);
<br> âœ§ pthread_cond_timedwait() å‡½æ•°
<br>&nbsp;&nbsp;&nbsp;&nbsp; é™æ—¶ç­‰å¾…ä¸€ä¸ªæ¡ä»¶å˜é‡
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ğŸˆ int pthread_cond_timedwait(pthread_cond_t *restrict cond, pthread_mutex_t *restrict mutex, const struct timespec *restrict abstime);
<br>&nbsp;&nbsp;&nbsp;&nbsp; å‚æ•°3ï¼šå‚çœ‹man sem_timedwaitå‡½æ•°ï¼ŒæŸ¥çœ‹struct timespecç»“æ„ä½“ã€‚
<br>&nbsp;&nbsp;&nbsp;&nbsp; struct timespec {
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; time_t tv_sec;       /* seconds */ ç§’
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; long   tv_nsec;   /* nanosecondes*/ çº³ç§’
<br>&nbsp;&nbsp;&nbsp;&nbsp; }
<br>&nbsp;&nbsp;&nbsp;&nbsp; å½¢å‚abstimeï¼šç»å¯¹æ—¶é—´ã€‚<br>&nbsp;&nbsp;&nbsp;&nbsp; å¦‚ï¼štime(NULL)è¿”å›çš„å°±æ˜¯ç»å¯¹æ—¶é—´ã€‚è€Œalarm(1)æ˜¯ç›¸å¯¹æ—¶é—´ï¼Œç›¸å¯¹å½“å‰æ—¶é—´å®šæ—¶1ç§’é’Ÿã€‚
<br>&nbsp;&nbsp;&nbsp;&nbsp; struct timespec t = {1, 0};
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pthread_cond_timedwait (&amp;cond, &amp;mutex, &amp;t); åªèƒ½å®šæ—¶åˆ° 1970å¹´1æœˆ1æ—¥ 00:00:01ç§’(Unixè®¡æ—¶å…ƒå¹´)
<br>&nbsp;&nbsp;&nbsp;&nbsp; æ­£ç¡®ç”¨æ³•ï¼š
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; time_t cur = time(NULL); è·å–å½“å‰æ—¶é—´ã€‚
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct timespec t; å®šä¹‰timespec ç»“æ„ä½“å˜é‡t
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; t.tv_sec = cur+1; å®šæ—¶1ç§’
<br>&nbsp;&nbsp;&nbsp;&nbsp; pthread_cond_timedwait (&amp;cond, &amp;mutex, &amp;t);  ä¼ å‚
<br>&nbsp;&nbsp;&nbsp;&nbsp; åœ¨è®²è§£setitimerå‡½æ•°æ—¶æˆ‘ä»¬è¿˜æåˆ°å¦å¤–ä¸€ç§æ—¶é—´ç±»å‹ï¼š
<br>&nbsp;&nbsp;&nbsp;&nbsp; struct timeval {
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; time_t      tv_sec;  /* seconds */ ç§’
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; suseconds_t tv_usec;     /* microseconds */ å¾®ç§’
<br>&nbsp;&nbsp;&nbsp;&nbsp; };
<br> âœ§ pthread_cond_signal() å‡½æ•°
<br>&nbsp;&nbsp;&nbsp;&nbsp; å”¤é†’è‡³å°‘ä¸€ä¸ªé˜»å¡åœ¨æ¡ä»¶å˜é‡ä¸Šçš„çº¿ç¨‹
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ğŸˆ int pthread_cond_signal(pthread_cond_t *cond);
<br> âœ§ pthread_cond_broadcast() å‡½æ•°
<br>&nbsp;&nbsp;&nbsp;&nbsp; å”¤é†’å…¨éƒ¨é˜»å¡åœ¨æ¡ä»¶å˜é‡ä¸Šçš„çº¿ç¨‹
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ğŸˆ int pthread_cond_broadcast(pthread_cond_t *cond);
<br>
<br><font color=black size = 5><a name="bc11">æ¡ä»¶å˜é‡çš„ä¼˜ç‚¹</a></font>
<br> âœ¦ ç›¸è¾ƒäºmutexè€Œè¨€ï¼Œæ¡ä»¶å˜é‡å¯ä»¥å‡å°‘ç«äº‰ã€‚
<br> âœ¦ å¦‚æœç›´æ¥ä½¿ç”¨mutexï¼Œé™¤äº†ç”Ÿäº§è€…ã€æ¶ˆè´¹è€…ä¹‹é—´è¦ç«äº‰äº’æ–¥é‡ä»¥å¤–ï¼Œæ¶ˆè´¹è€…ä¹‹é—´ä¹Ÿéœ€è¦ç«äº‰äº’æ–¥é‡ï¼Œä½†å¦‚æœæ±‡èš(é“¾è¡¨)ä¸­æ²¡æœ‰æ•°æ®ï¼Œæ¶ˆè´¹è€…ä¹‹é—´ç«äº‰äº’æ–¥é”æ˜¯æ— æ„ä¹‰çš„ï¼Œæœ‰äº†æ¡ä»¶å˜é‡æœºåˆ¶ä»¥åï¼Œåªæœ‰ç”Ÿäº§è€…å®Œæˆç”Ÿäº§ï¼Œæ‰ä¼šå¼•èµ·æ¶ˆè´¹è€…ä¹‹é—´çš„ç«äº‰ï¼Œä»è€Œæé«˜äº†ç¨‹åºæ•ˆç‡ã€‚
<br>
<br><font color=black size = 5><a name="bc12">ä¿¡å·é‡æ¦‚è¿°</a></font>
<br> âœ¦ è¿›åŒ–ç‰ˆçš„äº’æ–¥é”ï¼ˆ1 â†’ Nï¼‰
<br> âœ¦ ç”±äºäº’æ–¥é”çš„ç²’åº¦æ¯”è¾ƒå¤§ï¼Œå¦‚æœæˆ‘ä»¬å¸Œæœ›åœ¨å¤šä¸ªçº¿ç¨‹é—´å¯¹æŸä¸€å¯¹è±¡çš„éƒ¨åˆ†æ•°æ®è¿›è¡Œå…±äº«ï¼Œä½¿ç”¨äº’æ–¥é”æ˜¯æ²¡æœ‰åŠæ³•å®ç°çš„ï¼Œåªèƒ½å°†æ•´ä¸ªæ•°æ®å¯¹è±¡é”ä½ã€‚è¿™æ ·è™½ç„¶è¾¾åˆ°äº†å¤šçº¿ç¨‹æ“ä½œå…±äº«æ•°æ®æ—¶ä¿è¯æ•°æ®æ­£ç¡®æ€§çš„ç›®çš„ï¼Œå´æ— å½¢ä¸­å¯¼è‡´çº¿ç¨‹çš„å¹¶å‘æ€§ä¸‹é™ã€‚çº¿ç¨‹ä»å¹¶è¡Œæ‰§è¡Œï¼Œå˜æˆäº†ä¸²è¡Œæ‰§è¡Œã€‚ä¸ç›´æ¥ä½¿ç”¨å•è¿›ç¨‹æ— å¼‚ã€‚
<br> âœ¦ ä¿¡å·é‡ï¼Œæ˜¯ç›¸å¯¹æŠ˜ä¸­çš„ä¸€ç§å¤„ç†æ–¹å¼ï¼Œæ—¢èƒ½ä¿è¯åŒæ­¥ï¼Œæ•°æ®ä¸æ··ä¹±ï¼Œåˆèƒ½æé«˜çº¿ç¨‹å¹¶å‘ã€‚
<br>
<br><font color=black size = 5><a name="bc13">ä¿¡å·é‡åŸºæœ¬æ“ä½œã€ä¸»è¦å‡½æ•°åŠåº”ç”¨</a></font>
<br> âœ¦ sem_init() å‡½æ•°
<br> âœ¦ sem_destroy() å‡½æ•°
<br> âœ¦ sem_wait() å‡½æ•°
<br> âœ¦ sem_trywait() å‡½æ•°
<br> âœ¦ sem_timedwait() å‡½æ•°
<br> âœ¦ sem_post() å‡½æ•°
<br>  ä»¥ä¸Š6 ä¸ªå‡½æ•°çš„è¿”å›å€¼éƒ½æ˜¯ï¼šæˆåŠŸè¿”å›0ï¼Œ å¤±è´¥è¿”å›-1ï¼ŒåŒæ—¶è®¾ç½®errnoã€‚(æ³¨æ„ï¼Œå®ƒä»¬æ²¡æœ‰pthreadå‰ç¼€)
<br> âœ¦ sem_tç±»å‹ï¼Œæœ¬è´¨ä»æ˜¯ç»“æ„ä½“ï¼Œä½†åœ¨åº”ç”¨æœŸé—´å¯ç®€å•çœ‹ä½œä¸ºæ•´æ•°ï¼Œå¿½ç•¥å®ç°ç»†èŠ‚ï¼ˆç±»ä¼¼äºä½¿ç”¨æ–‡ä»¶æè¿°ç¬¦ï¼‰ã€‚
<br> âœ¦ sem_t sem; è§„å®šä¿¡å·é‡semä¸èƒ½ &lt; 0ï¼Œå¤´æ–‡ä»¶ <semaphore.h>
<br> âœ¦ sem_wait:   0ã€ä¿¡å·é‡å¤§äº0ï¼Œåˆ™ä¿¡å·é‡--(ç±»æ¯”pthread_mutex_lock)
<br> âœ¦ 1ã€ä¿¡å·é‡ç­‰äº0ï¼Œé€ æˆçº¿ç¨‹é˜»å¡ | å¯¹åº” | sem_postï¼šå°†ä¿¡å·é‡++ï¼ŒåŒæ—¶å”¤é†’é˜»å¡åœ¨ä¿¡å·é‡ä¸Šçš„çº¿ç¨‹ (ç±»æ¯”pthread_mutex_unlock)
<br> âœ¦ ä½†æ˜¯ç”±äºsem_tçš„å®ç°å¯¹ç”¨æˆ·éšè—ï¼Œæ‰€ä»¥æ‰€è°“çš„++ã€--æ“ä½œåªèƒ½é€šè¿‡å‡½æ•°æ¥å®ç°ï¼Œè€Œä¸èƒ½ç›´æ¥++ã€--ç¬¦å·ã€‚
<br> âœ¦ ä¿¡å·é‡çš„åˆå€¼ï¼Œå†³å®šäº†å ç”¨ä¿¡å·é‡çš„çº¿ç¨‹çš„ä¸ªæ•°ã€‚
<br> âœ§ sem_init() å‡½æ•°
<br>&nbsp;&nbsp;&nbsp;&nbsp; åˆå§‹åŒ–ä¸€ä¸ªä¿¡å·é‡
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ğŸˆ int sem_init(sem_t *sem, int pshared, unsigned int value);
<br>&nbsp;&nbsp;&nbsp;&nbsp; å‚æ•°1ï¼šsemä¿¡å·é‡
<br>&nbsp;&nbsp;&nbsp;&nbsp; å‚æ•°2ï¼špsharedå–0ç”¨äºçº¿ç¨‹é—´ï¼›å–é0(ä¸€èˆ¬ä¸º1)ç”¨äºè¿›ç¨‹é—´
<br>&nbsp;&nbsp;&nbsp;&nbsp; å‚æ•°3ï¼švalueæŒ‡å®šä¿¡å·é‡åˆå€¼
<br> âœ§ sem_destroy() å‡½æ•°
<br>&nbsp;&nbsp;&nbsp;&nbsp; é”€æ¯ä¸€ä¸ªä¿¡å·é‡
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ğŸˆ int sem_destroy(sem_t *sem);
<br> âœ§ sem_wait() å‡½æ•°
<br>&nbsp;&nbsp;&nbsp;&nbsp; ç»™ä¿¡å·é‡åŠ é” --
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ğŸˆ int sem_wait(sem_t *sem);
<br> âœ§ sem_post() å‡½æ•°
<br>&nbsp;&nbsp;&nbsp;&nbsp; ç»™ä¿¡å·é‡è§£é” ++
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ğŸˆ int sem_post(sem_t *sem);
<br> âœ§ sem_trywait() å‡½æ•°
<br>&nbsp;&nbsp;&nbsp;&nbsp; å°è¯•å¯¹ä¿¡å·é‡åŠ é” --    (ä¸sem_waitçš„åŒºåˆ«ç±»æ¯”lockå’Œtrylock)
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ğŸˆ int sem_trywait(sem_t *sem);
<br> âœ§ sem_timedwait() å‡½æ•°
<br>&nbsp;&nbsp;&nbsp;&nbsp; é™æ—¶å°è¯•å¯¹ä¿¡å·é‡åŠ é” --
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ğŸˆ int sem_timedwait(sem_t *sem, const struct timespec *abs_timeout);
<br>&nbsp;&nbsp;&nbsp;&nbsp; å‚æ•°2ï¼šabs_timeouté‡‡ç”¨çš„æ˜¯ç»å¯¹æ—¶é—´ã€‚
<br>&nbsp;&nbsp;&nbsp;&nbsp; å®šæ—¶1ç§’ï¼š
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; time_t cur = time(NULL); è·å–å½“å‰æ—¶é—´ã€‚
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct timespec t; å®šä¹‰timespec ç»“æ„ä½“å˜é‡t
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; t.tv_sec = cur+1; å®šæ—¶1ç§’
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; t.tv_nsec = t.tv_sec +100;
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sem_timedwait(&amp;sem, &amp;t); ä¼ å‚
<br>
<br><font color=black size = 5><a name="bc14">è¿›ç¨‹åŒæ­¥</a></font>
<br><font color=black size = 5><a name="bc14">äº’æ–¥é‡ mutex</a></font>
<br> âœ¦ è¿›ç¨‹é—´ä¹Ÿå¯ä»¥ä½¿ç”¨äº’æ–¥é”ï¼Œæ¥è¾¾åˆ°åŒæ­¥çš„ç›®çš„ï¼Œä½†æ˜¯éœ€è¦åœ¨pthread_mutex_init() åˆå§‹åŒ–ä¹‹å‰ï¼Œä¿®æ”¹å…¶å±æ€§ä¸ºè¿›ç¨‹é—´å…±äº«ï¼Œmutexçš„å±æ€§ä¿®æ”¹å‡½æ•°ä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªã€‚
<br>
<br><font color=black size = 5><a name="bc15">ä¸»è¦å‡½æ•°åŠåº”ç”¨</a></font>
<br>&nbsp;&nbsp;&nbsp;&nbsp; pthread_mutexattr_t mattr ç±»å‹ï¼šç”¨äºå®šä¹‰mutexé”çš„ã€å±æ€§ã€‘
<br> âœ§ pthread_mutexattr_init() å‡½æ•°ï¼šåˆå§‹åŒ–ä¸€ä¸ªmutexå±æ€§å¯¹è±¡
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ğŸˆ int pthread_mutexattr_init(pthread_mutexattr_t *attr);
<br> âœ§ pthread_mutexattr_destroy() å‡½æ•°ï¼šé”€æ¯mutexå±æ€§å¯¹è±¡ (è€Œéé”€æ¯é”)
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ğŸˆ int pthread_mutexattr_destroy(pthread_mutexattr_t *attr);
<br> âœ§ pthread_mutexattr_setpshared() å‡½æ•°ï¼šä¿®æ”¹mutexå±æ€§ã€‚
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ğŸˆ int pthread_mutexattr_setpshared(pthread_mutexattr_t *attr, int pshared);
<br>&nbsp;&nbsp;&nbsp;&nbsp; å‚æ•°2ï¼špsharedå–å€¼ï¼š
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; çº¿ç¨‹é”ï¼šPTHREAD_PROCESS_PRIVATE (mutexçš„é»˜è®¤å±æ€§å³ä¸ºçº¿ç¨‹é”ï¼Œè¿›ç¨‹é—´ç§æœ‰)
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; è¿›ç¨‹é”ï¼šPTHREAD_PROCESS_SHARED
<br> ğŸ‘¦ è¿›ç¨‹é—´mutexç¤ºä¾‹ï¼šè¿›ç¨‹é—´ä½¿ç”¨mutexæ¥å®ç°åŒæ­¥
<br><div style="width:100%;border:1px #e3e3e3 solid;"><div style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;border-bottom:1px solid #e3e3e3;margin-top:5px;color:#000000;">&nbsp;C++ Code&nbsp;</div><table style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;vertical-align:text-top;line-height:15px;" border="0" cellspacing="0" cellpadding="0"><tr><td style="color:#008284;background-color:#e3e3e3;vertical-align:text-top;"><div style="margin:7px;text-align:right;white-space:nowrap;"><nobr>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44<br>45<br>46<br>47<br>48<br>49<br>50<br>51<br>52<br>53<br>54<br>55<br>56<br></nobr></div></td><td style="background-color:#008284;padding:1px;"><div style="border:1px #008284 solid;"></div></td><td style="background-color:#efefef;width:100%;vertical-align:text-top;color:#000000;"><div style="margin:7px;"><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;fcntl.h&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;pthread.h&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;sys/mman.h&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;sys/wait.h&gt;<BR>
<BR>
</span><span style="color:#0000ff;">struct</span><span style="color:#000000;">&nbsp;mt&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;num;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;pthread_mutex_t&nbsp;mutex;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;pthread_mutexattr_t&nbsp;mutexattr;<BR>
};<BR>
<BR>
</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;main(</span><span style="color:#8000ff;">void</span><span style="color:#000000;">)<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;fd,&nbsp;i;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">struct</span><span style="color:#000000;">&nbsp;mt&nbsp;*mm;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;pid_t&nbsp;pid;<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;fd&nbsp;=&nbsp;open(</span><span style="color:#800000;">&quot;mt_test&quot;</span><span style="color:#000000;">,&nbsp;O_CREAT&nbsp;|&nbsp;O_RDWR,&nbsp;</span><span style="color:#ff0000;">0777</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;ftruncate(fd,&nbsp;</span><span style="color:#0000ff;">sizeof</span><span style="color:#000000;">(*mm));<BR>
&nbsp;&nbsp;&nbsp;&nbsp;mm&nbsp;=&nbsp;mmap(</span><span style="color:#0000ff;">NULL</span><span style="color:#000000;">,&nbsp;</span><span style="color:#0000ff;">sizeof</span><span style="color:#000000;">(*mm),&nbsp;PROT_READ|PROT_WRITE,&nbsp;MAP_SHARED,&nbsp;fd,&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;close(fd);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;unlink(</span><span style="color:#800000;">&quot;mt_test&quot;</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//mm&nbsp;=&nbsp;mmap(NULL,&nbsp;sizeof(*mm),&nbsp;PROT_READ|PROT_WRITE,&nbsp;MAP_SHARED|MAP_ANON,&nbsp;-1,&nbsp;0);<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;memset(mm,&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">,&nbsp;</span><span style="color:#0000ff;">sizeof</span><span style="color:#000000;">(*mm));<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//åˆå§‹åŒ–mutexå±æ€§å¯¹è±¡<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;pthread_mutexattr_init(&amp;mm-&gt;mutexattr);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//ä¿®æ”¹å±æ€§ä¸ºè¿›ç¨‹é—´å…±äº«<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;pthread_mutexattr_setpshared(&amp;mm-&gt;mutexattr,&nbsp;PTHREAD_PROCESS_SHARED);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;pthread_mutex_init(&amp;mm-&gt;mutex,&nbsp;&amp;mm-&gt;mutexattr);&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//åˆå§‹åŒ–ä¸€æŠŠmutexç<BR>
</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;pid&nbsp;=&nbsp;fork();<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(pid&nbsp;==&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">)&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">for</span><span style="color:#000000;">&nbsp;(i&nbsp;=&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;&nbsp;i&nbsp;&lt;&nbsp;</span><span style="color:#ff0000;">10</span><span style="color:#000000;">;&nbsp;i++)&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pthread_mutex_lock(&amp;mm-&gt;mutex);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(mm-&gt;num)++;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(</span><span style="color:#800000;">&quot;-child----num++&nbsp;&nbsp;&nbsp;%d\n&quot;</span><span style="color:#000000;">,&nbsp;mm-&gt;num);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pthread_mutex_unlock(&amp;mm-&gt;mutex);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sleep(</span><span style="color:#ff0000;">1</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;</span><span style="color:#0000ff;">else</span><span style="color:#000000;">&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(pid&nbsp;&gt;&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">)&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">for</span><span style="color:#000000;">&nbsp;(&nbsp;i&nbsp;=&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;&nbsp;i&nbsp;&lt;&nbsp;</span><span style="color:#ff0000;">10</span><span style="color:#000000;">;&nbsp;i++)&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sleep(</span><span style="color:#ff0000;">1</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pthread_mutex_lock(&amp;mm-&gt;mutex);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mm-&gt;num&nbsp;+=&nbsp;</span><span style="color:#ff0000;">2</span><span style="color:#000000;">;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(</span><span style="color:#800000;">&quot;-parent---num+=2&nbsp;&nbsp;%d\n&quot;</span><span style="color:#000000;">,&nbsp;mm-&gt;num);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pthread_mutex_unlock(&amp;mm-&gt;mutex);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wait(</span><span style="color:#0000ff;">NULL</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;pthread_mutexattr_destroy(&amp;mm-&gt;mutexattr);&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//é”€æ¯mutexå±æ€§å¯¹è±¡<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;pthread_mutex_destroy(&amp;mm-&gt;mutex);&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//é”€æ¯mutex<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;munmap(mm,</span><span style="color:#0000ff;">sizeof</span><span style="color:#000000;">(*mm));&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//é‡Šæ”¾æ˜ å°„åŒº<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;<BR>
}</span></div></td></tr></table></div>
<br>
<br><font color=black size = 5><a name="bc16">æ–‡ä»¶é”æ¦‚è¿°</a></font>
<br> âœ¦ å€ŸåŠ© fcntl() å‡½æ•°æ¥å®ç°é”æœºåˆ¶ï¼Œæ“ä½œæ–‡ä»¶çš„è¿›ç¨‹æ²¡æœ‰è·å¾—é”æ—¶ï¼Œå¯ä»¥æ‰“å¼€ï¼Œä½†æ— æ³•æ‰§è¡Œreadã€writeæ“ä½œã€‚
<br>
<br><font color=black size = 5><a name="bc17">ç›¸å…³å‡½æ•°åŠåº”ç”¨</a></font>
<br> âœ¦ fcntlå‡½æ•°ï¼šè·å–ã€è®¾ç½®æ–‡ä»¶è®¿é—®æ§åˆ¶å±æ€§ã€‚
<br> âœ¦ int fcntl(int fd, int cmd, ... /* arg */ );
<br>&nbsp;&nbsp;&nbsp;&nbsp; å‚æ•°2ï¼š
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; F_SETLK (struct flock *)    è®¾ç½®æ–‡ä»¶é”ï¼ˆtrylockï¼‰
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; F_SETLKW (struct flock *)    è®¾ç½®æ–‡ä»¶é”ï¼ˆlockï¼‰W --&gt; wait
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; F_GETLK (struct flock *)    è·å–æ–‡ä»¶é”
<br>&nbsp;&nbsp;&nbsp;&nbsp; å‚æ•°3ï¼š
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   struct flock {
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ...
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; short l_type;     é”çš„ç±»å‹ï¼šF_RDLCK ã€F_WRLCK ã€F_UNLCK
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; short l_whence;   åç§»ä½ç½®ï¼šSEEK_SETã€SEEK_CURã€SEEK_END
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; off_t l_start;       èµ·å§‹åç§»ï¼š1000
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; off_t l_len;         é•¿åº¦ï¼š0è¡¨ç¤ºæ•´ä¸ªæ–‡ä»¶åŠ é”
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pid_t l_pid;         æŒæœ‰è¯¥é”çš„è¿›ç¨‹IDï¼š(F_GETLK only)
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ...
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; };
<br> ğŸ‘¦ è¿›ç¨‹é—´æ–‡ä»¶é”ç¤ºä¾‹ï¼šå¤šä¸ªè¿›ç¨‹å¯¹åŠ é”æ–‡ä»¶è¿›è¡Œè®¿é—®<br />
<br><div style="width:100%;border:1px #e3e3e3 solid;"><div style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;border-bottom:1px solid #e3e3e3;margin-top:5px;color:#000000;">&nbsp;C++ Code&nbsp;</div><table style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;vertical-align:text-top;line-height:15px;" border="0" cellspacing="0" cellpadding="0"><tr><td style="color:#008284;background-color:#e3e3e3;vertical-align:text-top;"><div style="margin:7px;text-align:right;white-space:nowrap;"><nobr>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br></nobr></div></td><td style="background-color:#008284;padding:1px;"><div style="border:1px #008284 solid;"></div></td><td style="background-color:#efefef;width:100%;vertical-align:text-top;color:#000000;"><div style="margin:7px;"><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;stdio.h&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;fcntl.h&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;unistd.h&gt;<BR>
<BR>
</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;sys_err(</span><span style="color:#8000ff;">char</span><span style="color:#000000;">&nbsp;*str)<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;perror(str);&nbsp;exit(</span><span style="color:#ff0000;">1</span><span style="color:#000000;">);<BR>
}<BR>
</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;main(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;argc,&nbsp;</span><span style="color:#8000ff;">char</span><span style="color:#000000;">&nbsp;*argv[])<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;fd;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">struct</span><span style="color:#000000;">&nbsp;flock&nbsp;f_lock;<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(argc&nbsp;&lt;&nbsp;</span><span style="color:#ff0000;">2</span><span style="color:#000000;">)&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(</span><span style="color:#800000;">&quot;./a.out&nbsp;filename\n&quot;</span><span style="color:#000000;">);&nbsp;exit(</span><span style="color:#ff0000;">1</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;((fd&nbsp;=&nbsp;open(argv[</span><span style="color:#ff0000;">1</span><span style="color:#000000;">],&nbsp;O_RDWR))&nbsp;&lt;&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sys_err(</span><span style="color:#800000;">&quot;open&quot;</span><span style="color:#000000;">);<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//f_lock.l_type&nbsp;=&nbsp;F_WRLCK;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*é€‰ç”¨å†™ç*/<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;f_lock.l_type&nbsp;=&nbsp;F_RDLCK;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">/*é€‰ç”¨è¯»ç*/</span><span style="color:#000000;">&nbsp;<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;f_lock.l_whence&nbsp;=&nbsp;SEEK_SET;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;f_lock.l_start&nbsp;=&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;f_lock.l_len&nbsp;=&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">/*&nbsp;0è¡¨ç¤ºæ•´ä¸ªæ–‡ä»¶åŠ é”&nbsp;*/</span><span style="color:#000000;"><BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;fcntl(fd,&nbsp;F_SETLKW,&nbsp;&amp;f_lock);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;printf(</span><span style="color:#800000;">&quot;get&nbsp;flock\n&quot;</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;sleep(</span><span style="color:#ff0000;">10</span><span style="color:#000000;">);<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;f_lock.l_type&nbsp;=&nbsp;F_UNLCK;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;fcntl(fd,&nbsp;F_SETLKW,&nbsp;&amp;f_lock);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;printf(</span><span style="color:#800000;">&quot;un&nbsp;flock\n&quot;</span><span style="color:#000000;">);<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;close(fd);&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;<BR>
}</span></div></td></tr></table></div>
<br>ä¾ç„¶éµå¾ªâ€œè¯»å…±äº«ã€å†™ç‹¬å â€ç‰¹æ€§ï¼Œä½†æ˜¯å¦‚è‹¥è¿›ç¨‹ä¸åŠ é”ç›´æ¥æ“ä½œæ–‡ä»¶ï¼Œä¾ç„¶å¯è®¿é—®æˆåŠŸï¼Œä½†æ•°æ®åŠ¿å¿…ä¼šå‡ºç°æ··ä¹±ã€‚
<br> ğŸ‘¦ æ€è€ƒï¼šå¤šçº¿ç¨‹ä¸­ï¼Œå¯ä»¥ä½¿ç”¨æ–‡ä»¶é”å—ï¼Ÿ
<br>&nbsp;&nbsp;&nbsp;&nbsp; å¤šçº¿ç¨‹é—´å…±äº«æ–‡ä»¶æè¿°ç¬¦ï¼Œè€Œç»™æ–‡ä»¶åŠ é”ï¼Œæ˜¯é€šè¿‡ä¿®æ”¹æ–‡ä»¶æè¿°ç¬¦æ‰€æŒ‡å‘çš„æ–‡ä»¶ç»“æ„ä½“ä¸­çš„æˆå‘˜å˜é‡æ¥å®ç°çš„ã€‚å› æ­¤ï¼Œå¤šçº¿ç¨‹ä¸­æ— æ³•ä½¿ç”¨æ–‡ä»¶é”ã€‚</p>

<p><br><br><br>
<font color = gray size = 3>å¦‚æœ‰é”™è¯¯ï¼Œæ¬¢è¿æŒ‡æ­£ï¼</font></p></div>
        <div class="post_footer">
          
          <div class="meta">
            <div class="info">
              <span class="field tags">
                <i class="remixicon-stack-line"></i>
                
                <a href="https://oubc.github.io/tags/linux/">Linux</a>
                
              </span>
            </div>
          </div>
          
        </div>
      </div>
      
      
    </div>
  </div>
  <a id="back_to_top" href="#" class="back_to_top"><span>â–³</span></a>
</div>
<footer class="footer">
  <div class="powered_by">
    <a href="https://wxt.sinaimg.cn/thumb300/007Diza3ly1g4l9lmg4aog3074074gnf.gif?tags=%5B%5D">I </a>
	<a href="">love</a>
    <a href="https://wxt.sinaimg.cn/thumb300/007Diza3ly1g4l9lmfm2eg306o06o74u.gif?tags=%5B%5D"> you </a>
    <a href="https://wxt.sinaimg.cn/thumb300/007Diza3ly1g4njrx4tpcj30fn0bq3zg.jpg?tags=%5B%5D">three </a>
	<a href="https://wxt.sinaimg.cn/thumb300/007Diza3ly1g4njrx64ctg307s07swfy.gif?tags=%5B%5D">thousand</a>
    <a href="https://www.kugou.com/song/#hash=96426C78381DE98DC31A5846FC274CBF&album_id=646623"> times.</a>
  </div>

  <div class="footer_slogan">
    <span>å®¶åº­ã€æ¢¦æƒ³ã€å†…å¿ƒçš„å¹³é™</span>
  </div>
</footer>



<script src="https://oubc.github.io/js/jquery-3.3.1.min.js"></script>
<script src="https://oubc.github.io/js/zozo.js"></script>
<script src="https://oubc.github.io/js/highlight.pack.js"></script>
<link  href="https://oubc.github.io/css/fancybox.min.css" rel="stylesheet">
<script src="https://oubc.github.io/js/fancybox.min.js"></script>

<script>hljs.initHighlightingOnLoad()</script>


  <script type="text/javascript" async src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[\[','\]\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});

MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<style>
code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
}
</style>






</body>
</html>
