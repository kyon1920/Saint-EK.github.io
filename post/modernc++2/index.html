<!DOCTYPE html>
<html lang="zh-cn" >
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  
  <meta name="author"
        content="Bruce Cheung"/>

  
  <meta name="description" content=""/>
  

  
  
  <meta name="keywords" content="blog, simple, dream"/>
  

  
  <link rel="canonical" href="https://oubc.github.io/post/modernc&#43;&#43;2/"/>

  

  <title>Modern C&#43;&#43; å¤šçº¿ç¨‹ mutex &middot; Love, or death</title>

  <link rel="shortcut icon" href="https://oubc.github.io/images/favicon.ico"/>
  <link rel="stylesheet" href="https://oubc.github.io/css/animate.min.css"/>
  <link rel="stylesheet" href="https://oubc.github.io/css/remixicon.css"/>
  <link rel="stylesheet" href="https://oubc.github.io/css/zozo.css"/>
  <link rel="stylesheet" href="https://oubc.github.io/css/highlight.css"/>

  
  
</head>

<body>
<div class="main animated">
  <div class="nav_container animated fadeInDown">
  <div class="site_nav" id="site_nav">
    <ul>
      
      <li>
        <a href="/">é¦–é¡µ</a>
      </li>
      
      <li>
        <a href="/post/">å½’æ¡£</a>
      </li>
      
      <li>
        <a href="/tags/">æ ‡ç­¾</a>
      </li>
      
      <li>
        <a href="/about/">å…³äº</a>
      </li>
      
    </ul>
  </div>
  <div class="menu_icon">
    <a id="menu_icon"><i class="remixicon-links-line"></i></a>
  </div>
</div>

  <div class="header animated fadeInDown">
  <div class="site_title_container">
    <div class="site_title">
      <h1>
        <a href="https://oubc.github.io/">
          <span>Love, or death</span>
          <img src="https://oubc.github.io/images/logo.svg"/>
        </a>
      </h1>
    </div>
    <div class="description">
      <p class="sub_title">For you, a thousand times over.</p>
      <div class="my_socials">
        
        
        <a href="https://github.com/oubc" title="github" target="_blank"><i class="remixicon-github-fill"></i></a>
        
        
        
        <a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=uYGOjo6OiIuLivnIyJfa1tQ" title="mail" target="_blank"><i class="remixicon-mail-fill"></i></a>
        
        
        
        <a href="http://sighttp.qq.com/msgrd?v=1&amp;uin=877771223" title="qq" target="_blank"><i class="remixicon-qq-fill"></i></a>
        
        
        
        <a href="https://github.com/oubc/oubc.github.io/blob/master/images/wx.jpg?raw=true" title="wechat" target="_blank"><i class="remixicon-wechat-fill"></i></a>
        
        
        
        <a href="https://weibo.com/u/6993631995?topnav=1&amp;wvr=6&amp;topsug=1" title="weibo" target="_blank"><i class="remixicon-weibo-fill"></i></a>
        
        
        <a href="https://oubc.github.io/index.xml" type="application/rss+xml" title="rss" target="_blank"><i class="remixicon-rss-fill"></i></a>
      </div>
    </div>
  </div>
</div>

  <div class="content">
    <div class="post_page">
      <div class="post animated fadeInDown">
        <div class="post_title post_detail_title">
          <h2><a href='/post/modernc&#43;&#43;2/'>Modern C&#43;&#43; å¤šçº¿ç¨‹ mutex</a></h2>
          <span class="date">2020.02.12</span>
        </div>
        <div class="post_content markdown"><p><br>
<br><font color=green size = 5>C++æ–°æ ‡å‡†ä¹‹å¤šçº¿ç¨‹ mutexäº’æ–¥é‡</font>
<br> â— mutexåˆç§°äº’æ–¥é‡ï¼Œç”¨äºæä¾›å¯¹å…±äº«å˜é‡çš„äº’æ–¥è®¿é—®
<br> â— C++æ–°æ ‡å‡†ä¸­mutexç›¸å…³çš„ç±»éƒ½åœ¨&lt;mutex&gt;å¤´æ–‡ä»¶ä¸­
<br>
<br><font color=green size = 5>&lt;mutex&gt;</font>
<br> â— &lt;mutex&gt;ï¼šè¯¥å¤´æ–‡ä»¶ä¸»è¦å£°æ˜äº†ä¸äº’æ–¥é‡(mutex)ç›¸å…³çš„ç±»ï¼ŒåŒ…æ‹¬ std::mutex ç³»åˆ—ç±»ï¼Œstd::lock_guard, std::unique_lock, ä»¥åŠå…¶ä»–çš„ç±»å‹å’Œå‡½æ•°ã€‚
<br> â— åœ¨C++æ–°æ ‡å‡†ä¸­ï¼Œå…±å››ç§äº’æ–¥ç±»:
<table border="4">
<tr>
<th>åºå·</th>
<th>åç§°</th>
<th>æ„ä¹‰</th>
</tr>
<tr>
<td>1</td>
<td>std::mutex</td>
<td>æœ€åŸºæœ¬ä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„äº’æ–¥ç±»</td>
</tr>
<tr>
<td>2</td>
<td>std::recursive_mutex</td>
<td>åŒä¸€çº¿ç¨‹å†…å¯é€’å½’(é‡å…¥)çš„äº’æ–¥ç±»</td>
</tr>
<tr>
<td>3</td>
<td>std::timed_mutex</td>
<td>é™¤å…·å¤‡mutexåŠŸèƒ½å¤–ï¼Œè¿˜æä¾›äº†å¸¦æ—¶é™è¯·æ±‚é”å®šçš„èƒ½åŠ›</td>
</tr>
<tr>
<td>4</td>
<td>std::recursive_timed_mutex</td>
<td>åŒä¸€çº¿ç¨‹å†…å¯é€’å½’(é‡å…¥)çš„timed_mutex</td>
</tr>
</table>
 â— ä¸std::threadä¸€æ ·ï¼Œmutexç›¸å…³ç±»ä¸æ”¯æŒæ‹·è´æ„é€ ã€ä¸æ”¯æŒèµ‹å€¼ã€‚åŒæ—¶mutexç±»ä¹Ÿä¸æ”¯æŒmoveè¯­ä¹‰(moveæ„é€ ã€moveèµ‹å€¼)ï¼Œæ‰€ä»¥ä¸ç”¨æ‹…å¿ƒä¼šè¯¯ç”¨è¿™äº›æ“ä½œã€‚
<br>
<br><font color=blue size = 4>std::mutex</font>
<br> â— (constructor)ä¸å…è®¸æ‹·è´ï¼›äº’æ–¥å¯¹è±¡ä¸èƒ½è¢«å¤åˆ¶/ç§»åŠ¨ï¼Œåˆå§‹çŠ¶æ€ä¸ºæœªé”å®šã€‚
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; default (1ï¼‰ constexpr mutex() noexcept;
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; copy [deleted] (2) mutex (const mutex&amp;) = delete;
<br>
<br><font color=blue size = 4>lock</font>
<br> â— é”ä½äº’æ–¥é‡ã€‚è°ƒç”¨lockæ—¶æœ‰ä¸‰ç§æƒ…å†µ:
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1.å¦‚æœäº’æ–¥é‡æ²¡æœ‰è¢«é”ä½ï¼Œåˆ™è°ƒç”¨çº¿ç¨‹å°†è¯¥mutexé”ä½ï¼Œç›´åˆ°è°ƒç”¨çº¿ç¨‹è°ƒç”¨unlocké‡Šæ”¾é”ï¼›
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2.å¦‚æœmutexå·²è¢«å…¶å®ƒçº¿ç¨‹lockï¼Œåˆ™è°ƒç”¨çº¿ç¨‹å°†è¢«é˜»å¡ï¼Œç›´åˆ°å…¶å®ƒçº¿ç¨‹unlockè¯¥mutexï¼›
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3.å¦‚æœå½“å‰mutexå·²è¢«è°ƒç”¨è€…çº¿ç¨‹é”ä½ï¼Œåˆ™std::mutexæ­»é”ï¼Œè€Œrecursiveç³»åˆ—åˆ™æˆåŠŸè¿”å›ã€‚
<br>
<br><font color=blue size = 4>try_lock</font>
<br> â— å°è¯•é”ä½mutexï¼Œè°ƒç”¨è¯¥å‡½æ•°æœ‰ä¸‰ç§æƒ…å†µï¼š
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1.å¦‚æœäº’æ–¥é‡æ²¡æœ‰è¢«é”ä½ï¼Œåˆ™è°ƒç”¨çº¿ç¨‹å°†è¯¥mutexé”ä½(è¿”å›true)ï¼Œç›´åˆ°è°ƒç”¨çº¿ç¨‹è°ƒç”¨unlocké‡Šæ”¾ï¼›
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2.å¦‚æœmutexå·²è¢«å…¶å®ƒçº¿ç¨‹lockï¼Œåˆ™è°ƒç”¨çº¿ç¨‹å°†å¤±è´¥ï¼Œæ²¡æœ‰é˜»å¡å¹¶è¿”å›false;
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3.å¦‚æœå½“å‰mutexå·²è¢«è°ƒç”¨è€…çº¿ç¨‹é”ä½ï¼Œåˆ™std::mutexæ­»é”ï¼Œè€Œrecursiveç³»åˆ—åˆ™æˆåŠŸè¿”å›trueã€‚
<br>
<br><font color=blue size = 4>unlock</font>
<br> â— è§£é”mutexï¼Œé‡Šæ”¾mutexçš„æ‰€æœ‰æƒ
<br>æ³¨ï¼šå¯¹äºrecursiveç³»åˆ—mutexï¼Œunlockæ¬¡æ•°éœ€è¦ä¸lockæ¬¡æ•°ç›¸åŒæ‰å¯ä»¥å®Œå…¨è§£é”ã€‚
<br>
<br> ğŸ“ ç¨‹åºç¤ºä¾‹ï¼š
<br><div style="width:100%;border:1px #e3e3e3 solid;"><div style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;border-bottom:1px solid #e3e3e3;margin-top:5px;color:#000000;">&nbsp;C++ Code&nbsp;</div><table style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;vertical-align:text-top;line-height:15px;" border="0" cellspacing="0" cellpadding="0"><tr><td style="color:#008284;background-color:#e3e3e3;vertical-align:text-top;"><div style="margin:7px;text-align:right;white-space:nowrap;"><nobr>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44<br>45<br>46<br>47<br>48<br>49<br>50<br>51<br>52<br>53<br>54<br>55<br>56<br>57<br>58<br>59<br>60<br></nobr></div></td><td style="background-color:#008284;padding:1px;"><div style="border:1px #008284 solid;"></div></td><td style="background-color:#efefef;width:100%;vertical-align:text-top;color:#000000;"><div style="margin:7px;"><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;iostream&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;thread&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;mutex&gt;<BR>
mutex&nbsp;mtx;<BR>
mutex&nbsp;mtx1;<BR>
</span><span style="color:#0000ff;">volatile</span><span style="color:#000000;">&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;counter(</span><span style="color:#ff0000;">0</span><span style="color:#000000;">);<BR>
<BR>
</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;print_thread_id(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;id)<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;mtx.lock();<BR>
&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;thread&nbsp;#&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;id&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;\n&quot;</span><span style="color:#000000;">;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;mtx.unlock();<BR>
}<BR>
<BR>
</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;print_thread1_id(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;id)<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;mtx1.lock();<BR>
&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;thread&nbsp;#&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;id&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;\n&quot;</span><span style="color:#000000;">;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;mtx1.unlock();<BR>
}<BR>
<BR>
</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;attempt_10k_increases()<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">for</span><span style="color:#000000;">&nbsp;(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;i&nbsp;=&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;&nbsp;i&nbsp;&lt;&nbsp;</span><span style="color:#ff0000;">10000</span><span style="color:#000000;">;&nbsp;++i)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(mtx.try_lock())<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++counter;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mtx.unlock();<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
}<BR>
<BR>
</span><span style="color:#0000ff;">auto</span><span style="color:#000000;">&nbsp;main()&nbsp;-&gt;&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;"><BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;lock&nbsp;unlock&nbsp;ç¤ºä¾‹<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;thread&nbsp;threads[</span><span style="color:#ff0000;">10</span><span style="color:#000000;">];<BR>
&nbsp;&nbsp;&nbsp;&nbsp;thread&nbsp;th0(print_thread_id,&nbsp;</span><span style="color:#ff0000;">1000</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;thread&nbsp;th1(print_thread1_id,&nbsp;</span><span style="color:#ff0000;">2000</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">for</span><span style="color:#000000;">&nbsp;(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;i&nbsp;=&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;&nbsp;i&nbsp;&lt;&nbsp;</span><span style="color:#ff0000;">10</span><span style="color:#000000;">;&nbsp;++i)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;threads[i]&nbsp;=&nbsp;thread(print_thread_id,&nbsp;i&nbsp;+&nbsp;</span><span style="color:#ff0000;">1</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">for</span><span style="color:#000000;">&nbsp;(</span><span style="color:#0000ff;">auto</span><span style="color:#000000;">&amp;&nbsp;th&nbsp;:&nbsp;threads)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;th.join();<BR>
&nbsp;&nbsp;&nbsp;&nbsp;th0.join();<BR>
&nbsp;&nbsp;&nbsp;&nbsp;th1.join();<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;è¾“å‡º&nbsp;thread&nbsp;#1&nbsp;~&nbsp;10ï¼Œ<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;è‹¥//&nbsp;mtx.unlock&nbsp;åˆ™åªè¾“å‡º&nbsp;thread&nbsp;#1&nbsp;å¹¶äº§ç”Ÿäº†é˜»å¡<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;è‹¥åœ¨çº¿ç¨‹å‡½æ•°ä¸­&nbsp;ä¸¤æ¬¡åŠ é”&nbsp;åˆ™ä¼šäº§ç”Ÿæ­»é”<BR>
</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;try_lock&nbsp;unlock&nbsp;ç¤ºä¾‹<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">for</span><span style="color:#000000;">&nbsp;(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;i&nbsp;=&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;&nbsp;i&nbsp;&lt;&nbsp;</span><span style="color:#ff0000;">10</span><span style="color:#000000;">;&nbsp;++i)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;threads[i]&nbsp;=&nbsp;thread(attempt_10k_increases);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">for</span><span style="color:#000000;">&nbsp;(</span><span style="color:#0000ff;">auto</span><span style="color:#000000;">&amp;&nbsp;th&nbsp;:&nbsp;threads)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;th.join();<BR>
&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;counter&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;&nbsp;successful&nbsp;increases&quot;</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#800000;">&quot;&nbsp;of&nbsp;the&nbsp;counter.\n&quot;</span><span style="color:#000000;">;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;è¾“å‡ºç»“æœä¸ç¡®å®šï¼Œæœ‰å¯èƒ½ä¸º&nbsp;10000&nbsp;~&nbsp;100000<BR>
</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;<BR>
}</span></div></td></tr></table></div>
<br><font color=blue size = 4>native_handle</font>
<br> â— è·å–æœ¬åœ°å¤„ç†ï¼Œå¦‚æœåº“å®ç°æ”¯æŒå®ƒï¼Œè¿™ä¸ªæˆå‘˜å‡½æ•°åªå­˜åœ¨äºç±»äº’æ–¥ä¸­ï¼›
<br> â— å¦‚æœå­˜åœ¨ï¼Œå®ƒè¿”å›ä¸€ä¸ªå€¼ï¼Œè¿™ä¸ªå€¼ç”¨äºè®¿é—®ç‰¹å®šäºå®ç°çš„ä¿¡æ¯ç›¸å…³è”çš„å¯¹è±¡ã€‚
<br>
<br><font color=blue size = 4>recursive_mutex</font>
<br> â— é€’å½’é”åŸºæœ¬å‡½æ•°åŒä¸Šï¼Œåªæ˜¯std::recursive_mutex å…è®¸åŒä¸€ä¸ªçº¿ç¨‹å¯¹äº’æ–¥é‡å¤šæ¬¡ä¸Šé”ï¼ˆå³é€’å½’ä¸Šé”ï¼‰ï¼Œæ¥è·å¾—å¯¹äº’æ–¥é‡å¯¹è±¡çš„å¤šå±‚æ‰€æœ‰æƒï¼Œstd::recursive_mutex é‡Šæ”¾äº’æ–¥é‡æ—¶éœ€è¦è°ƒç”¨ä¸è¯¥é”å±‚æ¬¡æ·±åº¦ç›¸åŒæ¬¡æ•°çš„ unlock()ã€‚
<br>
<br><font color=blue size = 4>timed_mutex</font>
<br>timed_mutexé”æ¯”è¾ƒmutexæ‰€å¤šäº†ä¸¤ä¸ªæˆå‘˜å‡½æ•°try_lock_for å’Œ try_lock_untilã€‚
<br> â— try_lock_for ï¼šä¼ å…¥æ—¶é—´æ®µï¼Œåœ¨æ—¶é—´èŒƒå›´å†…æœªè·å¾—æ‰€å°±é˜»å¡ä½çº¿ç¨‹ï¼Œå¦‚æœåœ¨æ­¤æœŸé—´å…¶ä»–çº¿ç¨‹é‡Šæ”¾äº†é”ï¼Œåˆ™è¯¥çº¿ç¨‹å¯ä»¥è·å¾—å¯¹äº’æ–¥é‡çš„é”ï¼Œå¦‚æœè¶…æ—¶ï¼Œåˆ™è¿”å› false
<br> â— try_lock_until ï¼šåŒä¸Šï¼Œåªæ˜¯ä¼ å…¥å‚æ•°ä¸ºä¸€ä¸ªæœªæ¥çš„ä¸€ä¸ªæ—¶é—´ç‚¹ã€‚
<br>
<br><font color=blue size = 4>recursive_timed_mutex</font>
<br> â— é€’å½’çš„æ—¶é—´é”ï¼Œå…è®¸åŒä¸€ä¸ªçº¿ç¨‹å¯¹äº’æ–¥é‡å¤šæ¬¡ä¸Šé”ï¼ˆå³é€’å½’ä¸Šé”ï¼‰
<br> ğŸ“ ç¨‹åºç¤ºä¾‹ï¼š
<br><div style="width:100%;border:1px #e3e3e3 solid;"><div style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;border-bottom:1px solid #e3e3e3;margin-top:5px;color:#000000;">&nbsp;C++ Code&nbsp;</div><table style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;vertical-align:text-top;line-height:15px;" border="0" cellspacing="0" cellpadding="0"><tr><td style="color:#008284;background-color:#e3e3e3;vertical-align:text-top;"><div style="margin:7px;text-align:right;white-space:nowrap;"><nobr>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44<br>45<br>46<br>47<br>48<br>49<br>50<br>51<br>52<br>53<br>54<br>55<br>56<br>57<br>58<br>59<br>60<br>61<br>62<br>63<br>64<br></nobr></div></td><td style="background-color:#008284;padding:1px;"><div style="border:1px #008284 solid;"></div></td><td style="background-color:#efefef;width:100%;vertical-align:text-top;color:#000000;"><div style="margin:7px;"><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;iostream&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;thread&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;chrono&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;mutex&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;ctime&gt;<BR>
</span><span style="color:#0000ff;">using</span><span style="color:#000000;">&nbsp;</span><span style="color:#0000ff;">namespace</span><span style="color:#000000;">&nbsp;std;<BR>
<BR>
timed_mutex&nbsp;mtx;<BR>
timed_mutex&nbsp;cinderella;<BR>
<BR>
</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;fn()<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">while</span><span style="color:#000000;">&nbsp;(!mtx.try_lock_for(chrono::milliseconds(</span><span style="color:#ff0000;">2</span><span style="color:#000000;">)))<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;.&quot;</span><span style="color:#000000;">;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;this_thread::sleep_for(chrono::milliseconds(</span><span style="color:#ff0000;">100</span><span style="color:#000000;">));<BR>
&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;*\n&quot;</span><span style="color:#000000;">;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;mtx.unlock();<BR>
}<BR>
<BR>
chrono::time_point&lt;chrono::system_clock&gt;&nbsp;midnight()<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">using</span><span style="color:#000000;">&nbsp;chrono::system_clock;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;time_t&nbsp;tt&nbsp;=&nbsp;system_clock::to_time_t(system_clock::now());<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">struct</span><span style="color:#000000;">&nbsp;std::tm*&nbsp;ptm&nbsp;=&nbsp;std::localtime(&amp;tt);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;++ptm-&gt;tm_mday;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;ptm-&gt;tm_hour&nbsp;=&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;ptm-&gt;tm_min&nbsp;=&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;ptm-&gt;tm_sec&nbsp;=&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;system_clock::from_time_t(mktime(ptm));<BR>
}<BR>
<BR>
</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;carriage()&nbsp;<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(cinderella.try_lock_until(midnight()))<BR>
&nbsp;&nbsp;&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;ride&nbsp;back&nbsp;home&nbsp;on&nbsp;carriage\n&quot;</span><span style="color:#000000;">;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cinderella.unlock();<BR>
&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">else</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;carriage&nbsp;reverts&nbsp;to&nbsp;pumpkin\n&quot;</span><span style="color:#000000;">;<BR>
}<BR>
<BR>
</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;ball()<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;cinderella.lock();<BR>
&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;call&nbsp;the&nbsp;ball()...\n&quot;</span><span style="color:#000000;">;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;cinderella.unlock();<BR>
}<BR>
<BR>
</span><span style="color:#0000ff;">auto</span><span style="color:#000000;">&nbsp;main()&nbsp;-&gt;&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;"><BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;thread&nbsp;th[</span><span style="color:#ff0000;">10</span><span style="color:#000000;">];<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">for</span><span style="color:#000000;">&nbsp;(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;i&nbsp;=&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;&nbsp;i&nbsp;&lt;&nbsp;</span><span style="color:#ff0000;">10</span><span style="color:#000000;">;&nbsp;++i)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;th[i]&nbsp;=&nbsp;thread(fn);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">for</span><span style="color:#000000;">&nbsp;(</span><span style="color:#0000ff;">auto</span><span style="color:#000000;">&amp;&nbsp;th&nbsp;:&nbsp;th)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;th.join();<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;thread&nbsp;th0(ball);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;thread&nbsp;th1(carriage);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;th0.join();<BR>
&nbsp;&nbsp;&nbsp;&nbsp;th1.join();<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;<BR>
}</span></div></td></tr></table></div>
<br>
<br><font color=green size = 5>Locks æ¨¡æ¿ç±»</font>
<table border="4">
<tr>
<th> åç§° </th>
<th> æ„ä¹‰ </th>
<th> ç±»å‹ </th>
</tr>
<tr>
<td> lock_guard </td>
<td> Lock guard(class template ) </td>
<td> æ¨¡æ¿ç±» </td>
</tr>
<tr>
<td> unique_lock </td>
<td> Unique lock (class template ) </td>
<td> æ¨¡æ¿ç±» </td>
</tr>
</table>
<br><font color=blue size = 5>lock_guard</font>
<br> â— å®šä¹‰ï¼š template <class Mutex> class lock_guard;
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ¨¡æ¿å‚æ•°Mutexä»£è¡¨äº’æ–¥é‡ï¼Œå¯ä»¥æ˜¯ä¸Šä¸€ç¯‡ä»‹ç»çš„std::mutex, std::timed_mutex, std::recursive_mutex, std::recursive_timed_mutexä¸­çš„ä»»ä½•ä¸€ä¸ªï¼Œä¹Ÿå¯ä»¥æ˜¯std::unique_lock(ä¸‹é¢å³å°†ä»‹ç»)ï¼Œè¿™äº›éƒ½æä¾›äº†lockå’Œunlockçš„èƒ½åŠ›
<br> â— é”ä¿æŠ¤æ˜¯ä¸€ä¸ªé€šè¿‡å°†äº’æ–¥å¯¹è±¡ä¿æŒé”å®šæ¥ç®¡ç†äº’æ–¥å¯¹è±¡çš„å¯¹è±¡ï¼›
<br> â— åœ¨æ„é€ ä¸Šï¼Œäº’æ–¥å¯¹è±¡è¢«è°ƒç”¨çº¿ç¨‹é”å®šï¼Œå¹¶ä¸”åœ¨é”€æ¯æ—¶ï¼Œäº’æ–¥é”è¢«è§£é”ï¼Œå®ƒæ˜¯æœ€ç®€å•çš„é”ï¼Œä½œä¸ºå…·æœ‰è‡ªåŠ¨æŒç»­æ—¶é—´çš„å¯¹è±¡ç‰¹åˆ«æœ‰ç”¨ï¼Œç›´åˆ°å®ƒçš„ä¸Šä¸‹æ–‡ç»“æŸï¼Œè¿™æ ·ï¼Œå®ƒä¿è¯åœ¨æŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œå¯ä»¥æ­£ç¡®åœ°é”å®šäº’æ–¥å¯¹è±¡ï¼›
<br> â— æ³¨ï¼šlock_guardå¯¹è±¡ä¸ä»¥ä»»ä½•æ–¹å¼ç®¡ç†äº’æ–¥å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œäº’æ–¥å¯¹è±¡çš„æŒç»­æ—¶é—´è‡³å°‘è¦å»¶é•¿åˆ°é”å®šå®ƒçš„lock_guardçš„é”€æ¯ä¸ºæ­¢ï¼›
<br> â— lock_guardä»…ç”¨äºä¸Šé”ã€è§£é”ï¼Œä¸å¯¹mutexæ‰¿æ‹…ä¾›ä»»ä½•ç”Ÿå‘¨æœŸçš„ç®¡ç†ï¼Œå› æ­¤åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œè¯·ç¡®ä¿lock_guardç®¡ç†çš„mutexä¸€ç›´æœ‰æ•ˆï¼›
<br> â— åŒå…¶å®ƒmutexç±»ä¸€æ ·ï¼Œlocak_guardä¸å…è®¸æ‹·è´ï¼Œå³æ‹·è´æ„é€ å’Œèµ‹å€¼å‡½æ•°è¢«å£°æ˜ä¸ºdeleteã€‚
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lock_guard(lock_guard const&amp;) = delete;
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lock_guard&amp; operator=(lock_guard const&amp;) = delete;
<br> â— lock_guardçš„è®¾è®¡ä¿è¯äº†å³ä½¿ç¨‹åºåœ¨é”å®šæœŸé—´å‘ç”Ÿäº†å¼‚å¸¸ï¼Œä¹Ÿä¼šå®‰å…¨çš„é‡Šæ”¾é”ï¼Œä¸ä¼šå‘ç”Ÿæ­»é”
<br>
<br><font color=purple size = 4>æ„é€ å‡½æ•°(constructor)</font>
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;locking (1) explicit lock_guard (mutex_type&amp; m);
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;adopting (2) lock_guard (mutex_type&amp; m, adopt_lock_t tag);
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;copy deleted lock_guard (const lock_guard&amp;) = delete;
<br> (1) é”å®šåˆå§‹åŒ–ï¼šå¯¹è±¡ç®¡ç†mï¼Œå¹¶é€šè¿‡è°ƒç”¨m.lock()é”å®šå®ƒ
<br> (2) é‡‡ç”¨åˆå§‹åŒ–ï¼šå¯¹è±¡ç®¡ç†mï¼Œå®ƒæ˜¯å½“å‰å·²ç»è¢«æ„é€ çº¿ç¨‹é”å®šçš„äº’æ–¥å¯¹è±¡
<br> (3) å¤åˆ¶æ„é€ ï¼šåˆ é™¤ (lock_guardå¯¹è±¡ä¸èƒ½è¢«å¤åˆ¶/ç§»åŠ¨)
<br>æ³¨ï¼šlock_guardçš„å¯¹è±¡ä¿æŒé”å®šå¹¶ç®¡ç†m (é€šè¿‡è°ƒç”¨å®ƒçš„æˆå‘˜è§£é”) æ¥è§£é”å®ƒï¼Œå½“lock_guardçš„å¯¹è±¡ææ„çš„æ—¶å€™ï¼Œmtxå°†ä¼šè¢«è§£é”ã€‚
<br> ğŸ“ ç¨‹åºç¤ºä¾‹ï¼š
<br><div style="width:100%;border:1px #e3e3e3 solid;"><div style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;border-bottom:1px solid #e3e3e3;margin-top:5px;color:#000000;">&nbsp;C++ Code&nbsp;</div><table style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;vertical-align:text-top;line-height:15px;" border="0" cellspacing="0" cellpadding="0"><tr><td style="color:#008284;background-color:#e3e3e3;vertical-align:text-top;"><div style="margin:7px;text-align:right;white-space:nowrap;"><nobr>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br></nobr></div></td><td style="background-color:#008284;padding:1px;"><div style="border:1px #008284 solid;"></div></td><td style="background-color:#efefef;width:100%;vertical-align:text-top;color:#000000;"><div style="margin:7px;"><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;iostream&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;mutex&gt;<BR>
<BR>
std::mutex&nbsp;mutex;<BR>
<BR>
</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;safe_thread()&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">try</span><span style="color:#000000;">&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;std::lock_guard&lt;std::mutex&gt;&nbsp;_guard(mutex);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">throw</span><span style="color:#000000;">&nbsp;std::logic_error(</span><span style="color:#800000;">&quot;logic&nbsp;error&quot;</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;</span><span style="color:#0000ff;">catch</span><span style="color:#000000;">&nbsp;(std::exception&nbsp;&amp;ex)&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;std::cerr&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;[caught]&nbsp;&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;ex.what()&nbsp;&lt;&lt;&nbsp;std::endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
}<BR>
</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;main()&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;safe_thread();<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;æ­¤å¤„ä»èƒ½ä¸Šé”<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;mutex.lock();<BR>
&nbsp;&nbsp;&nbsp;&nbsp;std::cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;OK,&nbsp;still&nbsp;locked&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;std::endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;mutex.unlock();<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;<BR>
}<BR>
<BR>
</span><span style="color:#008000;">//&nbsp;ç¨‹åºè¾“å‡º<BR>
</span><span style="color:#000000;">[caught]&nbsp;logic&nbsp;error<BR>
OK,&nbsp;still&nbsp;locked<BR>
<BR>
</span><span style="color:#008000;">//&nbsp;lock_guardçš„è®¾è®¡ä¿è¯äº†å³ä½¿ç¨‹åºåœ¨é”å®šæœŸé—´å‘ç”Ÿäº†å¼‚å¸¸<BR>
//&nbsp;ä¹Ÿä¼šå®‰å…¨çš„é‡Šæ”¾é”ï¼Œä¸ä¼šå‘ç”Ÿæ­»é”</span></div></td></tr></table></div>
<br><div style="width:100%;border:1px #e3e3e3 solid;"><div style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;border-bottom:1px solid #e3e3e3;margin-top:5px;color:#000000;">&nbsp;C++ Code&nbsp;</div><table style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;vertical-align:text-top;line-height:15px;" border="0" cellspacing="0" cellpadding="0"><tr><td style="color:#008284;background-color:#e3e3e3;vertical-align:text-top;"><div style="margin:7px;text-align:right;white-space:nowrap;"><nobr>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br></nobr></div></td><td style="background-color:#008284;padding:1px;"><div style="border:1px #008284 solid;"></div></td><td style="background-color:#efefef;width:100%;vertical-align:text-top;color:#000000;"><div style="margin:7px;"><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;iostream&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;thread&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;chrono&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;mutex&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;ctime&gt;<BR>
<BR>
mutex&nbsp;mtx;<BR>
<BR>
</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;print_thread_id(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;id)<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;mtx.lock();<BR>
&nbsp;&nbsp;&nbsp;&nbsp;lock_guard&lt;mutex&gt;&nbsp;lck(mtx,&nbsp;adopt_lock);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;thread&nbsp;#&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;id&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;\n&quot;</span><span style="color:#000000;">;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;this_thread::sleep_for(chrono::milliseconds(</span><span style="color:#ff0000;">1000</span><span style="color:#000000;">));<BR>
}<BR>
<BR>
</span><span style="color:#0000ff;">auto</span><span style="color:#000000;">&nbsp;main()&nbsp;-&gt;&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;"><BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;thread&nbsp;threads[</span><span style="color:#ff0000;">10</span><span style="color:#000000;">];<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">for</span><span style="color:#000000;">&nbsp;(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;i&nbsp;=&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;&nbsp;i&nbsp;&lt;&nbsp;</span><span style="color:#ff0000;">10</span><span style="color:#000000;">;&nbsp;++i)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;threads[i]&nbsp;=&nbsp;thread(print_thread_id,&nbsp;i&nbsp;+&nbsp;</span><span style="color:#ff0000;">1</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">for</span><span style="color:#000000;">&nbsp;(</span><span style="color:#0000ff;">auto</span><span style="color:#000000;">&amp;&nbsp;th&nbsp;:&nbsp;threads)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;th.join();<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;<BR>
}<BR>
<BR>
</span><span style="color:#008000;">//&nbsp;è¾“å‡º&nbsp;ç¨‹åºæ¯éš”ä¸€ç§’é’Ÿæ‰“å°ä¸€æ¬¡&nbsp;threa#(id)</span></div></td></tr></table></div>
<br><font color=blue size = 5>unique_lock</font>
<br> â— å®šä¹‰ï¼š template <class Mutex> class unique_lock;
<br> â— lock_guardæä¾›äº†ç®€å•ä¸Šé”ã€è§£é”æ“ä½œï¼Œä½†å½“æˆ‘ä»¬éœ€è¦æ›´çµæ´»çš„æ“ä½œæ—¶ä¾¿æ— èƒ½ä¸ºåŠ›äº†ï¼Œè¿™æ—¶unique_lockä¾¿å‡ºåœºäº†ï¼›
<br> â— unique_lock å¯¹è±¡ä»¥ç‹¬å æ‰€æœ‰æƒçš„æ–¹å¼(å®˜æ–¹å«åšunique ownership)ç®¡ç† mutex å¯¹è±¡çš„ä¸Šé”å’Œè§£é”æ“ä½œï¼›ç‹¬å æ‰€æœ‰æƒï¼Œå°±æ˜¯æ²¡æœ‰å…¶ä»–çš„ unique_lock å¯¹è±¡åŒæ—¶æ‹¥æœ‰æŸä¸ª mutex å¯¹è±¡çš„æ‰€æœ‰æƒ (unique_lockæ‹¥æœ‰å¯¹Mutexçš„æ‰€æœ‰æƒï¼Œä¸€ä½†åˆå§‹åŒ–äº†unique_lockï¼Œå…¶å°±æ¥ç®¡äº†è¯¥mutexï¼Œåœ¨unique_lockç»“æŸç”Ÿå‘½å‘¨æœŸå‰(ææ„å‰)ï¼Œå…¶å®ƒåœ°æ–¹å°±ä¸è¦å†ç›´æ¥ä½¿ç”¨è¯¥mutexäº†)ï¼›
<br> â— unique_lockå¯¹è±¡åœ¨ææ„çš„æ—¶å€™ä¸€å®šä¿è¯äº’æ–¥é‡ä¸ºè§£é”çŠ¶æ€ï¼Œå› æ­¤å®ƒä½œä¸ºå…·æœ‰è‡ªåŠ¨æŒç»­æ—¶é—´çš„å¯¹è±¡ç‰¹åˆ«æœ‰ç”¨ï¼Œå› ä¸ºå®ƒä¿è¯åœ¨æŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œäº’æ–¥å¯¹è±¡è¢«æ­£ç¡®åœ°è§£é”ï¼›
<br> â— æ³¨ï¼šunique_lockå¯¹è±¡å¹¶ä¸ä»¥ä»»ä½•æ–¹å¼ç®¡ç†äº’æ–¥å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼šäº’æ–¥å¯¹è±¡çš„æŒç»­æ—¶é—´å°†å»¶é•¿è‡³å°‘ç›´åˆ°unique_lockç®¡ç†å®ƒçš„æ¯ç­ã€‚
<br>
<br><font color=purple size = 4>æ„é€ å‡½æ•°(constructor)</font>
<br><div style="width:100%;border:1px #e3e3e3 solid;"><div style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;border-bottom:1px solid #e3e3e3;margin-top:5px;color:#000000;">&nbsp;C++ Code&nbsp;</div><table style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;vertical-align:text-top;line-height:15px;" border="0" cellspacing="0" cellpadding="0"><tr><td style="color:#008284;background-color:#e3e3e3;vertical-align:text-top;"><div style="margin:7px;text-align:right;white-space:nowrap;"><nobr>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br></nobr></div></td><td style="background-color:#008284;padding:1px;"><div style="border:1px #008284 solid;"></div></td><td style="background-color:#efefef;width:100%;vertical-align:text-top;color:#000000;"><div style="margin:7px;"><span style="color:#0000ff;">default</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(</span><span style="color:#ff0000;">1</span><span style="color:#000000;">)&nbsp;&nbsp;&nbsp;&nbsp;unique_lock()&nbsp;noexcept;<BR>
locking&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(</span><span style="color:#ff0000;">2</span><span style="color:#000000;">)&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">explicit</span><span style="color:#000000;">&nbsp;unique_lock&nbsp;(mutex_type&nbsp;&amp;m);<BR>
</span><span style="color:#0000ff;">try</span><span style="color:#000000;">&nbsp;-&nbsp;locking&nbsp;&nbsp;&nbsp;(</span><span style="color:#ff0000;">3</span><span style="color:#000000;">)&nbsp;&nbsp;&nbsp;&nbsp;unique_lock&nbsp;(mutex_type&nbsp;&amp;m,&nbsp;try_to_lock_t&nbsp;tag);<BR>
deferred&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(</span><span style="color:#ff0000;">4</span><span style="color:#000000;">)&nbsp;&nbsp;&nbsp;&nbsp;unique_lock&nbsp;(mutex_type&nbsp;&amp;m,&nbsp;defer_lock_t&nbsp;tag)&nbsp;noexcept;<BR>
adopting&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(</span><span style="color:#ff0000;">5</span><span style="color:#000000;">)&nbsp;&nbsp;&nbsp;&nbsp;unique_lock&nbsp;(mutex_type&nbsp;&amp;m,&nbsp;adopt_lock_t&nbsp;tag);<BR>
locking&nbsp;</span><span style="color:#0000ff;">for</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;(</span><span style="color:#ff0000;">6</span><span style="color:#000000;">)&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">template</span><span style="color:#000000;">&nbsp;&lt;</span><span style="color:#0000ff;">class</span><span style="color:#000000;">&nbsp;Rep,&nbsp;</span><span style="color:#0000ff;">class</span><span style="color:#000000;">&nbsp;Period&gt;<BR>
unique_lock&nbsp;(mutex_type&nbsp;&amp;m,&nbsp;</span><span style="color:#0000ff;">const</span><span style="color:#000000;">&nbsp;chrono::duration&lt;Rep,&nbsp;Period&gt;&nbsp;&amp;rel_time);<BR>
locking&nbsp;until&nbsp;(</span><span style="color:#ff0000;">7</span><span style="color:#000000;">)&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">template</span><span style="color:#000000;">&nbsp;&lt;</span><span style="color:#0000ff;">class</span><span style="color:#000000;">&nbsp;Clock,&nbsp;</span><span style="color:#0000ff;">class</span><span style="color:#000000;">&nbsp;Duration&gt;<BR>
unique_lock&nbsp;(mutex_type&nbsp;&amp;m,&nbsp;</span><span style="color:#0000ff;">const</span><span style="color:#000000;">&nbsp;chrono::time_point&lt;Clock,&nbsp;Duration&gt;&nbsp;&amp;abs_time);<BR>
copy&nbsp;[deleted]&nbsp;(</span><span style="color:#ff0000;">8</span><span style="color:#000000;">)&nbsp;&nbsp;unique_lock&nbsp;(</span><span style="color:#0000ff;">const</span><span style="color:#000000;">&nbsp;unique_lock&nbsp;&amp;)&nbsp;=&nbsp;</span><span style="color:#0000ff;">delete</span><span style="color:#000000;">;<BR>
move&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(</span><span style="color:#ff0000;">9</span><span style="color:#000000;">)&nbsp;&nbsp;&nbsp;&nbsp;unique_lock&nbsp;(unique_lock&nbsp;&amp;&amp;x);</span></div></td></tr></table></div>
<br>(1) é»˜è®¤æ„é€ å‡½æ•°ï¼šunique_lock å¯¹è±¡ä¸ç®¡ç†ä»»ä½• Mutex å¯¹è±¡m
<br>
<br>(2) lockingåˆå§‹åŒ–
<br>unique_lock å¯¹è±¡ç®¡ç†Mutexå¯¹è±¡mï¼Œå¹¶è°ƒç”¨m.lock()å¯¹Mutexå¯¹è±¡è¿›è¡Œä¸Šé”ï¼Œå¦‚æœå…¶å®ƒunique_lock()å¯¹è±¡å·²ç»ç®¡ç†äº†mï¼Œè¯¥çº¿ç¨‹å°†ä¼šè¢«é˜»å¡
<br>
<br>(3) try-locking åˆå§‹åŒ–
<br>unique_lock å¯¹è±¡ç®¡ç†Mutexå¯¹è±¡mï¼Œå¹¶è°ƒç”¨m.try_lock()å¯¹Mutexå¯¹è±¡è¿›è¡Œä¸Šé”ï¼Œä½†å¦‚æœä¸Šé”ä¸æˆåŠŸï¼Œä¸ä¼šé˜»å¡å½“å‰çº¿ç¨‹
<br>
<br>(4) deferred åˆå§‹åŒ–
<br>unique_lockå¯¹è±¡ç®¡ç†Mutexå¯¹è±¡må¹¶ä¸é”ä½mï¼Œmæ˜¯ä¸€ä¸ªæ²¡æœ‰è¢«å½“å‰çº¿ç¨‹é”ä½çš„Mutex
å¯¹è±¡
<br>
<br>(5) adopting åˆå§‹åŒ–
<br>unique_lock å¯¹è±¡ç®¡ç†Mutexå¯¹è±¡mï¼Œmåº”è¯¥æ˜¯ä¸€ä¸ªå·²ç»è¢«å½“å‰çº¿ç¨‹é”ä½çš„Mutexå¯¹è±¡ (å½“å‰unique_lockå¯¹è±¡æ‹¥æœ‰å¯¹é”(lock)çš„æ‰€æœ‰æƒ)
<br>
<br>(6) locking ä¸€æ®µæ—¶é—´ (duration)
<br>æ–°åˆ›å»ºçš„unique_lockå¯¹è±¡ç®¡ç†Mutexå¯¹è±¡mï¼Œé€šè¿‡è°ƒç”¨m.try_lock_for(rel_time)æ¥é”ä½Mutexå¯¹è±¡ä¸€æ®µæ—¶é—´(rel_time)
<br>
<br>(7) locking ç›´åˆ°æŸä¸ªæ—¶é—´ç‚¹ (time point)
<br>æ–°åˆ›å»ºçš„unique_lockå¯¹è±¡ç®¡ç†Mutexå¯¹è±¡mï¼Œé€šè¿‡è°ƒç”¨m.try_lock_until(abs_time)å°†åœ¨æŸä¸ªæ—¶é—´ç‚¹(abs_time)ä¹‹å‰é”ä½Mutexå¯¹è±¡
<br>
<br>(8) æ‹·è´æ„é€ [è¢«ç¦ç”¨]ï¼šunique_lock å¯¹è±¡ä¸èƒ½è¢«æ‹·è´æ„é€ 
<br>
<br>(9) ç§»åŠ¨(move)æ„é€ 
<br>æ–°åˆ›å»ºçš„unique_lockå¯¹è±¡è·å¾—äº†ç”±xæ‰€ç®¡ç†çš„Mutexå¯¹è±¡çš„æ‰€æœ‰æƒ(åŒ…æ‹¬å½“å‰Mutexçš„çŠ¶æ€)
<br>è°ƒç”¨moveæ„é€ ä¹‹åï¼Œx å¯¹è±¡å¦‚åŒé€šè¿‡é»˜è®¤æ„é€ å‡½æ•°æ‰€åˆ›å»ºçš„ï¼Œå°±ä¸å†ç®¡ç†ä»»ä½•Mutexå¯¹è±¡äº†
<br>
<br> ğŸ“ ç¨‹åºç¤ºä¾‹ï¼š
<br><div style="width:100%;border:1px #e3e3e3 solid;"><div style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;border-bottom:1px solid #e3e3e3;margin-top:5px;color:#000000;">&nbsp;C++ Code&nbsp;</div><table style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;vertical-align:text-top;line-height:15px;" border="0" cellspacing="0" cellpadding="0"><tr><td style="color:#008284;background-color:#e3e3e3;vertical-align:text-top;"><div style="margin:7px;text-align:right;white-space:nowrap;"><nobr>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44<br></nobr></div></td><td style="background-color:#008284;padding:1px;"><div style="border:1px #008284 solid;"></div></td><td style="background-color:#efefef;width:100%;vertical-align:text-top;color:#000000;"><div style="margin:7px;"><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;thread&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;atomic&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;chrono&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;mutex&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;ctime&gt;<BR>
</span><span style="color:#0000ff;">using</span><span style="color:#000000;">&nbsp;</span><span style="color:#0000ff;">namespace</span><span style="color:#000000;">&nbsp;std;<BR>
<BR>
mutex&nbsp;foo,&nbsp;bar;<BR>
<BR>
</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;task_a()<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;lock(foo,&nbsp;bar);&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;simultaneous&nbsp;lock&nbsp;(prevents&nbsp;deadlock)<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;unique_lock&lt;mutex&gt;&nbsp;lck1(foo,&nbsp;adopt_lock);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;unique_lock&lt;mutex&gt;&nbsp;lck2(bar,&nbsp;adopt_lock);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;task&nbsp;a\n&quot;</span><span style="color:#000000;">;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;(unlocked&nbsp;automatically&nbsp;on&nbsp;destruction&nbsp;of&nbsp;lck1&nbsp;and&nbsp;lck2)<BR>
</span><span style="color:#000000;">}<BR>
<BR>
</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;task_b()<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;unique_lock&lt;mutex&gt;&nbsp;lck1,&nbsp;lck2;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;lck1&nbsp;=&nbsp;unique_lock&lt;mutex&gt;(bar,&nbsp;defer_lock);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;lck2&nbsp;=&nbsp;unique_lock&lt;mutex&gt;(foo,&nbsp;defer_lock);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;lock(lck1,&nbsp;lck2);&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;simultaneous&nbsp;lock&nbsp;(prevents&nbsp;deadlock)<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;task&nbsp;b\n&quot;</span><span style="color:#000000;">;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;(unlocked&nbsp;automatically&nbsp;on&nbsp;destruction&nbsp;of&nbsp;lck1&nbsp;and&nbsp;lck2)<BR>
</span><span style="color:#000000;">}<BR>
<BR>
</span><span style="color:#0000ff;">auto</span><span style="color:#000000;">&nbsp;main()&nbsp;-&gt;&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;"><BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;thread&nbsp;th1(task_a);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;thread&nbsp;th2(task_b);<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;th1.join();<BR>
&nbsp;&nbsp;&nbsp;&nbsp;th2.join();<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;<BR>
}<BR>
<BR>
</span><span style="color:#008000;">//&nbsp;åˆå§‹åŒ–ç¬¬äºŒä¸ªå‚æ•°è§ä¸Šé¢åšæ–‡è¯´æ˜<BR>
</span><span style="color:#000000;"><BR>
</span><span style="color:#008000;">//&nbsp;ç¨‹åºè¾“å‡º<BR>
</span><span style="color:#000000;">task_a<BR>
task_b</span></div></td></tr></table></div>
<br><font color=purple size = 4>å…¶å®ƒæˆå‘˜å‡½æ•°</font>
<table border="4">
<tr>
<th>Lock/Unlock</th>
<th>åŠ é”å’Œè§£é”è¿‡ç¨‹</th>
<th>è¯´æ˜</th>
</tr>
<tr>
<td>lock</td>
<td>Lock mutex (public member function )</td>
<td>è°ƒç”¨è¢«æ‰˜ç®¡çš„äº’æ–¥å¯¹è±¡çš„æˆå‘˜é”</td>
</tr>
<tr>
<td>try_lock</td>
<td>Lock mutex if not locked (public ... )</td>
<td>å°è¯•ä¸Šé”</td>
</tr>
<tr>
<td>try_lock_for</td>
<td>Try to lock mutex during time span (public ... )</td>
<td>å°è¯•åœ¨æ—¶é—´æ®µä¸Šé”</td>
</tr>
<tr>
<td>try_lock_until</td>
<td>Try to lock mutex until time point (public ... )</td>
<td>å°è¯•åœ¨æ—¶é—´ç‚¹åˆ°ä¹‹å‰ä¸Šé”</td>
</tr>
<tr>
<td>unlock</td>
<td>Unlock mutex (public ... )</td>
<td>è§£é”</td>
</tr>
</table>
<table border="4">
<tr>
<br>
<th>Modifiers</th>
<th>ä¿®æ”¹</th>
<th>è¯´æ˜</th>
</tr>
<tr>
<td>operator=</td>
<td>Move-assign unique_lock (public member function )</td>
<td>åŒmoveæ“ä½œ</td>
</tr>
<tr>
<td>swap</td>
<td>Swap unique locks (public member function )</td>
<td>äº¤æ¢ä¸¤ä¸ªäº’æ–¥å¯¹è±¡</td>
</tr>
<tr>
<td>release</td>
<td>Release mutex (public member function )</td>
<td>é‡Šæ”¾é”</td>
</tr>
</table>
<br>
<table border="4">
<tr>
<th>Observers</th>
<th>è·å–æ“ä½œ</th>
</tr>
<tr>
<td>owns_lock</td>
<td>Owns lock (public member function )</td>
</tr>
<tr>
<td>lock</td>
<td>Return whether it owns a lock (public member function )</td>
</tr>
<tr>
<td>mutex</td>
<td>Get mutex (public member function )</td>
</tr>
</table>
<br> (1) std::unique_lock::lock
<br>é”å®šäº’æ–¥å¯¹è±¡ï¼Œè°ƒç”¨è¢«æ‰˜ç®¡çš„äº’æ–¥å¯¹è±¡çš„æˆå‘˜é”
<br>å¯¹å·²ç»è¢«å…¶ä»–çº¿ç¨‹é”å®šçš„äº’æ–¥å¯¹è±¡è°ƒç”¨é”ï¼Œé˜»å¡å½“å‰çº¿ç¨‹(ç­‰å¾…)ï¼Œç›´åˆ°é”é‡Šæ”¾
<br>å½“å‡½æ•°è¿”å›æ—¶ï¼Œå¯¹è±¡åœ¨äº’æ–¥é”ä¸Šæ‹¥æœ‰ä¸€ä¸ªé”ï¼Œå¦‚æœè°ƒç”¨é”å®šå¤±è´¥ï¼ŒæŠ›å‡ºsystem_errorå¼‚å¸¸
<br>
<br> (2) std::unique_lock::try_lock
<br>å¦‚æœäº’æ–¥é‡æ²¡æœ‰é”å®šå°±é”å®š
<br>è°ƒç”¨try_lockç®¡ç†mutexå¯¹è±¡ï¼Œå¹¶ä½¿ç”¨è¿”å›å€¼è®¾ç½®æ‹¥æœ‰çŠ¶æ€ï¼Œå¦‚æœæ‹¥æœ‰çš„çŠ¶æ€åœ¨è°ƒç”¨å‰ä¸ºçœŸæˆ–è€…å¦‚æœå¯¹è±¡ç›®å‰ç®¡ç†æ²¡æœ‰äº’æ–¥å¯¹è±¡ï¼Œå‡½æ•°æŠ›å‡ºä¸€ä¸ªsystem_errorå¼‚å¸¸
<br>
<br> (3) std::unique_lock::try_lock_for
<br>å®šä¹‰ï¼štemplate &lt;class Rep, class Period&gt;
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bool try_lock_for (const chrono::duration<Rep,Period>&amp; rel_time);
<br>åœ¨æ—¶é—´èŒƒå›´spanå†…é”å®šäº’æ–¥é”
<br>è°ƒç”¨try_lock_forç®¡ç†æ—¶é—´çš„mutexå¯¹è±¡ï¼Œå¹¶ä½¿ç”¨è¿”å›å€¼è®¾ç½®æ‹¥æœ‰çŠ¶æ€ï¼Œå¦‚æœåœ¨è°ƒç”¨ä¹‹å‰æ‹¥æœ‰çŠ¶æ€å·²ç»çœŸæˆ–è€…å¦‚æœå¯¹è±¡ç›®å‰ç®¡ç†æ²¡æœ‰äº’æ–¥å¯¹è±¡ï¼Œå‡½æ•°æŠ›å‡ºä¸€ä¸ªsystem_errorå¼‚å¸¸
<br>
<br> (4) std::unique_lock::try_lock_until
<br>åŒä¸Šé¢unique_lock::try_lock_foræè¿°ï¼Œä¼ å…¥ä¸€ä¸ªæ—¶é—´ç‚¹è€Œä¸æ˜¯æ—¶é—´æ®µ
<br>
<br> (5) std::unique_lock::unlock
<br>è°ƒç”¨unlockå¯¹æ‰˜ç®¡çš„mutexå¯¹è±¡è¿›è¡Œè§£é”ï¼Œå¹¶å°†æ‹¥æœ‰çš„çŠ¶æ€è®¾ç½®ä¸ºfalse
<br>å¦‚æœè°ƒç”¨ä¹‹å‰æ‹¥æœ‰çŠ¶æ€æ˜¯é”™è¯¯ï¼Œå‡½æ•°æŠ›å‡ºä¸€ä¸ªsystem_errorå¼‚å¸¸ä¸operation_not_permittedé”™è¯¯æ¡ä»¶
<br>
<br> (6) std::unique_lock::operator=
<br>å®šä¹‰ï¼šmove (1)    unique_lock&amp; operator= (unique_lock&amp;&amp; x) noexcept;
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;copy [deleted] (2) unique_lock&amp; operator= (const unique_lock&amp;) = delete;
<br>ä½¿ç”¨xçš„mutexå¯¹è±¡æ›¿æ¢æ‰å½“å‰å¯¹è±¡çš„mutexï¼ŒåŒæ—¶è·å–xçš„çŠ¶æ€
<br>æ›¿æ¢æ‰çš„xå°†ä¸å†æœ‰mutexå¯¹è±¡ï¼Œå¦‚æœå¯¹è±¡åœ¨è°ƒç”¨ä¹‹å‰å¯¹å…¶æ‰˜ç®¡çš„mutexå¯¹è±¡æ‹¥æœ‰ä¸€ä¸ªé”ï¼Œé‚£ä¹ˆå®ƒçš„è§£é”æˆå‘˜åœ¨è¢«æ›¿æ¢ä¹‹å‰å°±è¢«è°ƒç”¨äº†
<br>unique_lockå¯¹è±¡ä¸èƒ½è¢«å¤åˆ¶
<br>
<br> (7) std::unique_lock::swap
<br>ä¸xäº¤æ¢å†…å®¹ï¼ŒåŒ…æ‹¬æ‰˜ç®¡çš„äº’æ–¥å¯¹è±¡å’Œå®ƒä»¬å½“å‰æ‹¥æœ‰çš„çŠ¶æ€
<br>
<br> (8) std::unique_lock::release
<br>è¿”å›ä¸€ä¸ªæŒ‡å‘æ‰˜ç®¡çš„äº’æ–¥å¯¹è±¡çš„æŒ‡é’ˆï¼Œå¹¶é‡Šæ”¾å¯¹å®ƒçš„æ‰€æœ‰æƒ
<br>è°ƒç”¨åunique_lockä¸å†ç®¡ç†mutexå¯¹è±¡(åƒé»˜è®¤æ„é€ ä¸€æ ·)
<br>æ³¨ï¼šè¯¥å‡½æ•°ä¸ä¼šé”å®šæˆ–é‡Šæ”¾è¿”å›çš„äº’æ–¥å¯¹è±¡
<br>
<br> (9) std::unique_lock::owns_lock
<br>è¿”å›unique_lockå¯¹è±¡æ‹¥æœ‰çš„ä¸€ä¸ªé”
<br>unique_locké”å®šä¸€ä¸ªmutexï¼Œåœ¨æ²¡æœ‰è§£é”æˆ–è€…é‡Šæ”¾unique_lockä¹‹å‰è¿”å›ä¸ºçœŸï¼Œå…¶ä»–æƒ…å†µè¿”å›ä¸ºå‡
<br>æ˜¯unique_lock::operator boolçš„åˆ«å
<br>
<br> (10) std::unique_lock::operator bool
<br>åŒä¸Š std::unique_lock::owns_lock
<br>
<br> (11) std::unique_lock::mutex
<br>è¿”å›ä¸€ä¸ªæŒ‡å‘æ‰˜ç®¡çš„mutexå¯¹è±¡çš„æŒ‡é’ˆ
<br>unique_lockä¸é‡Šæ”¾äº’æ–¥å¯¹è±¡ç®¡ç†çš„æ‰€æœ‰æƒï¼Œå¦‚æœå®ƒæ‹¥æœ‰ä¸€ä¸ªäº’æ–¥é”,å®ƒä»ç„¶æ˜¯è´Ÿè´£é‡Šæ”¾å®ƒåœ¨æŸä¸€æ—¶åˆ»(åƒå½“unique_lockè¢«é”€æ¯çš„æ—¶å€™)
<br>
<br> ğŸ“ ç¼–ç¨‹ç¤ºä¾‹ï¼š
<br><div style="width:100%;border:1px #e3e3e3 solid;"><div style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;border-bottom:1px solid #e3e3e3;margin-top:5px;color:#000000;">&nbsp;C++ Code&nbsp;</div><table style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;vertical-align:text-top;line-height:15px;" border="0" cellspacing="0" cellpadding="0"><tr><td style="color:#008284;background-color:#e3e3e3;vertical-align:text-top;"><div style="margin:7px;text-align:right;white-space:nowrap;"><nobr>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44<br>45<br>46<br>47<br>48<br>49<br>50<br>51<br>52<br>53<br>54<br>55<br>56<br>57<br>58<br>59<br>60<br>61<br>62<br>63<br>64<br>65<br>66<br>67<br>68<br>69<br>70<br>71<br>72<br>73<br>74<br>75<br>76<br>77<br>78<br>79<br>80<br>81<br>82<br>83<br>84<br>85<br>86<br>87<br>88<br>89<br>90<br>91<br>92<br>93<br>94<br>95<br>96<br>97<br>98<br>99<br>100<br>101<br>102<br>103<br>104<br>105<br>106<br>107<br>108<br>109<br>110<br>111<br>112<br>113<br>114<br>115<br>116<br>117<br>118<br>119<br>120<br>121<br>122<br>123<br>124<br>125<br>126<br>127<br>128<br>129<br>130<br>131<br>132<br>133<br>134<br>135<br>136<br>137<br>138<br>139<br></nobr></div></td><td style="background-color:#008284;padding:1px;"><div style="border:1px #008284 solid;"></div></td><td style="background-color:#efefef;width:100%;vertical-align:text-top;color:#000000;"><div style="margin:7px;"><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;iostream&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;vector&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;thread&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;atomic&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;chrono&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;mutex&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;ctime&gt;<BR>
</span><span style="color:#0000ff;">using</span><span style="color:#000000;">&nbsp;</span><span style="color:#0000ff;">namespace</span><span style="color:#000000;">&nbsp;std;<BR>
<BR>
mutex&nbsp;mtx;<BR>
timed_mutex&nbsp;tmtx;<BR>
</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;count&nbsp;=&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;<BR>
<BR>
</span><span style="color:#0000ff;">class</span><span style="color:#000000;">&nbsp;MyMutex&nbsp;:</span><span style="color:#0000ff;">public</span><span style="color:#000000;">&nbsp;mutex<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;_id;<BR>
</span><span style="color:#0000ff;">public</span><span style="color:#000000;">:<BR>
&nbsp;&nbsp;&nbsp;&nbsp;MyMutex(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;id)&nbsp;:_id(id){}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;id()&nbsp;{&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;_id;&nbsp;}<BR>
};<BR>
<BR>
MyMutex&nbsp;mytx(</span><span style="color:#ff0000;">101</span><span style="color:#000000;">);<BR>
<BR>
</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;print_thread_id(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;id)<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;unique_lock&lt;mutex&gt;&nbsp;lck(mtx,&nbsp;defer_lock);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;lck.lock();<BR>
&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;thread&nbsp;#&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;id&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;\n&quot;</span><span style="color:#000000;">;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;lck.unlock();<BR>
}<BR>
<BR>
</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;print_star()<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;unique_lock&lt;mutex&gt;&nbsp;lck(mtx,&nbsp;defer_lock);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(lck.try_lock())<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;*&quot;</span><span style="color:#000000;">;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">else</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;x&quot;</span><span style="color:#000000;">;<BR>
}<BR>
<BR>
</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;fireworks()<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;unique_lock&lt;timed_mutex&gt;&nbsp;lck(tmtx,&nbsp;defer_lock);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">while</span><span style="color:#000000;">&nbsp;(!lck.try_lock_for(chrono::milliseconds(</span><span style="color:#ff0000;">200</span><span style="color:#000000;">)))<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;-&quot;</span><span style="color:#000000;">;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;this_thread::sleep_for(chrono::milliseconds(</span><span style="color:#ff0000;">1000</span><span style="color:#000000;">));<BR>
&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;*\n&quot;</span><span style="color:#000000;">;<BR>
}<BR>
<BR>
</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;print_fifty(</span><span style="color:#8000ff;">char</span><span style="color:#000000;">&nbsp;c)<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;unique_lock&lt;mutex&gt;&nbsp;lck;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;lck&nbsp;=&nbsp;unique_lock&lt;mutex&gt;(mtx);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">for</span><span style="color:#000000;">&nbsp;(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;i&nbsp;=&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;&nbsp;i&nbsp;&lt;&nbsp;</span><span style="color:#ff0000;">50</span><span style="color:#000000;">;&nbsp;++i)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;c;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;\n&quot;</span><span style="color:#000000;">;<BR>
}<BR>
<BR>
</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;print_count_and_unlock(mutex*&nbsp;p_mtx)<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;count:&nbsp;&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;::count&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;\n&quot;</span><span style="color:#000000;">;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;p_mtx-&gt;unlock();<BR>
}<BR>
<BR>
</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;task()<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;unique_lock&lt;mutex&gt;&nbsp;lck(mtx);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;++::count;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;print_count_and_unlock(lck.release());<BR>
}<BR>
<BR>
</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;print_star2()<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;unique_lock&lt;mutex&gt;&nbsp;lck(mtx,&nbsp;try_to_lock);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(lck.owns_lock())<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;*&quot;</span><span style="color:#000000;">;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">else</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;x&quot;</span><span style="color:#000000;">;<BR>
}<BR>
<BR>
</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;print_ids(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;id)<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;unique_lock&lt;MyMutex&gt;&nbsp;lck(mytx);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;thread&nbsp;#&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;id&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;&nbsp;lock&nbsp;mutex&nbsp;&quot;</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;&lt;&nbsp;lck.mutex()-&gt;id()&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;\n&quot;</span><span style="color:#000000;">;<BR>
}<BR>
<BR>
</span><span style="color:#0000ff;">auto</span><span style="color:#000000;">&nbsp;main()&nbsp;-&gt;&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;"><BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;unique_lock::lock&nbsp;unique_lock::unlock&nbsp;ç¤ºä¾‹<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;thread&nbsp;threads[</span><span style="color:#ff0000;">10</span><span style="color:#000000;">];<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">for</span><span style="color:#000000;">&nbsp;(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;i&nbsp;=&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;&nbsp;i&nbsp;&lt;&nbsp;</span><span style="color:#ff0000;">10</span><span style="color:#000000;">;&nbsp;++i)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;threads[i]&nbsp;=&nbsp;thread(print_thread_id,&nbsp;i&nbsp;+&nbsp;</span><span style="color:#ff0000;">1</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">for</span><span style="color:#000000;">&nbsp;(</span><span style="color:#0000ff;">auto</span><span style="color:#000000;">&amp;&nbsp;th&nbsp;:&nbsp;threads)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;th.join();<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;unique_lock::try_lock&nbsp;ç¤ºä¾‹<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;vector&lt;thread&gt;&nbsp;ths;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">for</span><span style="color:#000000;">&nbsp;(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;i&nbsp;=&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;&nbsp;i&nbsp;&lt;&nbsp;</span><span style="color:#ff0000;">500</span><span style="color:#000000;">;&nbsp;++i)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ths.emplace_back(print_star);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">for</span><span style="color:#000000;">&nbsp;(</span><span style="color:#0000ff;">auto</span><span style="color:#000000;">&amp;&nbsp;th&nbsp;:&nbsp;ths)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;th.join();<BR>
&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;\n&quot;</span><span style="color:#000000;">;<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;unique_lock::try_lock_for&nbsp;ç¤ºä¾‹<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">for</span><span style="color:#000000;">&nbsp;(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;i&nbsp;=&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;&nbsp;i&nbsp;&lt;&nbsp;</span><span style="color:#ff0000;">10</span><span style="color:#000000;">;&nbsp;++i)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;threads[i]&nbsp;=&nbsp;thread(fireworks);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">for</span><span style="color:#000000;">&nbsp;(</span><span style="color:#0000ff;">auto</span><span style="color:#000000;">&amp;&nbsp;th&nbsp;:&nbsp;threads)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;th.join();<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;unique_lock::operator=&nbsp;ç¤ºä¾‹<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;thread&nbsp;th1(print_fifty,&nbsp;</span><span style="color:#800000;">'ï¿¥'</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;thread&nbsp;th2(print_fifty,&nbsp;</span><span style="color:#800000;">'$'</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;th1.join();<BR>
&nbsp;&nbsp;&nbsp;&nbsp;th2.join();<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;unique_lock::release&nbsp;ç¤ºä¾‹<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;vector&lt;std::thread&gt;&nbsp;thrds;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">for</span><span style="color:#000000;">&nbsp;(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;i&nbsp;=&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;&nbsp;i&nbsp;&lt;&nbsp;</span><span style="color:#ff0000;">10</span><span style="color:#000000;">;&nbsp;++i)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;thrds.emplace_back(task);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">for</span><span style="color:#000000;">&nbsp;(</span><span style="color:#0000ff;">auto</span><span style="color:#000000;">&amp;&nbsp;th&nbsp;:&nbsp;thrds)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;th.join();<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;unique_lock::owns_lock&nbsp;ç¤ºä¾‹<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;vector&lt;std::thread&gt;&nbsp;threds;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">for</span><span style="color:#000000;">&nbsp;(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;i&nbsp;=&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;&nbsp;i&nbsp;&lt;&nbsp;</span><span style="color:#ff0000;">500</span><span style="color:#000000;">;&nbsp;++i)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;threds.emplace_back(print_star2);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">for</span><span style="color:#000000;">&nbsp;(</span><span style="color:#0000ff;">auto</span><span style="color:#000000;">&amp;&nbsp;th&nbsp;:&nbsp;threds)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;th.join();<BR>
&nbsp;&nbsp;&nbsp;&nbsp;std::cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;\n&quot;</span><span style="color:#000000;">;<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;unique_lock::mutex&nbsp;ç¤ºä¾‹<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">for</span><span style="color:#000000;">&nbsp;(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;i&nbsp;=&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;&nbsp;i&nbsp;&lt;&nbsp;</span><span style="color:#ff0000;">10</span><span style="color:#000000;">;&nbsp;++i)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;threads[i]&nbsp;=&nbsp;thread(print_ids,&nbsp;i&nbsp;+&nbsp;</span><span style="color:#ff0000;">1</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">for</span><span style="color:#000000;">&nbsp;(</span><span style="color:#0000ff;">auto</span><span style="color:#000000;">&amp;&nbsp;th&nbsp;:&nbsp;threads)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;th.join();<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;<BR>
}</span></div></td></tr></table></div>
<br><font color = green size = 5>Other Typeså…¶ä»–ç±»å‹</font>
<br>
<br><font color = blue size = 4>once_flag</font>
<br>æ­¤ç±»å‹çš„å¯¹è±¡ç”¨ä½œcall_onceçš„å‚æ•°
<br>åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­ä½¿ç”¨ç›¸åŒçš„å¯¹è±¡åœ¨ä¸åŒçš„è°ƒç”¨ä¸Šè°ƒç”¨call_onceï¼Œå¦‚æœåŒæ—¶è°ƒç”¨ï¼Œåˆ™ä¼šå•ä¸ªæ‰§è¡Œ
<br>å®ƒæ˜¯ä¸€ä¸ªä¸å¯å¤åˆ¶çš„ã€ä¸å¯ç§»åŠ¨çš„ã€å¯æ„é€ çš„ç±»
<br>struct once_flag {
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;constexpr once_flag() noexcept;
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;once_flag (const once_flag&amp;) = delete;
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;once_flag&amp; operator= (const once_flag&amp;) = delete;
<br>};
<br>
<br><font color = blue size = 4>adopt_lock_t</font>
<br>è¿™æ˜¯ä¸€ä¸ªç©ºçš„ç±»ï¼Œç”¨ä½œadopt_lockçš„ä½¿ç”¨çš„ç±»å‹
<br>å‘unique_lockæˆ–lock_guardçš„æ„é€ å‡½æ•°ä¼ é€’ä½¿ç”¨è¿‡çš„é”ï¼Œä½¿è¯¥å¯¹è±¡ä¸é”å®šäº’æ–¥å¯¹è±¡ï¼Œå¹¶å‡è®¾å®ƒå·²ç»è¢«å½“å‰çº¿ç¨‹é”å®š
<br>struct defer_lock_t {}; // ç©ºç±»ï¼Œåªæ˜¯ä½œä¸ºadopt_lockç±»å‹
<br>constexpr adopt_lock_t adopt_lock {};
<br>å®šä¹‰adopt_lock å€¼ç”¨ä½œå¯¹unique_lockæˆ–lock_guardçš„æ„é€ å‡½æ•°çš„å¯èƒ½å‚æ•°
<br>ä½¿ç”¨adopt_lockæ„é€ unique_lockå¯¹è±¡ä¸é”å®šæ„å»ºä¸­çš„äº’æ–¥å¯¹è±¡ï¼Œåªæ˜¯å‡è®¾å®ƒå·²ç»è¢«å½“å‰çº¿ç¨‹é”å®šäº†ï¼›è¿™ä¸ªå€¼æ˜¯ä¸€ä¸ªæ²¡æœ‰çŠ¶æ€çš„ç¼–è¯‘æ—¶å¸¸é‡ï¼Œåªæ˜¯ç”¨æ¥æ¶ˆé™¤æ„é€ å‡½æ•°ç­¾åä¹‹é—´çš„æ­§ä¹‰
<br>
<br><font color = blue size = 4>defer_lock_t</font>
<br>è¿™æ˜¯ä¸€ä¸ªç©ºç±»ï¼Œç”¨ä½œå»¶è¿Ÿé”çš„ç±»å‹
<br>å°†å»¶è¿Ÿé”ä¼ é€’ç»™unique_lockçš„æ„é€ å‡½æ•°ï¼Œä½¿å®ƒä¸ä¼šåœ¨æ„é€ ä¸Šè‡ªåŠ¨é”å®šäº’æ–¥å¯¹è±¡ï¼Œåˆå§‹åŒ–å¯¹è±¡ä¸ºä¸æ‹¥æœ‰é”
<br>struct defer_lock_t {};
<br>constexpr defer_lock_t defer_lock {};
<br>å®šä¹‰defer_lockç”¨äºunique_lockçš„æ„é€ å‡½æ•°çš„å¯èƒ½çš„å‚æ•°ã€‚ä½¿ç”¨å»¶è¿Ÿé”æ„é€ çš„unique_lockå¯¹è±¡ä¸å°†äº’æ–¥å¯¹è±¡è‡ªåŠ¨é”å®šåœ¨æ„é€ ä¸Šï¼Œå¹¶åˆå§‹åŒ–å®ƒä»¬ä¸æ‹¥æœ‰é”ã€‚åŒä¸Šé¢çš„ä¸€æ ·ï¼Œè¿™ä¸ªå€¼æ˜¯ä¸€ä¸ªæ²¡æœ‰çŠ¶æ€çš„ç¼–è¯‘æ—¶å¸¸é‡ï¼Œå®ƒåªæ˜¯ç”¨æ¥æ¶ˆé™¤æ„é€ å‡½æ•°ç­¾åä¹‹é—´çš„æ­§ä¹‰
<br>
<br><font color = blue size = 4>try_to_lock_t</font>
<br>try_to_lock_tæ˜¯ç”¨äºtry_to_lockç±»å‹çš„ç©ºç±»
<br>å°†try_to_lockä¼ é€’ç»™unique_lockçš„æ„é€ å‡½æ•°ï¼Œä½¿å®ƒé€šè¿‡è°ƒç”¨å®ƒçš„try_lockæˆå‘˜æ¥é”å®šäº’æ–¥å¯¹è±¡ï¼Œä»£æ›¿lock
<br>struct try_to_lock_t {};
<br>constexpr try_to_lock_t try_to_lock {};
<br>try_to_lock ç”¨äºunique_lockçš„æ„é€ å‡½æ•°çš„å¯èƒ½çš„å‚æ•°ï¼Œä½¿ç”¨try_to_lockæ„é€ çš„unique_lockå¯¹è±¡è¯•å›¾é€šè¿‡è°ƒç”¨å…¶try_lockæˆå‘˜è€Œä¸æ˜¯é”æˆå‘˜æ¥é”å®šäº’æ–¥å¯¹è±¡
<br>
<br><font color = green size = 5>mutexä¸­çš„å‡½æ•°</font>
<table border="4">
<tr>
<th>å‡½æ•°å</th>
<th>æ„ä¹‰</th>
<th></th>
</tr>
<tr>
<td>try_lock</td>
<td>Try to lock multiple mutexes (function template )</td>
<td>è¯•é”äº’æ–¥é‡</td>
</tr>
<tr>
<td>lock</td>
<td>Lock multiple mutexes (function template )</td>
<td>é”</td>
</tr>
<tr>
<td>call_once</td>
<td>Call function once (public member function )</td>
<td>call_once</td>
</tr>
</table>
<br><font color = blue size = 4>std::try_lock()</font>
<br>std::try_lockæ˜¯ä¸€ä¸ªæ¨¡ç‰ˆå‡½æ•°ï¼š
<br>template &lt;class Mutex1, class Mutex2, class... Mutexes&gt;
<br>int try_lock (Mutex1&amp; a, Mutex2&amp; b, Mutexes&amp;... cde);
<br>ä½¿ç”¨try_lockæˆå‘˜å‡½æ•°(éé˜»å¡)å¼çš„é”å®šå¯¹è±¡a,b...ç­‰
<br>å‡½æ•°ä¸ºæ¯ä¸ªå‚æ•°è°ƒç”¨try_lockæˆå‘˜å‡½æ•°(é¦–å…ˆæ˜¯aï¼Œç„¶åæ˜¯bï¼Œæœ€åæ˜¯cdeä¸­çš„å…¶ä»–å‡½æ•°)ï¼Œç›´åˆ°æ‰€æœ‰è°ƒç”¨éƒ½æ˜¯æˆåŠŸçš„ï¼Œæˆ–è€…åªè¦è°ƒç”¨å¤±è´¥(è¿”å›falseæˆ–æŠ›å‡ºå¼‚å¸¸)
<br>å¦‚æœå‡½æ•°ç»“æŸæ˜¯å› ä¸ºè°ƒç”¨å¤±è´¥ï¼Œåˆ™å¯¹æ‰€æœ‰è°ƒç”¨try_lockæˆåŠŸçš„å¯¹è±¡è°ƒç”¨è§£é”ï¼Œå‡½æ•°å°†è¿”å›é”å®šå¤±è´¥çš„å¯¹è±¡çš„å‚æ•°åºå·ã€‚æ²¡æœ‰å¯¹å‚æ•°åˆ—è¡¨ä¸­çš„å…¶ä½™å¯¹è±¡æ‰§è¡Œå…¶ä»–è°ƒç”¨
<br> ğŸ“ ç¨‹åºç¤ºä¾‹ï¼š
<br><div style="width:100%;border:1px #e3e3e3 solid;"><div style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;border-bottom:1px solid #e3e3e3;margin-top:5px;color:#000000;">&nbsp;C++ Code&nbsp;</div><table style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;vertical-align:text-top;line-height:15px;" border="0" cellspacing="0" cellpadding="0"><tr><td style="color:#008284;background-color:#e3e3e3;vertical-align:text-top;"><div style="margin:7px;text-align:right;white-space:nowrap;"><nobr>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br></nobr></div></td><td style="background-color:#008284;padding:1px;"><div style="border:1px #008284 solid;"></div></td><td style="background-color:#efefef;width:100%;vertical-align:text-top;color:#000000;"><div style="margin:7px;"><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;iostream&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;thread&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;mutex&gt;<BR>
<BR>
std::mutex&nbsp;foo,bar;<BR>
<BR>
</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;task_a&nbsp;()<BR>
{<BR>
&nbsp;&nbsp;foo.lock();<BR>
&nbsp;&nbsp;std::cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;task&nbsp;a\n&quot;</span><span style="color:#000000;">;<BR>
&nbsp;&nbsp;bar.lock();<BR>
&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;...<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;foo.unlock();<BR>
&nbsp;&nbsp;bar.unlock();<BR>
}<BR>
<BR>
</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;task_b&nbsp;()<BR>
{<BR>
&nbsp;&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;x&nbsp;=&nbsp;try_lock(bar,foo);<BR>
&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(x==-</span><span style="color:#ff0000;">1</span><span style="color:#000000;">)&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;std::cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;task&nbsp;b\n&quot;</span><span style="color:#000000;">;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;...<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;bar.unlock();<BR>
&nbsp;&nbsp;&nbsp;&nbsp;foo.unlock();<BR>
&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;</span><span style="color:#0000ff;">else</span><span style="color:#000000;">&nbsp;<BR>
&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;std::cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;[task&nbsp;b&nbsp;failed:&nbsp;mutex&nbsp;&quot;</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;&lt;&nbsp;(x?</span><span style="color:#800000;">&quot;foo&quot;</span><span style="color:#000000;">:</span><span style="color:#800000;">&quot;bar&quot;</span><span style="color:#000000;">)&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;&nbsp;locked]\n&quot;</span><span style="color:#000000;">;<BR>
&nbsp;&nbsp;}<BR>
}<BR>
<BR>
</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;main&nbsp;()<BR>
{<BR>
&nbsp;&nbsp;std::thread&nbsp;th1&nbsp;(task_a);<BR>
&nbsp;&nbsp;std::thread&nbsp;th2&nbsp;(task_b);<BR>
<BR>
&nbsp;&nbsp;th1.join();<BR>
&nbsp;&nbsp;th2.join();<BR>
<BR>
&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;<BR>
}</span></div></td></tr></table></div>
<br><font color = blue size = 4>std::lock()</font>
<br>std::lockåŒæ ·ä¸ºä¸€ä¸ªæ¨¡ç‰ˆå‡½æ•°:
<br>template &lt;class Mutex1, class Mutex2, class... Mutexes&gt;
<br>void lock (Mutex1&amp; a, Mutex2&amp; b, Mutexes&amp;... cde);
<br>é”å®šæ‰€æœ‰çš„å‚æ•°äº’æ–¥å¯¹è±¡ï¼Œé˜»å¡å½“å‰è°ƒç”¨çº¿ç¨‹
<br>è¯¥å‡½æ•°ä½¿ç”¨ä¸€ä¸ªæœªæŒ‡å®šçš„è°ƒç”¨åºåˆ—æ¥é”å®šå¯¹è±¡ï¼Œè¯¥åºåˆ—è°ƒç”¨å…¶æˆå‘˜é”ã€try_lockå’Œè§£é”ï¼Œä»¥ç¡®ä¿æ‰€æœ‰å‚æ•°éƒ½è¢«é”å®šå†è¿”å›(ä¸äº§ç”Ÿä»»ä½•æ­»é”)
<br>å¦‚æœå‡½æ•°ä¸èƒ½é”å®šæ‰€æœ‰å¯¹è±¡(ä¾‹å¦‚ï¼Œå› ä¸ºå…¶ä¸­ä¸€ä¸ªå†…éƒ¨è°ƒç”¨æŠ›å‡ºå¼‚å¸¸)ï¼Œåˆ™å‡½æ•°é¦–å…ˆè§£é”æ‰€æœ‰æˆåŠŸé”å®šçš„å¯¹è±¡(å¦‚æœæœ‰çš„è¯)
<br> ğŸ“ ç¨‹åºç¤ºä¾‹ï¼š
<br><div style="width:100%;border:1px #e3e3e3 solid;"><div style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;border-bottom:1px solid #e3e3e3;margin-top:5px;color:#000000;">&nbsp;C++ Code&nbsp;</div><table style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;vertical-align:text-top;line-height:15px;" border="0" cellspacing="0" cellpadding="0"><tr><td style="color:#008284;background-color:#e3e3e3;vertical-align:text-top;"><div style="margin:7px;text-align:right;white-space:nowrap;"><nobr>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br></nobr></div></td><td style="background-color:#008284;padding:1px;"><div style="border:1px #008284 solid;"></div></td><td style="background-color:#efefef;width:100%;vertical-align:text-top;color:#000000;"><div style="margin:7px;"><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;iostream&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;thread&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;mutex&gt;<BR>
<BR>
std::mutex&nbsp;foo,&nbsp;bar;<BR>
<BR>
</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;task_a&nbsp;()<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;foo.lock();&nbsp;bar.lock();<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;replaced&nbsp;by:<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;std::lock&nbsp;(foo,&nbsp;bar);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;std::cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;task&nbsp;a\n&quot;</span><span style="color:#000000;">;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;foo.unlock();<BR>
&nbsp;&nbsp;&nbsp;&nbsp;bar.unlock();<BR>
}<BR>
<BR>
</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;task_b&nbsp;()<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;bar.lock();&nbsp;foo.lock();<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;replaced&nbsp;by:<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;std::lock&nbsp;(bar,&nbsp;foo);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;std::cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;task&nbsp;b\n&quot;</span><span style="color:#000000;">;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;bar.unlock();<BR>
&nbsp;&nbsp;&nbsp;&nbsp;foo.unlock();<BR>
}<BR>
<BR>
</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;main&nbsp;()<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;std::thread&nbsp;th1&nbsp;(task_a);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;std::thread&nbsp;th2&nbsp;(task_b);<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;th1.join();<BR>
&nbsp;&nbsp;&nbsp;&nbsp;th2.join();<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;<BR>
}</span></div></td></tr></table></div>
<br><font color = blue size = 4>std::call_once()</font>
<br>std::call_once å…¬æœ‰æ¨¡ç‰ˆå‡½æ•°ï¼š
<br>template &lt;class Fn, class... Args&gt;
<br>void call_once (once_flag&amp; flag, Fn&amp;&amp; fn, Args&amp;&amp;... args);
<br>call_onceè°ƒç”¨å°†args ä½œä¸ºfnçš„å‚æ•°è°ƒç”¨fnï¼Œé™¤éå¦ä¸€ä¸ªçº¿ç¨‹å·²ç»(æˆ–æ­£åœ¨æ‰§è¡Œ)ä½¿ç”¨ç›¸åŒçš„flagè°ƒç”¨æ‰§è¡Œcall_once
<br>å¦‚æœå·²ç»æœ‰ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ç›¸åŒflagè°ƒç”¨call_onceï¼Œä¼šä½¿å¾—å½“å‰å˜ä¸ºè¢«åŠ¨æ‰§è¡Œï¼Œæ‰€è°“è¢«åŠ¨æ‰§è¡Œä¸æ‰§è¡Œfnä¹Ÿä¸è¿”å›ç›´åˆ°æ¢å¤æ‰§è¡Œåè¿”å›ã€‚è¿™è¿™ä¸ªæ—¶é—´ç‚¹ä¸Šæ‰€æœ‰çš„å¹¶å‘è°ƒç”¨è¿™ä¸ªå‡½æ•°ç›¸åŒçš„flagéƒ½æ˜¯åŒæ­¥çš„
<br>æ³¨ï¼šä¸€æ—¦ä¸€ä¸ªæ´»è·ƒè°ƒç”¨è¿”å›äº†,æ‰€æœ‰å½“å‰è¢«åŠ¨æ‰§è¡Œå’Œæœªæ¥å¯èƒ½çš„è°ƒç”¨call_onceç›¸åŒç›¸åŒçš„flagä¹Ÿè¿˜ä¸ä¼šæˆä¸ºç§¯ææ‰§è¡Œ
<br> ğŸ“ ç¨‹åºç¤ºä¾‹ï¼š
<br><div style="width:100%;border:1px #e3e3e3 solid;"><div style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;border-bottom:1px solid #e3e3e3;margin-top:5px;color:#000000;">&nbsp;C++ Code&nbsp;</div><table style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;vertical-align:text-top;line-height:15px;" border="0" cellspacing="0" cellpadding="0"><tr><td style="color:#008284;background-color:#e3e3e3;vertical-align:text-top;"><div style="margin:7px;text-align:right;white-space:nowrap;"><nobr>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br></nobr></div></td><td style="background-color:#008284;padding:1px;"><div style="border:1px #008284 solid;"></div></td><td style="background-color:#efefef;width:100%;vertical-align:text-top;color:#000000;"><div style="margin:7px;"><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;iostream&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;thread&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;chrono&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;mutex&gt;<BR>
<BR>
</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;winner;<BR>
</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;set_winner&nbsp;(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;x)<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;winner&nbsp;=&nbsp;x;<BR>
}<BR>
std::once_flag&nbsp;winner_flag;<BR>
<BR>
</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;wait_1000ms&nbsp;(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;id)<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;count&nbsp;to&nbsp;1000,&nbsp;waiting&nbsp;1ms&nbsp;between&nbsp;increments:<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">for</span><span style="color:#000000;">&nbsp;(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;i&nbsp;=&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;&nbsp;i&nbsp;&lt;&nbsp;</span><span style="color:#ff0000;">1000</span><span style="color:#000000;">;&nbsp;++i)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;std::this_thread::sleep_for<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(std::chrono::milliseconds(</span><span style="color:#ff0000;">1</span><span style="color:#000000;">));<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;claim&nbsp;to&nbsp;be&nbsp;the&nbsp;winner<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(only&nbsp;the&nbsp;first&nbsp;such&nbsp;call&nbsp;is&nbsp;executed):<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;std::call_once&nbsp;(winner_flag,&nbsp;set_winner,&nbsp;id);<BR>
}<BR>
<BR>
</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;main&nbsp;()<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;std::thread&nbsp;threads[</span><span style="color:#ff0000;">10</span><span style="color:#000000;">];<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;spawn&nbsp;10&nbsp;threads:<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">for</span><span style="color:#000000;">&nbsp;(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;i&nbsp;=&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;&nbsp;i&nbsp;&lt;&nbsp;</span><span style="color:#ff0000;">10</span><span style="color:#000000;">;&nbsp;++i)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;threads[i]&nbsp;=&nbsp;std::thread(wait_1000ms,&nbsp;i&nbsp;+&nbsp;</span><span style="color:#ff0000;">1</span><span style="color:#000000;">);<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;std::cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;waiting&nbsp;for&nbsp;the&nbsp;first&nbsp;&quot;</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#800000;">&quot;among&nbsp;10&nbsp;threads&nbsp;to&nbsp;count&nbsp;1000&nbsp;&nbsp;&nbsp;ms...\n&quot;</span><span style="color:#000000;">;<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">for</span><span style="color:#000000;">&nbsp;(</span><span style="color:#0000ff;">auto</span><span style="color:#000000;">&nbsp;&amp;th&nbsp;:&nbsp;threads)&nbsp;th.join();<BR>
&nbsp;&nbsp;&nbsp;&nbsp;std::cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;winner&nbsp;thread:&nbsp;&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;winner&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">'\n'</span><span style="color:#000000;">;<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;<BR>
}</span></div></td></tr></table></div>
<br><br><br>
<font color = gray size = 3>å¦‚æœ‰é”™è¯¯ï¼Œæ¬¢è¿æŒ‡æ­£ï¼</font></p></div>
        <div class="post_footer">
          
          <div class="meta">
            <div class="info">
              <span class="field tags">
                <i class="remixicon-stack-line"></i>
                
                <a href="https://oubc.github.io/tags/c/c&#43;&#43;/">C/C&#43;&#43;</a>
                
              </span>
            </div>
          </div>
          
        </div>
      </div>
      
      
    </div>
  </div>
  <a id="back_to_top" href="#" class="back_to_top"><span>â–³</span></a>
</div>
<footer class="footer">
  <div class="powered_by">
    <a href="https://wxt.sinaimg.cn/thumb300/007Diza3ly1g4l9lmg4aog3074074gnf.gif?tags=%5B%5D">I </a>
	<a href="">love</a>
    <a href="https://wxt.sinaimg.cn/thumb300/007Diza3ly1g4l9lmfm2eg306o06o74u.gif?tags=%5B%5D"> you </a>
    <a href="https://wxt.sinaimg.cn/thumb300/007Diza3ly1g4njrx4tpcj30fn0bq3zg.jpg?tags=%5B%5D">three </a>
	<a href="https://wxt.sinaimg.cn/thumb300/007Diza3ly1g4njrx64ctg307s07swfy.gif?tags=%5B%5D">thousand</a>
    <a href="https://www.kugou.com/song/#hash=96426C78381DE98DC31A5846FC274CBF&album_id=646623"> times.</a>
  </div>

  <div class="footer_slogan">
    <span>å®¶åº­ã€æ¢¦æƒ³ã€å†…å¿ƒçš„å¹³é™</span>
  </div>
</footer>



<script src="https://oubc.github.io/js/jquery-3.3.1.min.js"></script>
<script src="https://oubc.github.io/js/zozo.js"></script>
<script src="https://oubc.github.io/js/highlight.pack.js"></script>
<link  href="https://oubc.github.io/css/fancybox.min.css" rel="stylesheet">
<script src="https://oubc.github.io/js/fancybox.min.js"></script>

<script>hljs.initHighlightingOnLoad()</script>


  <script type="text/javascript" async src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[\[','\]\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});

MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<style>
code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
}
</style>






</body>
</html>
