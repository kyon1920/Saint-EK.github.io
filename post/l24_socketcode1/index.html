<!DOCTYPE html>
<html lang="zh-cn" >
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  
  <meta name="author"
        content="Bruce Cheung"/>

  
  <meta name="description" content=""/>
  

  
  
  <meta name="keywords" content="blog, simple, dream"/>
  

  
  <link rel="canonical" href="https://oubc.github.io/post/l24_socketcode1/"/>

  

  <title>Linuxç½‘ç»œç¼–ç¨‹ ( Socketç¼–ç¨‹ ) &middot; Love, or death</title>

  <link rel="shortcut icon" href="https://oubc.github.io/images/favicon.ico"/>
  <link rel="stylesheet" href="https://oubc.github.io/css/animate.min.css"/>
  <link rel="stylesheet" href="https://oubc.github.io/css/remixicon.css"/>
  <link rel="stylesheet" href="https://oubc.github.io/css/zozo.css"/>
  <link rel="stylesheet" href="https://oubc.github.io/css/highlight.css"/>

  
  
</head>

<body>
<div class="main animated">
  <div class="nav_container animated fadeInDown">
  <div class="site_nav" id="site_nav">
    <ul>
      
      <li>
        <a href="/">é¦–é¡µ</a>
      </li>
      
      <li>
        <a href="/post/">å½’æ¡£</a>
      </li>
      
      <li>
        <a href="/tags/">æ ‡ç­¾</a>
      </li>
      
      <li>
        <a href="/about/">å…³äº</a>
      </li>
      
    </ul>
  </div>
  <div class="menu_icon">
    <a id="menu_icon"><i class="remixicon-links-line"></i></a>
  </div>
</div>

  <div class="header animated fadeInDown">
  <div class="site_title_container">
    <div class="site_title">
      <h1>
        <a href="https://oubc.github.io/">
          <span>Love, or death</span>
          <img src="https://oubc.github.io/images/logo.svg"/>
        </a>
      </h1>
    </div>
    <div class="description">
      <p class="sub_title">For you, a thousand times over.</p>
      <div class="my_socials">
        
        
        <a href="https://github.com/oubc" title="github" target="_blank"><i class="remixicon-github-fill"></i></a>
        
        
        
        <a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=uYGOjo6OiIuLivnIyJfa1tQ" title="mail" target="_blank"><i class="remixicon-mail-fill"></i></a>
        
        
        
        <a href="http://sighttp.qq.com/msgrd?v=1&amp;uin=877771223" title="qq" target="_blank"><i class="remixicon-qq-fill"></i></a>
        
        
        
        <a href="https://github.com/oubc/oubc.github.io/blob/master/images/wx.jpg?raw=true" title="wechat" target="_blank"><i class="remixicon-wechat-fill"></i></a>
        
        
        
        <a href="https://weibo.com/u/6993631995?topnav=1&amp;wvr=6&amp;topsug=1" title="weibo" target="_blank"><i class="remixicon-weibo-fill"></i></a>
        
        
        <a href="https://oubc.github.io/index.xml" type="application/rss+xml" title="rss" target="_blank"><i class="remixicon-rss-fill"></i></a>
      </div>
    </div>
  </div>
</div>

  <div class="content">
    <div class="post_page">
      <div class="post animated fadeInDown">
        <div class="post_title post_detail_title">
          <h2><a href='/post/l24_socketcode1/'>Linuxç½‘ç»œç¼–ç¨‹ ( Socketç¼–ç¨‹ )</a></h2>
          <span class="date">2019.10.11</span>
        </div>
        <div class="post_content markdown"><p><br>
<br>
<font color = gray size = 2>åˆ—è¡¨ï¼Œå±•å¼€ç‚¹å‡»è·³è½¬</font>
<br>
<details class="menu" close>
      <summary><font color=blue size = 4>Socketç¼–ç¨‹ç›¸å…³æ¦‚å¿µ</font></summary>
      <ul>
          <li><a href="#bc0">å¥—æ¥å­—æ¦‚å¿µ</a></li>
          <li><a href="#bc1">ç½‘ç»œå­—èŠ‚åº</a></li>
          <li><a href="#bc2">IPåœ°å€è½¬æ¢å‡½æ•°</a></li>
          <li><a href="#bc3">å¯é‡å…¥å‡½æ•°</a></li>
          <li><a href="#bc4">sockaddr æ•°æ®ç»“æ„</a></li>
      </ul>
</details>
<details class="menu" close>
      <summary><font color=blue size = 4>ç½‘ç»œå¥—æ¥å­—å‡½æ•°</font></summary>
      <ul>
          <li><a href="#bc5">Socketæ¨¡å‹åˆ›å»º</a></li>
          <li><a href="#bc6">socket() å‡½æ•°</a></li>
          <li><a href="#bc7">bind() å‡½æ•°</a></li>
          <li><a href="#bc8">listen() å‡½æ•°</a></li>
          <li><a href="#bc9">accept() å‡½æ•°</a></li>
          <li><a href="#bc10">connect() å‡½æ•°</a></li>
      </ul>
</details>
<details class="menu" close>
      <summary><font color=blue size = 4>C/S-TCP</font></summary>
      <ul>
          <li><a href="#bc11">Socketç¼–ç¨‹æµç¨‹</a></li>
          <li><a href="#bc12">æœåŠ¡å™¨ç«¯å®ç°</a></li>
          <li><a href="#bc13">å®¢æˆ·ç«¯å®ç°</a></li>
          <li><a href="#bc14">å‡ºé”™å¤„ç†å°è£…å‡½æ•°</a></li>
          <li><a href="#bc15">readè¿”å›å€¼æ€»ç»“</a></li>
      </ul>
</details>
<br>
<br>
<br>
<br>
<br><font color=black size = 5>æ–‡ä»¶</font>
<br><img src="https://github.com/oubc/oubc.github.io/blob/master/images/L24_SocketCode0.png?raw=true" width="800" height="600" />
<br>
<br><font color=black size = 5><a name="bc0">å¥—æ¥å­—æ¦‚å¿µ</a></font>
<br> âœ¦ åœ¨Linuxç¯å¢ƒä¸‹ï¼ŒSocketç”¨äºè¡¨ç¤ºè¿›ç¨‹é—´ç½‘ç»œé€šä¿¡çš„ç‰¹æ®Šæ–‡ä»¶ç±»å‹ã€‚æœ¬è´¨ä¸ºå†…æ ¸å€ŸåŠ©ç¼“å†²åŒºå½¢æˆçš„ä¼ªæ–‡ä»¶ã€‚
<br> âœ¦ æ—¢ç„¶æ˜¯æ–‡ä»¶ï¼Œé‚£ä¹ˆç†æ‰€å½“ç„¶çš„ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ–‡ä»¶æè¿°ç¬¦å¼•ç”¨å¥—æ¥å­—ã€‚ä¸ç®¡é“ç±»ä¼¼çš„ï¼ŒLinuxç³»ç»Ÿå°†å…¶å°è£…æˆæ–‡ä»¶çš„ç›®çš„æ˜¯ä¸ºäº†ç»Ÿä¸€æ¥å£ï¼Œä½¿å¾—è¯»å†™å¥—æ¥å­—å’Œè¯»å†™æ–‡ä»¶çš„æ“ä½œä¸€è‡´ã€‚åŒºåˆ«æ˜¯ç®¡é“ä¸»è¦åº”ç”¨äºæœ¬åœ°è¿›ç¨‹é—´é€šä¿¡ï¼Œè€Œå¥—æ¥å­—å¤šåº”ç”¨äºç½‘ç»œè¿›ç¨‹é—´æ•°æ®çš„ä¼ é€’ã€‚
<br> âœ¦ åœ¨TCP/IPåè®®ä¸­ï¼Œâ€œIPåœ°å€ + TCPæˆ–UDPç«¯å£å·â€å”¯ä¸€æ ‡è¯†ç½‘ç»œé€šè®¯ä¸­çš„ä¸€ä¸ªè¿›ç¨‹ã€‚â€œIPåœ°å€+ç«¯å£å·â€å°±å¯¹åº”ä¸€ä¸ªsocketã€‚æ¬²å»ºç«‹è¿æ¥çš„ä¸¤ä¸ªè¿›ç¨‹å„è‡ªæœ‰ä¸€ä¸ªsocketæ¥æ ‡è¯†ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªsocketç»„æˆçš„socket pairå°±å”¯ä¸€æ ‡è¯†ä¸€ä¸ªè¿æ¥ã€‚å› æ­¤å¯ä»¥ç”¨Socketæ¥æè¿°ç½‘ç»œè¿æ¥çš„ä¸€å¯¹ä¸€å…³ç³»ã€‚
<br> ğŸ¤  å¥—æ¥å­—é€šä¿¡åŸç†å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
<br><img src="https://github.com/oubc/oubc.github.io/blob/master/images/L24_SocketCode1.png?raw=true" width="800" height="450" />
<br> âœ¦ å¥—æ¥å­—æ€»æ˜¯æˆå¯¹å‡ºç°çš„ã€åœ¨ä½¿ç”¨çš„æ—¶å€™å¿…é¡»ç»‘å®šIPå’Œç«¯å£ã€ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦æŒ‡å‘ä¸¤ä¸ªç¼“å†²åŒº(å†…æ ¸å®ç°)ï¼Œä¸€ä¸ªè¯»ä¸€ä¸ªå†™ï¼Œæ–‡ä»¶æè¿°ç¬¦åªæœ‰ä¸€ä¸ªã€‚
<br> â™š IPåœ°å€ï¼šåœ¨ç½‘ç»œç¯å¢ƒä¸­å”¯ä¸€æ ‡ç¤ºä¸€å°ä¸»æœº
<br> â™š ç«¯å£å·ï¼šåœ¨ä¸»æœºä¸­å”¯ä¸€æ ‡ç¤ºä¸€ä¸ªè¿›ç¨‹
<br> â™š IP + Portï¼šåœ¨ç½‘ç»œç¯å¢ƒä¸­æ ‡ç¤ºä¸€ä¸ªè¿›ç¨‹ (Socket)
<br> âœ¦ åœ¨ç½‘ç»œé€šä¿¡ä¸­ï¼Œå¥—æ¥å­—ä¸€å®šæ˜¯æˆå¯¹å‡ºç°çš„ã€‚ä¸€ç«¯çš„å‘é€ç¼“å†²åŒºå¯¹åº”å¯¹ç«¯çš„æ¥æ”¶ç¼“å†²åŒºã€‚æˆ‘ä»¬ä½¿ç”¨åŒä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ç´¢å‘é€ç¼“å†²åŒºå’Œæ¥æ”¶ç¼“å†²åŒºã€‚
<br> âœ¦ TCP/IPåè®®æœ€æ—©åœ¨BSD UNIXä¸Šå®ç°ï¼Œä¸ºTCP/IPåè®®è®¾è®¡çš„åº”ç”¨å±‚ç¼–ç¨‹æ¥å£ç§°ä¸ºsocket APIã€‚
<br> ğŸ¤  ç½‘ç»œç¼–ç¨‹æ¥å£ï¼š
<br><img src="https://github.com/oubc/oubc.github.io/blob/master/images/L24_SocketCode2.png?raw=true" width="800" height="900" />
<br>
<br><font color=black size = 5><a name="bc1">ç½‘ç»œå­—èŠ‚åº</a></font>
<br> âœ¦ å†…å­˜ä¸­çš„å¤šå­—èŠ‚æ•°æ®ç›¸å¯¹äºå†…å­˜åœ°å€æœ‰å¤§ç«¯å’Œå°ç«¯ä¹‹åˆ†ï¼Œç£ç›˜æ–‡ä»¶ä¸­çš„å¤šå­—èŠ‚æ•°æ®ç›¸å¯¹äºæ–‡ä»¶ä¸­çš„åç§»åœ°å€ä¹Ÿæœ‰å¤§ç«¯å°ç«¯ä¹‹åˆ†ã€‚ç½‘ç»œæ•°æ®æµåŒæ ·æœ‰å¤§ç«¯å°ç«¯ä¹‹åˆ†ï¼Œé‚£ä¹ˆå¦‚ä½•å®šä¹‰ç½‘ç»œæ•°æ®æµçš„åœ°å€å‘¢ï¼Ÿå‘é€ä¸»æœºé€šå¸¸å°†å‘é€ç¼“å†²åŒºä¸­çš„æ•°æ®æŒ‰å†…å­˜åœ°å€ä»ä½åˆ°é«˜çš„é¡ºåºå‘å‡ºï¼Œæ¥æ”¶ä¸»æœºæŠŠä»ç½‘ç»œä¸Šæ¥åˆ°çš„å­—èŠ‚ä¾æ¬¡ä¿å­˜åœ¨æ¥æ”¶ç¼“å†²åŒºä¸­ï¼Œä¹Ÿæ˜¯æŒ‰å†…å­˜åœ°å€ä»ä½åˆ°é«˜çš„é¡ºåºä¿å­˜ï¼Œå› æ­¤ï¼Œç½‘ç»œæ•°æ®æµçš„åœ°å€åº”è¿™æ ·è§„å®šï¼šå…ˆå‘å‡ºçš„æ•°æ®æ˜¯ä½åœ°å€ï¼Œåå‘å‡ºçš„æ•°æ®æ˜¯é«˜åœ°å€ã€‚
<br><img src="https://github.com/oubc/oubc.github.io/blob/master/images/L24_SocketCode3.png?raw=true" width="800" height="700" />
<br> âœ¦ TCP/IPåè®®è§„å®šï¼Œç½‘ç»œæ•°æ®æµåº”é‡‡ç”¨å¤§ç«¯å­—èŠ‚åºï¼Œå³ä½åœ°å€é«˜å­—èŠ‚ã€‚ä¾‹å¦‚ä¸Šä¸€èŠ‚çš„UDPæ®µæ ¼å¼ï¼Œåœ°å€0-1æ˜¯16ä½çš„æºç«¯å£å·ï¼Œå¦‚æœè¿™ä¸ªç«¯å£å·æ˜¯1000ï¼ˆ0x3e8ï¼‰ï¼Œåˆ™åœ°å€0æ˜¯0x03ï¼Œåœ°å€1æ˜¯0xe8ï¼Œä¹Ÿå°±æ˜¯å…ˆå‘0x03ï¼Œå†å‘0xe8ï¼Œè¿™16ä½åœ¨å‘é€ä¸»æœºçš„ç¼“å†²åŒºä¸­ä¹Ÿåº”è¯¥æ˜¯ä½åœ°å€å­˜0x03ï¼Œé«˜åœ°å€å­˜0xe8ã€‚ä½†æ˜¯ï¼Œå¦‚æœå‘é€ä¸»æœºæ˜¯å°ç«¯å­—èŠ‚åºçš„ï¼Œè¿™16ä½è¢«è§£é‡Šæˆ0xe803ï¼Œè€Œä¸æ˜¯1000ã€‚å› æ­¤ï¼Œå‘é€ä¸»æœºæŠŠ1000å¡«åˆ°å‘é€ç¼“å†²åŒºä¹‹å‰éœ€è¦åšå­—èŠ‚åºçš„è½¬æ¢ã€‚åŒæ ·åœ°ï¼Œæ¥æ”¶ä¸»æœºå¦‚æœæ˜¯å°ç«¯å­—èŠ‚åºçš„ï¼Œæ¥åˆ°16ä½çš„æºç«¯å£å·ä¹Ÿè¦åšå­—èŠ‚åºçš„è½¬æ¢ã€‚å¦‚æœä¸»æœºæ˜¯å¤§ç«¯å­—èŠ‚åºçš„ï¼Œå‘é€å’Œæ¥æ”¶éƒ½ä¸éœ€è¦åšè½¬æ¢ã€‚åŒç†ï¼Œ32ä½çš„IPåœ°å€ä¹Ÿè¦è€ƒè™‘ç½‘ç»œå­—èŠ‚åºå’Œä¸»æœºå­—èŠ‚åºçš„é—®é¢˜ã€‚
<br> âœ¦ ä¸ºä½¿ç½‘ç»œç¨‹åºå…·æœ‰å¯ç§»æ¤æ€§ï¼Œä½¿åŒæ ·çš„Cä»£ç åœ¨å¤§ç«¯å’Œå°ç«¯è®¡ç®—æœºä¸Šç¼–è¯‘åéƒ½èƒ½æ­£å¸¸è¿è¡Œï¼Œå¯ä»¥è°ƒç”¨ä»¥ä¸‹åº“å‡½æ•°åš <b>ç½‘ç»œå­—èŠ‚åºå’Œä¸»æœºå­—èŠ‚åº</b> çš„è½¬æ¢ï¼š
<br><div style="width:100%;border:1px #e3e3e3 solid;"><div style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;border-bottom:1px solid #e3e3e3;margin-top:5px;color:#000000;">&nbsp;C++ Code&nbsp;</div><table style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;vertical-align:text-top;line-height:15px;" border="0" cellspacing="0" cellpadding="0"><tr><td style="color:#008284;background-color:#e3e3e3;vertical-align:text-top;"><div style="margin:7px;text-align:right;white-space:nowrap;"><nobr>1<br>2<br>3<br>4<br>5<br></nobr></div></td><td style="background-color:#008284;padding:1px;"><div style="border:1px #008284 solid;"></div></td><td style="background-color:#efefef;width:100%;vertical-align:text-top;color:#000000;"><div style="margin:7px;"><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;arpa/inet.h&gt;<BR>
uint32_t&nbsp;htonl(uint32_t&nbsp;hostlong);&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;IPåœ°å€è½¬æ¢<BR>
</span><span style="color:#000000;">uint16_t&nbsp;htons(uint16_t&nbsp;hostshort);&nbsp;</span><span style="color:#008000;">//&nbsp;ç«¯å£å·è½¬æ¢<BR>
</span><span style="color:#000000;">uint32_t&nbsp;ntohl(uint32_t&nbsp;netlong);<BR>
uint16_t&nbsp;ntohs(uint16_t&nbsp;netshort);</span></div></td></tr></table></div>
<br> â™š hè¡¨ç¤ºhostï¼Œnè¡¨ç¤ºnetworkï¼Œlè¡¨ç¤º32ä½é•¿æ•´æ•°ï¼Œsè¡¨ç¤º16ä½çŸ­æ•´æ•°ã€‚
<br> âœ¦ å¦‚æœä¸»æœºæ˜¯å°ç«¯å­—èŠ‚åºï¼Œè¿™äº›å‡½æ•°å°†å‚æ•°åšç›¸åº”çš„å¤§å°ç«¯è½¬æ¢ç„¶åè¿”å›ï¼Œå¦‚æœä¸»æœºæ˜¯å¤§ç«¯å­—èŠ‚åºï¼Œè¿™äº›å‡½æ•°ä¸åšè½¬æ¢ï¼Œå°†å‚æ•°åŸå°ä¸åŠ¨åœ°è¿”å›ã€‚
<br>
<br><font color=black size = 5><a name="bc2">IPåœ°å€è½¬æ¢å‡½æ•°</a></font>
<br> â™š æ—©æœŸ(å·²åºŸå¼ƒ)ï¼š
<br><div style="width:100%;border:1px #e3e3e3 solid;"><div style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;border-bottom:1px solid #e3e3e3;margin-top:5px;color:#000000;">&nbsp;C++ Code&nbsp;</div><table style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;vertical-align:text-top;line-height:15px;" border="0" cellspacing="0" cellpadding="0"><tr><td style="color:#008284;background-color:#e3e3e3;vertical-align:text-top;"><div style="margin:7px;text-align:right;white-space:nowrap;"><nobr>1<br>2<br>3<br>4<br>5<br>6<br></nobr></div></td><td style="background-color:#008284;padding:1px;"><div style="border:1px #008284 solid;"></div></td><td style="background-color:#efefef;width:100%;vertical-align:text-top;color:#000000;"><div style="margin:7px;"><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;sys/socket.h&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;netinet/in.h&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;arpa/inet.h&gt;<BR>
</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;inet_aton(</span><span style="color:#0000ff;">const</span><span style="color:#000000;">&nbsp;</span><span style="color:#8000ff;">char</span><span style="color:#000000;">&nbsp;*cp,&nbsp;</span><span style="color:#0000ff;">struct</span><span style="color:#000000;">&nbsp;in_addr&nbsp;*inp);<BR>
in_addr_t&nbsp;inet_addr(</span><span style="color:#0000ff;">const</span><span style="color:#000000;">&nbsp;</span><span style="color:#8000ff;">char</span><span style="color:#000000;">&nbsp;*cp);<BR>
</span><span style="color:#8000ff;">char</span><span style="color:#000000;">&nbsp;*inet_ntoa(</span><span style="color:#0000ff;">struct</span><span style="color:#000000;">&nbsp;in_addr&nbsp;in);</span></div></td></tr></table></div>
<br> âœ¦ åªèƒ½å¤„ç†IPv4çš„ipåœ°å€
<br> âœ¦ ä¸å¯é‡å…¥å‡½æ•°
<br> âœ¦ æ³¨æ„å‚æ•°æ˜¯struct in_addr
<br> â™š ç°åœ¨ï¼š
<br><div style="width:100%;border:1px #e3e3e3 solid;"><div style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;border-bottom:1px solid #e3e3e3;margin-top:5px;color:#000000;">&nbsp;C++ Code&nbsp;</div><table style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;vertical-align:text-top;line-height:15px;" border="0" cellspacing="0" cellpadding="0"><tr><td style="color:#008284;background-color:#e3e3e3;vertical-align:text-top;"><div style="margin:7px;text-align:right;white-space:nowrap;"><nobr>1<br>2<br>3<br>4<br>5<br></nobr></div></td><td style="background-color:#008284;padding:1px;"><div style="border:1px #008284 solid;"></div></td><td style="background-color:#efefef;width:100%;vertical-align:text-top;color:#000000;"><div style="margin:7px;"><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;arpa/inet.h&gt;<BR>
</span><span style="color:#008000;">//&nbsp;å­—ç¬¦ä¸²&nbsp;â†’&nbsp;ç½‘ç»œå­—èŠ‚åº<BR>
</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;inet_pton(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;af,&nbsp;</span><span style="color:#0000ff;">const</span><span style="color:#000000;">&nbsp;</span><span style="color:#8000ff;">char</span><span style="color:#000000;">&nbsp;*src,&nbsp;</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;*dst);<BR>
</span><span style="color:#008000;">//&nbsp;ç½‘ç»œå­—èŠ‚åº&nbsp;â†’&nbsp;ç‚¹åˆ†åè¿›åˆ¶å­—ç¬¦ä¸²<BR>
</span><span style="color:#0000ff;">const</span><span style="color:#000000;">&nbsp;</span><span style="color:#8000ff;">char</span><span style="color:#000000;">&nbsp;*inet_ntop(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;af,&nbsp;</span><span style="color:#0000ff;">const</span><span style="color:#000000;">&nbsp;</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;*src,&nbsp;</span><span style="color:#8000ff;">char</span><span style="color:#000000;">&nbsp;*dst,&nbsp;socklen_t&nbsp;size);</span></div></td></tr></table></div>
<br> â™š å‚æ•° afï¼šæŒ‡å®šIPv4 (AF_INET) æˆ–è€…IPv6 (AF_INET6)
<br> â™š å‚æ•°srcï¼šç‚¹åˆ†åè¿›åˆ¶çš„IPå­—ç¬¦ä¸²
<br> â™š å‚æ•°dstï¼šä¼ å‡ºå‚æ•°ï¼Œè½¬æ¢æˆä»€ä¹ˆæ ·å½¢å¼çš„æ•°å€¼
<br> â™š å‚æ•°sizeï¼šdst å­—ç¬¦ä¸²çš„å¤§å°
<br> â™š æ”¯æŒIPv4å’ŒIPv6
<br>
<br><font color=black size = 5><a name="bc3">å¯é‡å…¥å‡½æ•°</a></font>
<br> âœ¦ å…¶ä¸­inet_ptonå’Œinet_ntopä¸ä»…å¯ä»¥è½¬æ¢IPv4çš„in_addrï¼Œè¿˜å¯ä»¥è½¬æ¢IPv6çš„in6_addrã€‚
<br> âœ¦ å› æ­¤å‡½æ•°æ¥å£æ˜¯void *addrptrã€‚
<br>
<br><font color=black size = 5><a name="bc4">sockaddr æ•°æ®ç»“æ„</a></font>
<br> âœ¦ strcut sockaddr å¾ˆå¤šç½‘ç»œç¼–ç¨‹å‡½æ•°è¯ç”Ÿæ—©äºIPv4åè®®ï¼Œé‚£æ—¶å€™éƒ½ä½¿ç”¨çš„æ˜¯sockaddrç»“æ„ä½“,ä¸ºäº†å‘å‰å…¼å®¹ï¼Œç°åœ¨sockaddré€€åŒ–æˆäº†ï¼ˆvoid *ï¼‰çš„ä½œç”¨ï¼Œä¼ é€’ä¸€ä¸ªåœ°å€ç»™å‡½æ•°ï¼Œè‡³äºè¿™ä¸ªå‡½æ•°æ˜¯sockaddr_inè¿˜æ˜¯sockaddr_in6ï¼Œç”±åœ°å€æ—ç¡®å®šï¼Œç„¶åå‡½æ•°å†…éƒ¨å†å¼ºåˆ¶ç±»å‹è½¬åŒ–ä¸ºæ‰€éœ€çš„åœ°å€ç±»å‹ã€‚
<br><img src="https://github.com/oubc/oubc.github.io/blob/master/images/L24_SocketCode4.png?raw=true" width="800" height="900" />
<br><div style="width:100%;border:1px #e3e3e3 solid;"><div style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;border-bottom:1px solid #e3e3e3;margin-top:5px;color:#000000;">&nbsp;C++ Code&nbsp;</div><table style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;vertical-align:text-top;line-height:15px;" border="0" cellspacing="0" cellpadding="0"><tr><td style="color:#008284;background-color:#e3e3e3;vertical-align:text-top;"><div style="margin:7px;text-align:right;white-space:nowrap;"><nobr>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br></nobr></div></td><td style="background-color:#008284;padding:1px;"><div style="border:1px #008284 solid;"></div></td><td style="background-color:#efefef;width:100%;vertical-align:text-top;color:#000000;"><div style="margin:7px;"><span style="color:#0000ff;">struct</span><span style="color:#000000;">&nbsp;sockaddr<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;sa_family_t&nbsp;sa_family;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">/*&nbsp;address&nbsp;family,&nbsp;AF_xxx&nbsp;*/</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#8000ff;">char</span><span style="color:#000000;">&nbsp;sa_data[</span><span style="color:#ff0000;">14</span><span style="color:#000000;">];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">/*&nbsp;14&nbsp;bytes&nbsp;of&nbsp;protocol&nbsp;address&nbsp;*/</span><span style="color:#000000;"><BR>
};<BR>
<BR>
</span><span style="color:#0000ff;">struct</span><span style="color:#000000;">&nbsp;sockaddr_in<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">/*&nbsp;Address&nbsp;family&nbsp;åœ°å€ç»“æ„ç±»å‹AF_INET/AF_INET6*/</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;__kernel_sa_family_t&nbsp;sin_family;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;__be16&nbsp;sin_port;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">/*&nbsp;Port&nbsp;number&nbsp;ç«¯å£å·*/</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">struct</span><span style="color:#000000;">&nbsp;in_addr&nbsp;sin_addr;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">/*&nbsp;Internet&nbsp;address&nbsp;&nbsp;IPåœ°å€*/</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">/*&nbsp;Pad&nbsp;to&nbsp;size&nbsp;of&nbsp;`struct&nbsp;sockaddr'.&nbsp;*/</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#8000ff;">unsigned</span><span style="color:#000000;">&nbsp;</span><span style="color:#8000ff;">char</span><span style="color:#000000;">&nbsp;__pad[__SOCK_SIZE__&nbsp;-&nbsp;</span><span style="color:#0000ff;">sizeof</span><span style="color:#000000;">(</span><span style="color:#8000ff;">short</span><span style="color:#000000;">&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">)&nbsp;-<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">sizeof</span><span style="color:#000000;">(</span><span style="color:#8000ff;">unsigned</span><span style="color:#000000;">&nbsp;</span><span style="color:#8000ff;">short</span><span style="color:#000000;">&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">)&nbsp;-&nbsp;</span><span style="color:#0000ff;">sizeof</span><span style="color:#000000;">(</span><span style="color:#0000ff;">struct</span><span style="color:#000000;">&nbsp;in_addr)];<BR>
};</span></div></td></tr></table></div>
<br> â™š ä½¿ç”¨ sudo grep -r &quot;struct sockaddr_in {&quot;  /usr å‘½ä»¤å¯æŸ¥çœ‹åˆ°struct sockaddr_inç»“æ„ä½“çš„å®šä¹‰ã€‚ä¸€èˆ¬å…¶é»˜è®¤çš„å­˜å‚¨ä½ç½®ï¼š/usr/include/linux/in.h æ–‡ä»¶ä¸­ã€‚
<br> â™š é‡è¦çš„å°±ä¸‰ä¸ªæˆå‘˜ï¼šsin_familyã€sin_portã€sin_addrï¼›
<br> ğŸ¤  æ³¨ï¼šsin_addr ä¹Ÿæ˜¯ä¸€ä¸ªç»“æ„ä½“ç±»å‹ï¼Œåœ¨å®šä¹‰ struct sockaddr_in ç±»å‹æ—¶éœ€è¦.sin_addr.s_addr=ntoslã€inet_ptonã€inet_ntopè½¬æ¢å‡½æ•°ï¼Œæ‰èƒ½ç»™è¯¥æˆå‘˜ä¼ å€¼ï¼Œåœ¨ä½¿ç”¨bindã€acceptã€connectå‡½æ•°ä¼ å‚æ—¶åº”è¯¥å°†æ­¤å˜é‡å¼ºåˆ¶è½¬æ¢ (struct sockaddr *)&amp;å˜é‡
<br><div style="width:100%;border:1px #e3e3e3 solid;"><div style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;border-bottom:1px solid #e3e3e3;margin-top:5px;color:#000000;">&nbsp;C++ Code&nbsp;</div><table style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;vertical-align:text-top;line-height:15px;" border="0" cellspacing="0" cellpadding="0"><tr><td style="color:#008284;background-color:#e3e3e3;vertical-align:text-top;"><div style="margin:7px;text-align:right;white-space:nowrap;"><nobr>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br></nobr></div></td><td style="background-color:#008284;padding:1px;"><div style="border:1px #008284 solid;"></div></td><td style="background-color:#efefef;width:100%;vertical-align:text-top;color:#000000;"><div style="margin:7px;"><span style="color:#0000ff;">struct</span><span style="color:#000000;">&nbsp;in_addr<BR>
{&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">/*&nbsp;Internet&nbsp;address.&nbsp;*/</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;__be32&nbsp;&nbsp;s_addr;<BR>
};<BR>
<BR>
</span><span style="color:#0000ff;">struct</span><span style="color:#000000;">&nbsp;sockaddr_in6<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#8000ff;">unsigned</span><span style="color:#000000;">&nbsp;</span><span style="color:#8000ff;">short</span><span style="color:#000000;">&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;sin6_family;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">/*&nbsp;AF_INET6&nbsp;*/</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;__be16&nbsp;sin6_port;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">/*&nbsp;Transport&nbsp;layer&nbsp;port&nbsp;#&nbsp;*/</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;__be32&nbsp;sin6_flowinfo;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">/*&nbsp;IPv6&nbsp;flow&nbsp;information&nbsp;*/</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">struct</span><span style="color:#000000;">&nbsp;in6_addr&nbsp;sin6_addr;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">/*&nbsp;IPv6&nbsp;address&nbsp;*/</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;__u32&nbsp;sin6_scope_id;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">/*&nbsp;scope&nbsp;id&nbsp;(new&nbsp;in&nbsp;RFC2553)&nbsp;*/</span><span style="color:#000000;"><BR>
};<BR>
<BR>
</span><span style="color:#0000ff;">struct</span><span style="color:#000000;">&nbsp;in6_addr<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">union</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__u8&nbsp;u6_addr8[</span><span style="color:#ff0000;">16</span><span style="color:#000000;">];<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__be16&nbsp;u6_addr16[</span><span style="color:#ff0000;">8</span><span style="color:#000000;">];<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__be32&nbsp;u6_addr32[</span><span style="color:#ff0000;">4</span><span style="color:#000000;">];<BR>
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;in6_u;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">#define</span><span style="color:#000000;">&nbsp;s6_addr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in6_u.u6_addr8<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">#define</span><span style="color:#000000;">&nbsp;s6_addr16&nbsp;&nbsp;&nbsp;in6_u.u6_addr16<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">#define</span><span style="color:#000000;">&nbsp;s6_addr32&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in6_u.u6_addr32<BR>
};<BR>
<BR>
</span><span style="color:#0000ff;">#define</span><span style="color:#000000;">&nbsp;UNIX_PATH_MAX&nbsp;</span><span style="color:#ff0000;">108</span><span style="color:#000000;"><BR>
</span><span style="color:#0000ff;">struct</span><span style="color:#000000;">&nbsp;sockaddr_un<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;__kernel_sa_family_t&nbsp;sun_family;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">/*&nbsp;AF_UNIX&nbsp;*/</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#8000ff;">char</span><span style="color:#000000;">&nbsp;sun_path[UNIX_PATH_MAX];&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">/*&nbsp;pathname&nbsp;*/</span><span style="color:#000000;"><BR>
};</span></div></td></tr></table></div>
<br> âœ¦ IPv4å’ŒIPv6çš„åœ°å€æ ¼å¼å®šä¹‰åœ¨netinet/in.hä¸­ï¼ŒIPv4åœ°å€ç”¨sockaddr_inç»“æ„ä½“è¡¨ç¤ºï¼ŒåŒ…æ‹¬16ä½ç«¯å£å·å’Œ32ä½IPåœ°å€ï¼ŒIPv6åœ°å€ç”¨sockaddr_in6ç»“æ„ä½“è¡¨ç¤ºï¼ŒåŒ…æ‹¬16ä½ç«¯å£å·ã€128ä½IPåœ°å€å’Œä¸€äº›æ§åˆ¶å­—æ®µã€‚UNIX Domain Socketçš„åœ°å€æ ¼å¼å®šä¹‰åœ¨sys/un.hä¸­ï¼Œç”¨sock-addr_unç»“æ„ä½“è¡¨ç¤ºã€‚å„ç§socketåœ°å€ç»“æ„ä½“çš„å¼€å¤´éƒ½æ˜¯ç›¸åŒçš„ï¼Œå‰16ä½è¡¨ç¤ºæ•´ä¸ªç»“æ„ä½“çš„é•¿åº¦ï¼ˆå¹¶ä¸æ˜¯æ‰€æœ‰UNIXçš„å®ç°éƒ½æœ‰é•¿åº¦å­—æ®µï¼Œå¦‚Linuxå°±æ²¡æœ‰ï¼‰ï¼Œå16ä½è¡¨ç¤ºåœ°å€ç±»å‹ã€‚IPv4ã€IPv6å’ŒUnix Domain Socketçš„åœ°å€ç±»å‹åˆ†åˆ«å®šä¹‰ä¸ºå¸¸æ•°AF_INETã€AF_INET6ã€AF_UNIXã€‚è¿™æ ·ï¼Œåªè¦å–å¾—æŸç§sockaddrç»“æ„ä½“çš„é¦–åœ°å€ï¼Œä¸éœ€è¦çŸ¥é“å…·ä½“æ˜¯å“ªç§ç±»å‹çš„sockaddrç»“æ„ä½“ï¼Œå°±å¯ä»¥æ ¹æ®åœ°å€ç±»å‹å­—æ®µç¡®å®šç»“æ„ä½“ä¸­çš„å†…å®¹ã€‚å› æ­¤ï¼Œsocket APIå¯ä»¥æ¥å—å„ç§ç±»å‹çš„sockaddrç»“æ„ä½“æŒ‡é’ˆåšå‚æ•°ï¼Œä¾‹å¦‚bindã€acceptã€connectç­‰å‡½æ•°ï¼Œè¿™äº›å‡½æ•°çš„å‚æ•°åº”è¯¥è®¾è®¡æˆvoid *ç±»å‹ä»¥ä¾¿æ¥å—å„ç§ç±»å‹çš„æŒ‡é’ˆï¼Œä½†æ˜¯sock APIçš„å®ç°æ—©äºANSI Cæ ‡å‡†åŒ–ï¼Œé‚£æ—¶è¿˜æ²¡æœ‰void *ç±»å‹ï¼Œå› æ­¤è¿™äº›å‡½æ•°çš„å‚æ•°éƒ½ç”¨struct sockaddr *ç±»å‹è¡¨ç¤ºï¼Œåœ¨ä¼ é€’å‚æ•°ä¹‹å‰è¦å¼ºåˆ¶ç±»å‹è½¬æ¢ä¸€ä¸‹ï¼Œä¾‹å¦‚ï¼š
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct sockaddr_in servaddr;
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bind(listen_fd, (struct sockaddr *)&amp;servaddr, sizeof(servaddr));     /* initialize servaddr */
<br>
<br><font color=black size = 5><a name="bc5">socketæ¨¡å‹åˆ›å»º</a></font>
<br> ğŸ¤  socketæ¨¡å‹åˆ›å»ºæµç¨‹å›¾
<br><img src="https://github.com/oubc/oubc.github.io/blob/master/images/L24_SocketCode5.png?raw=true" width="800" height="1000" />
<br>
<br><font color=black size = 5><a name="bc6">socket() å‡½æ•°</a></font>
<br> ğŸ¤  åˆ›å»ºä¸€ä¸ªå¥—æ¥å­—
<br><div style="width:100%;border:1px #e3e3e3 solid;"><div style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;border-bottom:1px solid #e3e3e3;margin-top:5px;color:#000000;">&nbsp;C++ Code&nbsp;</div><table style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;vertical-align:text-top;line-height:15px;" border="0" cellspacing="0" cellpadding="0"><tr><td style="color:#008284;background-color:#e3e3e3;vertical-align:text-top;"><div style="margin:7px;text-align:right;white-space:nowrap;"><nobr>1<br>2<br>3<br></nobr></div></td><td style="background-color:#008284;padding:1px;"><div style="border:1px #008284 solid;"></div></td><td style="background-color:#efefef;width:100%;vertical-align:text-top;color:#000000;"><div style="margin:7px;"><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;sys/types.h&gt;&nbsp;</span><span style="color:#008000;">/*&nbsp;See&nbsp;NOTES&nbsp;*/</span><span style="color:#000000;"><BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;sys/socket.h&gt;<BR>
</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;socket(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;domain,&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;type,&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;protocol);</span></div></td></tr></table></div>
<br> â™š domain:
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AF_INET è¿™æ˜¯å¤§å¤šæ•°ç”¨æ¥äº§ç”Ÿsocketçš„åè®®ï¼Œä½¿ç”¨TCPæˆ–UDPæ¥ä¼ è¾“ï¼Œç”¨IPv4çš„åœ°å€
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AF_INET6 ä¸ä¸Šé¢ç±»ä¼¼ï¼Œä¸è¿‡æ˜¯æ¥ç”¨IPv6çš„åœ°å€
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AF_UNIX(æœ¬åœ°å¥—æ¥å­—) æœ¬åœ°åè®®ï¼Œä½¿ç”¨åœ¨Unixå’ŒLinuxç³»ç»Ÿä¸Šï¼Œä¸€èˆ¬éƒ½æ˜¯å½“å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨åœ¨åŒä¸€å°åŠå…¶ä¸Šçš„æ—¶å€™ä½¿ç”¨
<br> â™š typeï¼šé‡‡ç”¨çš„Socketçš„å†…éƒ¨é€‰ç”¨çš„é€šä¿¡åè®®
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SOCK_STREAM(æµå¼åè®®)  è¿™ä¸ªåè®®æ˜¯æŒ‰ç…§é¡ºåºçš„ã€å¯é çš„ã€æ•°æ®å®Œæ•´çš„åŸºäºå­—èŠ‚æµçš„è¿æ¥ã€‚è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨æœ€å¤šçš„socketç±»å‹ï¼Œè¿™ä¸ªsocketæ˜¯ä½¿ç”¨TCPæ¥è¿›è¡Œä¼ è¾“ã€‚
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SOCK_DGRAM(æŠ¥å¼åè®®)  è¿™ä¸ªåè®®æ˜¯æ— è¿æ¥çš„ã€å›ºå®šé•¿åº¦çš„ä¼ è¾“è°ƒç”¨ã€‚è¯¥åè®®æ˜¯ä¸å¯é çš„ï¼Œä½¿ç”¨UDPæ¥è¿›è¡Œå®ƒçš„è¿æ¥ã€‚
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SOCK_SEQPACKETè¯¥åè®®æ˜¯åŒçº¿è·¯çš„ã€å¯é çš„è¿æ¥ï¼Œå‘é€å›ºå®šé•¿åº¦çš„æ•°æ®åŒ…è¿›è¡Œä¼ è¾“ã€‚å¿…é¡»æŠŠè¿™ä¸ªåŒ…å®Œæ•´çš„æ¥å—æ‰èƒ½è¿›è¡Œè¯»å–ã€‚
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SOCK_RAW socketç±»å‹æä¾›å•ä¸€çš„ç½‘ç»œè®¿é—®ï¼Œè¿™ä¸ªsocketç±»å‹ä½¿ç”¨ICMPå…¬å…±åè®®ã€‚ï¼ˆpingã€tracerouteä½¿ç”¨è¯¥åè®®ï¼‰
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SOCK_RDM è¿™ä¸ªç±»å‹æ˜¯å¾ˆå°‘ä½¿ç”¨çš„ï¼Œåœ¨å¤§éƒ¨åˆ†çš„æ“ä½œç³»ç»Ÿä¸Šæ²¡æœ‰å®ç°ï¼Œå®ƒæ˜¯æä¾›ç»™æ•°æ®é“¾è·¯å±‚ä½¿ç”¨ï¼Œä¸ä¿è¯æ•°æ®åŒ…çš„é¡ºåº
<br> â™š protocol:
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ä¼ 0 è¡¨ç¤ºä½¿ç”¨é»˜è®¤åè®®ã€‚
<br> â™š è¿”å›å€¼ï¼š
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; æˆåŠŸï¼šè¿”å›æŒ‡å‘æ–°åˆ›å»ºçš„socketçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¤±è´¥ï¼šè¿”å›-1ï¼Œè®¾ç½®errno
<br> âœ¦ socket()æ‰“å¼€ä¸€ä¸ªç½‘ç»œé€šè®¯ç«¯å£ï¼Œå¦‚æœæˆåŠŸçš„è¯ï¼Œå°±åƒopen()ä¸€æ ·è¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥åƒè¯»å†™æ–‡ä»¶ä¸€æ ·ç”¨read/writeåœ¨ç½‘ç»œä¸Šæ”¶å‘æ•°æ®ï¼Œå¦‚æœsocket()è°ƒç”¨å‡ºé”™åˆ™è¿”å›-1ã€‚å¯¹äºIPv4ï¼Œdomainå‚æ•°æŒ‡å®šä¸ºAF_INETã€‚å¯¹äºTCPåè®®ï¼Œtypeå‚æ•°æŒ‡å®šä¸ºSOCK_STREAMï¼Œè¡¨ç¤ºé¢å‘æµçš„ä¼ è¾“åè®®ã€‚å¦‚æœæ˜¯UDPåè®®ï¼Œåˆ™typeå‚æ•°æŒ‡å®šä¸ºSOCK_DGRAMï¼Œè¡¨ç¤ºé¢å‘æ•°æ®æŠ¥çš„ä¼ è¾“åè®®ã€‚protocolå‚æ•°çš„ä»‹ç»ä»ç•¥ï¼ŒæŒ‡å®šä¸º0å³å¯ã€‚
<br>
<br><font color=black size = 5><a name="bc7">bind() å‡½æ•°</a></font>
<br> ğŸ¤  ç»‘å®šç«¯å£å·å’ŒIP
<br><div style="width:100%;border:1px #e3e3e3 solid;"><div style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;border-bottom:1px solid #e3e3e3;margin-top:5px;color:#000000;">&nbsp;C++ Code&nbsp;</div><table style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;vertical-align:text-top;line-height:15px;" border="0" cellspacing="0" cellpadding="0"><tr><td style="color:#008284;background-color:#e3e3e3;vertical-align:text-top;"><div style="margin:7px;text-align:right;white-space:nowrap;"><nobr>1<br>2<br>3<br></nobr></div></td><td style="background-color:#008284;padding:1px;"><div style="border:1px #008284 solid;"></div></td><td style="background-color:#efefef;width:100%;vertical-align:text-top;color:#000000;"><div style="margin:7px;"><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;sys/types.h&gt;&nbsp;</span><span style="color:#008000;">/*&nbsp;See&nbsp;NOTES&nbsp;*/</span><span style="color:#000000;"><BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;sys/socket.h&gt;<BR>
</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;bind(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;sockfd,&nbsp;</span><span style="color:#0000ff;">const</span><span style="color:#000000;">&nbsp;</span><span style="color:#0000ff;">struct</span><span style="color:#000000;">&nbsp;sockaddr&nbsp;*addr,&nbsp;socklen_t&nbsp;addrlen);</span></div></td></tr></table></div>
<br> â™š sockfd(socketå‡½æ•°è¿”å›å€¼)ï¼š
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; socketæ–‡ä»¶æè¿°ç¬¦
<br> â™š addr:
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; æ„é€ å‡ºIPåœ°å€åŠ ç«¯å£å·
<br> â™š addrlen:
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sizeof(addr)é•¿åº¦
<br> â™š è¿”å›å€¼ï¼š
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1, è®¾ç½®errno
<br> âœ¦ æœåŠ¡å™¨ç¨‹åºæ‰€ç›‘å¬çš„ç½‘ç»œåœ°å€å’Œç«¯å£å·é€šå¸¸æ˜¯å›ºå®šä¸å˜çš„ï¼Œå®¢æˆ·ç«¯ç¨‹åºå¾—çŸ¥æœåŠ¡å™¨ç¨‹åºçš„åœ°å€å’Œç«¯å£å·åå°±å¯ä»¥å‘æœåŠ¡å™¨å‘èµ·è¿æ¥ï¼Œå› æ­¤æœåŠ¡å™¨éœ€è¦è°ƒç”¨bindç»‘å®šä¸€ä¸ªå›ºå®šçš„ç½‘ç»œåœ°å€å’Œç«¯å£å·ã€‚
<br> âœ¦ bind()çš„ä½œç”¨æ˜¯å°†å‚æ•°sockfdå’Œaddrç»‘å®šåœ¨ä¸€èµ·ï¼Œä½¿sockfdè¿™ä¸ªç”¨äºç½‘ç»œé€šè®¯çš„æ–‡ä»¶æè¿°ç¬¦ç›‘å¬addræ‰€æè¿°çš„åœ°å€å’Œç«¯å£å·ã€‚å‰é¢è®²è¿‡ï¼Œstruct sockaddr *æ˜¯ä¸€ä¸ªé€šç”¨æŒ‡é’ˆç±»å‹ï¼Œaddrå‚æ•°å®é™…ä¸Šå¯ä»¥æ¥å—å¤šç§åè®®çš„sockaddrç»“æ„ä½“ï¼Œè€Œå®ƒä»¬çš„é•¿åº¦å„ä¸ç›¸åŒï¼Œæ‰€ä»¥éœ€è¦ç¬¬ä¸‰ä¸ªå‚æ•°addrlenæŒ‡å®šç»“æ„ä½“çš„é•¿åº¦ã€‚å¦‚ï¼š
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct sockaddr_in servaddr;
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bzero(&amp;servaddr, sizeof(servaddr));
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; servaddr.sin_family = AF_INET;
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; servaddr.sin_addr.s_addr = htonl(INADDR_ANY);
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; servaddr.sin_port = htons(6666);
<br> âœ¦ é¦–å…ˆå°†æ•´ä¸ªç»“æ„ä½“æ¸…é›¶ï¼Œç„¶åè®¾ç½®åœ°å€ç±»å‹ä¸ºAF_INETï¼Œç½‘ç»œåœ°å€ä¸ºINADDR_ANYï¼Œè¿™ä¸ªå®è¡¨ç¤ºæœ¬åœ°çš„ä»»æ„IPåœ°å€ï¼Œå› ä¸ºæœåŠ¡å™¨å¯èƒ½æœ‰å¤šä¸ªç½‘å¡ï¼Œæ¯ä¸ªç½‘å¡ä¹Ÿå¯èƒ½ç»‘å®šå¤šä¸ªIPåœ°å€ï¼Œè¿™æ ·è®¾ç½®å¯ä»¥åœ¨æ‰€æœ‰çš„IPåœ°å€ä¸Šç›‘å¬ï¼Œç›´åˆ°ä¸æŸä¸ªå®¢æˆ·ç«¯å»ºç«‹äº†è¿æ¥æ—¶æ‰ç¡®å®šä¸‹æ¥åˆ°åº•ç”¨å“ªä¸ªIPåœ°å€ï¼Œç«¯å£å·ä¸º6666ã€‚
<br>
<br><font color=black size = 5><a name="bc8">listen() å‡½æ•°</a></font>
<br> ğŸ¤  æŒ‡å®šç›‘å¬ä¸Šé™æ•°ï¼Œä»…ä»…æ˜¯æŒ‡å®šä¸€ä¸ªæ•°å€¼ï¼Œæ— å…¶å®ƒä½œç”¨
<br> âœ¦ åŒæ—¶ å…è®¸ å¤šå°‘ä¸ªå®¢æˆ·ç«¯åŒæ—¶ä¸æœåŠ¡å™¨å»ºç«‹è¿æ¥(å¤„äºä¸‰æ¬¡æ¡æ‰‹çš„æ•°é‡åº”è¯¥æ˜¯å¤šå°‘ä¸ª)ï¼Œè¶…å‡ºå®¢æˆ·ç«¯ä¼šé˜»å¡ç­‰å¾… (ä¸æ˜¯ä¸€å…±èƒ½æ”¯æŒå¤šå°‘å®¢æˆ·ç«¯å»ºç«‹è¿æ¥)
<br><div style="width:100%;border:1px #e3e3e3 solid;"><div style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;border-bottom:1px solid #e3e3e3;margin-top:5px;color:#000000;">&nbsp;C++ Code&nbsp;</div><table style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;vertical-align:text-top;line-height:15px;" border="0" cellspacing="0" cellpadding="0"><tr><td style="color:#008284;background-color:#e3e3e3;vertical-align:text-top;"><div style="margin:7px;text-align:right;white-space:nowrap;"><nobr>1<br>2<br>3<br></nobr></div></td><td style="background-color:#008284;padding:1px;"><div style="border:1px #008284 solid;"></div></td><td style="background-color:#efefef;width:100%;vertical-align:text-top;color:#000000;"><div style="margin:7px;"><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;sys/types.h&gt;&nbsp;</span><span style="color:#008000;">/*&nbsp;See&nbsp;NOTES&nbsp;*/</span><span style="color:#000000;"><BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;sys/socket.h&gt;<BR>
</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;listen(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;sockfd,&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;backlog);</span></div></td></tr></table></div>
<br> â™š sockfd:
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; socketæ–‡ä»¶æè¿°ç¬¦
<br> â™š backlog:
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; æ’é˜Ÿå»ºç«‹3æ¬¡æ¡æ‰‹é˜Ÿåˆ—å’Œåˆšåˆšå»ºç«‹3æ¬¡æ¡æ‰‹é˜Ÿåˆ—çš„é“¾æ¥æ•°å’Œ
<br> â™š æŸ¥çœ‹ç³»ç»Ÿé»˜è®¤backlog
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cat /proc/sys/net/ipv4/tcp_max_syn_backlog
<br> âœ¦ å…¸å‹çš„æœåŠ¡å™¨ç¨‹åºå¯ä»¥åŒæ—¶æœåŠ¡äºå¤šä¸ªå®¢æˆ·ç«¯ï¼Œå½“æœ‰å®¢æˆ·ç«¯å‘èµ·è¿æ¥æ—¶ï¼ŒæœåŠ¡å™¨è°ƒç”¨çš„accept()è¿”å›å¹¶æ¥å—è¿™ä¸ªè¿æ¥ï¼Œå¦‚æœæœ‰å¤§é‡çš„å®¢æˆ·ç«¯å‘èµ·è¿æ¥è€ŒæœåŠ¡å™¨æ¥ä¸åŠå¤„ç†ï¼Œå°šæœªacceptçš„å®¢æˆ·ç«¯å°±å¤„äºè¿æ¥ç­‰å¾…çŠ¶æ€ï¼Œlisten()å£°æ˜sockfdå¤„äºç›‘å¬çŠ¶æ€ï¼Œå¹¶ä¸”æœ€å¤šå…è®¸æœ‰backlogä¸ªå®¢æˆ·ç«¯å¤„äºè¿æ¥å¾…çŠ¶æ€ï¼Œå¦‚æœæ¥æ”¶åˆ°æ›´å¤šçš„è¿æ¥è¯·æ±‚å°±å¿½ç•¥ã€‚listen()æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1ã€‚
<br>
<br><font color=black size = 5><a name="bc9">accept() å‡½æ•°</a></font>
<br> ğŸ¤  æ¥å—å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚
<br><div style="width:100%;border:1px #e3e3e3 solid;"><div style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;border-bottom:1px solid #e3e3e3;margin-top:5px;color:#000000;">&nbsp;C++ Code&nbsp;</div><table style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;vertical-align:text-top;line-height:15px;" border="0" cellspacing="0" cellpadding="0"><tr><td style="color:#008284;background-color:#e3e3e3;vertical-align:text-top;"><div style="margin:7px;text-align:right;white-space:nowrap;"><nobr>1<br>2<br>3<br></nobr></div></td><td style="background-color:#008284;padding:1px;"><div style="border:1px #008284 solid;"></div></td><td style="background-color:#efefef;width:100%;vertical-align:text-top;color:#000000;"><div style="margin:7px;"><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;sys/types.h&gt;&nbsp;&nbsp;</span><span style="color:#008000;">/*&nbsp;See&nbsp;NOTES&nbsp;*/</span><span style="color:#000000;"><BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;sys/socket.h&gt;<BR>
</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;accept(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;sockfd,&nbsp;</span><span style="color:#0000ff;">struct</span><span style="color:#000000;">&nbsp;sockaddr&nbsp;*addr,&nbsp;socklen_t&nbsp;*addrlen);</span></div></td></tr></table></div>
<br> â™š sockdf:
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; socketæ–‡ä»¶æè¿°ç¬¦
<br> â™š addr:
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ä¼ å‡ºå‚æ•°ï¼Œè¿”å›é“¾æ¥ å®¢æˆ·ç«¯ åœ°å€ä¿¡æ¯ï¼Œå«IPåœ°å€å’Œç«¯å£å·
<br> â™š addrlen:
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ä¼ å…¥ä¼ å‡ºå‚æ•° (å€¼-ç»“æœ)ï¼Œä¼ å…¥sizeof(addr)å¤§å°ï¼Œå‡½æ•°è¿”å›æ—¶è¿”å›çœŸæ­£æ¥æ”¶åˆ°åœ°å€ç»“æ„ä½“çš„å¤§å°
<br> â™š è¿”å›å€¼ï¼š
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; æˆåŠŸè¿”å›ä¸€ä¸ª æ–°çš„socketæ–‡ä»¶æè¿°ç¬¦ï¼Œç”¨äºå’Œå®¢æˆ·ç«¯é€šä¿¡ï¼Œå¤±è´¥è¿”å›-1ï¼Œè®¾ç½®errno
<br> âœ¦ ä¸‰æ¬¡æ¡æ‰‹å®Œæˆåï¼ŒæœåŠ¡å™¨è°ƒç”¨accept()æ¥å—è¿æ¥ï¼Œå¦‚æœæœåŠ¡å™¨è°ƒç”¨accept()æ—¶è¿˜æ²¡æœ‰å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ï¼Œå°±é˜»å¡ç­‰å¾…ç›´åˆ°æœ‰å®¢æˆ·ç«¯è¿æ¥ä¸Šæ¥ã€‚addræ˜¯ä¸€ä¸ªä¼ å‡ºå‚æ•°ï¼Œaccept()è¿”å›æ—¶ä¼ å‡ºå®¢æˆ·ç«¯çš„åœ°å€å’Œç«¯å£å·ã€‚addrlenå‚æ•°æ˜¯ä¸€ä¸ªä¼ å…¥ä¼ å‡ºå‚æ•°ï¼ˆvalue-result argumentï¼‰ï¼Œä¼ å…¥çš„æ˜¯è°ƒç”¨è€…æä¾›çš„ç¼“å†²åŒºaddrçš„é•¿åº¦ä»¥é¿å…ç¼“å†²åŒºæº¢å‡ºé—®é¢˜ï¼Œä¼ å‡ºçš„æ˜¯å®¢æˆ·ç«¯åœ°å€ç»“æ„ä½“çš„å®é™…é•¿åº¦ï¼ˆæœ‰å¯èƒ½æ²¡æœ‰å æ»¡è°ƒç”¨è€…æä¾›çš„ç¼“å†²åŒºï¼‰ã€‚å¦‚æœç»™addrå‚æ•°ä¼ NULLï¼Œè¡¨ç¤ºä¸å…³å¿ƒå®¢æˆ·ç«¯çš„åœ°å€ã€‚
<br> âœ¦ æˆ‘ä»¬çš„æœåŠ¡å™¨ç¨‹åºç»“æ„æ˜¯è¿™æ ·çš„ï¼š
<br><div style="width:100%;border:1px #e3e3e3 solid;"><div style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;border-bottom:1px solid #e3e3e3;margin-top:5px;color:#000000;">&nbsp;C++ Code&nbsp;</div><table style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;vertical-align:text-top;line-height:15px;" border="0" cellspacing="0" cellpadding="0"><tr><td style="color:#008284;background-color:#e3e3e3;vertical-align:text-top;"><div style="margin:7px;text-align:right;white-space:nowrap;"><nobr>1<br>2<br>3<br>4<br>5<br>6<br>7<br></nobr></div></td><td style="background-color:#008284;padding:1px;"><div style="border:1px #008284 solid;"></div></td><td style="background-color:#efefef;width:100%;vertical-align:text-top;color:#000000;"><div style="margin:7px;"><span style="color:#0000ff;">while</span><span style="color:#000000;">&nbsp;(</span><span style="color:#ff0000;">1</span><span style="color:#000000;">)&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;cliaddr_len&nbsp;=&nbsp;</span><span style="color:#0000ff;">sizeof</span><span style="color:#000000;">(cliaddr);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;connfd&nbsp;=&nbsp;accept(listenfd,&nbsp;(</span><span style="color:#0000ff;">struct</span><span style="color:#000000;">&nbsp;sockaddr&nbsp;*)&amp;cliaddr,&nbsp;&amp;cliaddr_len);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;n&nbsp;=&nbsp;read(connfd,&nbsp;buf,&nbsp;MAXLINE);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;......<BR>
&nbsp;&nbsp;&nbsp;&nbsp;close(connfd);<BR>
}</span></div></td></tr></table></div>
<br> âœ¦ æ•´ä¸ªæ˜¯ä¸€ä¸ªwhileæ­»å¾ªç¯ï¼Œæ¯æ¬¡å¾ªç¯å¤„ç†ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥ã€‚ç”±äºcliaddr_lenæ˜¯ä¼ å…¥ä¼ å‡ºå‚æ•°ï¼Œæ¯æ¬¡è°ƒç”¨accept()ä¹‹å‰åº”è¯¥é‡æ–°èµ‹åˆå€¼ã€‚accept()çš„å‚æ•°listenfdæ˜¯å…ˆå‰çš„ç›‘å¬æ–‡ä»¶æè¿°ç¬¦ï¼Œè€Œaccept()çš„è¿”å›å€¼æ˜¯å¦å¤–ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦connfdï¼Œä¹‹åä¸å®¢æˆ·ç«¯ä¹‹é—´å°±é€šè¿‡è¿™ä¸ªconnfdé€šè®¯ï¼Œæœ€åå…³é—­connfdæ–­å¼€è¿æ¥ï¼Œè€Œä¸å…³é—­listenfdï¼Œå†æ¬¡å›åˆ°å¾ªç¯å¼€å¤´listenfdä»ç„¶ç”¨ä½œacceptçš„å‚æ•°ã€‚accept()æˆåŠŸè¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå‡ºé”™è¿”å›-1ã€‚
<br>
<br><font color=black size = 5><a name="bc10">connect() å‡½æ•°</a></font>
<br> ğŸ¤  å®¢æˆ·ç«¯è°ƒç”¨ï¼Œä¸æœåŠ¡å™¨å»ºç«‹è¿æ¥
<br><div style="width:100%;border:1px #e3e3e3 solid;"><div style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;border-bottom:1px solid #e3e3e3;margin-top:5px;color:#000000;">&nbsp;C++ Code&nbsp;</div><table style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;vertical-align:text-top;line-height:15px;" border="0" cellspacing="0" cellpadding="0"><tr><td style="color:#008284;background-color:#e3e3e3;vertical-align:text-top;"><div style="margin:7px;text-align:right;white-space:nowrap;"><nobr>1<br>2<br>3<br></nobr></div></td><td style="background-color:#008284;padding:1px;"><div style="border:1px #008284 solid;"></div></td><td style="background-color:#efefef;width:100%;vertical-align:text-top;color:#000000;"><div style="margin:7px;"><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;sys/types.h&gt;&nbsp;&nbsp;</span><span style="color:#008000;">/*&nbsp;See&nbsp;NOTES&nbsp;*/</span><span style="color:#000000;"><BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;sys/socket.h&gt;<BR>
</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;connect(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;sockfd,&nbsp;</span><span style="color:#0000ff;">const</span><span style="color:#000000;">&nbsp;</span><span style="color:#0000ff;">struct</span><span style="color:#000000;">&nbsp;sockaddr&nbsp;*addr,&nbsp;socklen_t&nbsp;addrlen);</span></div></td></tr></table></div>
<br> â™š sockdf:
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; socketæ–‡ä»¶æè¿°ç¬¦ï¼Œåœ¨ä¹‹å‰éœ€è¦è°ƒç”¨socketå‡½æ•°å¾—åˆ°socketæ–‡ä»¶æè¿°ç¬¦
<br> â™š addr:
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ä¼ å…¥å‚æ•°ï¼ŒæŒ‡å®šæœåŠ¡å™¨ç«¯åœ°å€ä¿¡æ¯ï¼Œå«IPåœ°å€å’Œç«¯å£å·
<br> â™š addrlen:
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ä¼ å…¥å‚æ•°,ä¼ å…¥sizeof(addr)å¤§å°
<br> â™š è¿”å›å€¼ï¼š
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1ï¼Œè®¾ç½®errno
<br> âœ¦ å®¢æˆ·ç«¯éœ€è¦è°ƒç”¨connect()è¿æ¥æœåŠ¡å™¨ï¼Œconnectå’Œbindçš„å‚æ•°å½¢å¼ä¸€è‡´ï¼ŒåŒºåˆ«åœ¨äºbindçš„å‚æ•°æ˜¯è‡ªå·±çš„åœ°å€ï¼Œè€Œconnectçš„å‚æ•°æ˜¯å¯¹æ–¹çš„åœ°å€ã€‚connect()æˆåŠŸè¿”å›0ï¼Œå‡ºé”™è¿”å›-1ã€‚
<br>
<br><font color=black size = 5><a name="bc11">C/Sæ¨¡å‹-TCP</a></font>
<br> ğŸ¤  ä¸‹å›¾æ˜¯åŸºäºTCPåè®®çš„å®¢æˆ·ç«¯/æœåŠ¡å™¨ç¨‹åºçš„ä¸€èˆ¬æµç¨‹ï¼š
<br><img src="https://github.com/oubc/oubc.github.io/blob/master/images/L24_SocketCode6.png?raw=true" width="800" height="800" />
<br> âœ¦ æœåŠ¡å™¨è°ƒç”¨socket()ã€bind()ã€listen()å®Œæˆåˆå§‹åŒ–åï¼Œè°ƒç”¨accept()é˜»å¡ç­‰å¾…ï¼Œå¤„äºç›‘å¬ç«¯å£çš„çŠ¶æ€ï¼Œå®¢æˆ·ç«¯è°ƒç”¨socket()åˆå§‹åŒ–åï¼Œè°ƒç”¨connect()å‘å‡ºSYNæ®µå¹¶é˜»å¡ç­‰å¾…æœåŠ¡å™¨åº”ç­”ï¼ŒæœåŠ¡å™¨åº”ç­”ä¸€ä¸ªSYN-ACKæ®µï¼Œå®¢æˆ·ç«¯æ”¶åˆ°åä»connect()è¿”å›ï¼ŒåŒæ—¶åº”ç­”ä¸€ä¸ªACKæ®µï¼ŒæœåŠ¡å™¨æ”¶åˆ°åä»accept()è¿”å›ã€‚
<br> âœ¦ æ•°æ®ä¼ è¾“çš„è¿‡ç¨‹ï¼š
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; å»ºç«‹è¿æ¥åï¼ŒTCPåè®®æä¾›å…¨åŒå·¥çš„é€šä¿¡æœåŠ¡ï¼Œä½†æ˜¯ä¸€èˆ¬çš„å®¢æˆ·ç«¯/æœåŠ¡å™¨ç¨‹åºçš„æµç¨‹æ˜¯ç”±å®¢æˆ·ç«¯ä¸»åŠ¨å‘èµ·è¯·æ±‚ï¼ŒæœåŠ¡å™¨è¢«åŠ¨å¤„ç†è¯·æ±‚ï¼Œä¸€é—®ä¸€ç­”çš„æ–¹å¼ã€‚å› æ­¤ï¼ŒæœåŠ¡å™¨ä»accept()è¿”å›åç«‹åˆ»è°ƒç”¨read()ï¼Œè¯»socketå°±åƒè¯»ç®¡é“ä¸€æ ·ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®åˆ°è¾¾å°±é˜»å¡ç­‰å¾…ï¼Œè¿™æ—¶å®¢æˆ·ç«¯è°ƒç”¨write()å‘é€è¯·æ±‚ç»™æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨æ”¶åˆ°åä»read()è¿”å›ï¼Œå¯¹å®¢æˆ·ç«¯çš„è¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œåœ¨æ­¤æœŸé—´å®¢æˆ·ç«¯è°ƒç”¨read()é˜»å¡ç­‰å¾…æœåŠ¡å™¨çš„åº”ç­”ï¼ŒæœåŠ¡å™¨è°ƒç”¨write()å°†å¤„ç†ç»“æœå‘å›ç»™å®¢æˆ·ç«¯ï¼Œå†æ¬¡è°ƒç”¨read()é˜»å¡ç­‰å¾…ä¸‹ä¸€æ¡è¯·æ±‚ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°åä»read()è¿”å›ï¼Œå‘é€ä¸‹ä¸€æ¡è¯·æ±‚ï¼Œå¦‚æ­¤å¾ªç¯ä¸‹å»ã€‚
<br> âœ¦ å¦‚æœå®¢æˆ·ç«¯æ²¡æœ‰æ›´å¤šçš„è¯·æ±‚äº†ï¼Œå°±è°ƒç”¨close()å…³é—­è¿æ¥ï¼Œå°±åƒå†™ç«¯å…³é—­çš„ç®¡é“ä¸€æ ·ï¼ŒæœåŠ¡å™¨çš„read()è¿”å›0ï¼Œè¿™æ ·æœåŠ¡å™¨å°±çŸ¥é“å®¢æˆ·ç«¯å…³é—­äº†è¿æ¥ï¼Œä¹Ÿè°ƒç”¨close()å…³é—­è¿æ¥ã€‚æ³¨æ„ï¼Œä»»ä½•ä¸€æ–¹è°ƒç”¨close()åï¼Œè¿æ¥çš„ä¸¤ä¸ªä¼ è¾“æ–¹å‘éƒ½å…³é—­ï¼Œä¸èƒ½å†å‘é€æ•°æ®äº†ã€‚å¦‚æœä¸€æ–¹è°ƒç”¨shutdown()åˆ™è¿æ¥å¤„äºåŠå…³é—­çŠ¶æ€ï¼Œä»å¯æ¥æ”¶å¯¹æ–¹å‘æ¥çš„æ•°æ®ã€‚
<br> âœ¦ åº”ç”¨ç¨‹åºè°ƒç”¨æŸä¸ªsocketå‡½æ•°æ—¶TCPåè®®å±‚å®Œæˆä»€ä¹ˆåŠ¨ä½œï¼Œæ¯”å¦‚è°ƒç”¨connect()ä¼šå‘å‡ºSYNæ®µ åº”ç”¨ç¨‹åºå¦‚ä½•çŸ¥é“TCPåè®®å±‚çš„çŠ¶æ€å˜åŒ–ï¼Œæ¯”å¦‚ä»æŸä¸ªé˜»å¡çš„socketå‡½æ•°è¿”å›å°±è¡¨æ˜TCPåè®®æ”¶åˆ°äº†æŸäº›æ®µï¼Œå†æ¯”å¦‚read()è¿”å›0å°±è¡¨æ˜æ”¶åˆ°äº†FINæ®µ
<br>
<br><font color=black size = 5><a name="bc12">æœåŠ¡å™¨ç«¯</a></font>
<br> ç¨‹åºåŠŸèƒ½ï¼šå°†å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„å­—ç¬¦ä¸²è½¬æ¢ä¸ºå¤§å†™ç„¶åå‘é€ç»™å®¢æˆ·ç«¯
<br><div style="width:100%;border:1px #e3e3e3 solid;"><div style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;border-bottom:1px solid #e3e3e3;margin-top:5px;color:#000000;">&nbsp;C++ Code&nbsp;</div><table style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;vertical-align:text-top;line-height:15px;" border="0" cellspacing="0" cellpadding="0"><tr><td style="color:#008284;background-color:#e3e3e3;vertical-align:text-top;"><div style="margin:7px;text-align:right;white-space:nowrap;"><nobr>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44<br>45<br>46<br>47<br>48<br>49<br>50<br>51<br>52<br>53<br>54<br>55<br>56<br>57<br>58<br>59<br>60<br>61<br>62<br>63<br>64<br>65<br>66<br>67<br>68<br>69<br>70<br>71<br>72<br></nobr></div></td><td style="background-color:#008284;padding:1px;"><div style="border:1px #008284 solid;"></div></td><td style="background-color:#efefef;width:100%;vertical-align:text-top;color:#000000;"><div style="margin:7px;"><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;iostream&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;stdio.h&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;sys/socket.h&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;arpa/inet.h&gt;&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;åŒ…å«struct&nbsp;sockaddr&nbsp;ç»“æ„ä½“<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;unistd.h&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;stdlib.h&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;ctype.h&gt;<BR>
</span><span style="color:#0000ff;">using</span><span style="color:#000000;">&nbsp;</span><span style="color:#0000ff;">namespace</span><span style="color:#000000;">&nbsp;std;<BR>
<BR>
</span><span style="color:#0000ff;">const</span><span style="color:#000000;">&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;SERV_PORT&nbsp;=&nbsp;</span><span style="color:#ff0000;">6666</span><span style="color:#000000;">;<BR>
</span><span style="color:#0000ff;">const</span><span style="color:#000000;">&nbsp;string&nbsp;SERV_IP&nbsp;=&nbsp;</span><span style="color:#800000;">&quot;127.0.0.1&quot;</span><span style="color:#000000;">;<BR>
<BR>
</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;main()<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;lfd,&nbsp;cfd;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;ret;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">struct</span><span style="color:#000000;">&nbsp;sockaddr_in&nbsp;addr,&nbsp;clientaddr;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;addr.sin_family&nbsp;=&nbsp;AF_INET;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;addr.sin_port&nbsp;=&nbsp;htons(SERV_PORT);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;æœ¬åœ°çš„æœ‰æ•ˆçš„ä»»æ„IP<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;addr.sin_addr.s_addr&nbsp;=&nbsp;INADDR_ANY;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;addr.sin_addr.s_addr&nbsp;=&nbsp;inet_pton(SERV_IP);<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#8000ff;">char</span><span style="color:#000000;">&nbsp;buf[BUFSIZ],&nbsp;cIP[BUFSIZ];<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;n;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lfd&nbsp;=&nbsp;socket(AF_INET,&nbsp;SOCK_STREAM,&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(lfd&nbsp;==&nbsp;-</span><span style="color:#ff0000;">1</span><span style="color:#000000;">)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cerr&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;Create&nbsp;socket&nbsp;failed!&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(</span><span style="color:#ff0000;">1</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;create&nbsp;socket&nbsp;success&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;bind(lfd,&nbsp;(</span><span style="color:#0000ff;">struct</span><span style="color:#000000;">&nbsp;sockaddr&nbsp;*)&amp;addr,&nbsp;</span><span style="color:#0000ff;">sizeof</span><span style="color:#000000;">(addr));<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(ret&nbsp;==&nbsp;-</span><span style="color:#ff0000;">1</span><span style="color:#000000;">)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cerr&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;bind&nbsp;failed!&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(</span><span style="color:#ff0000;">1</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;bind&nbsp;success&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;listen(lfd,&nbsp;</span><span style="color:#ff0000;">32</span><span style="color:#000000;">);&nbsp;&nbsp;</span><span style="color:#008000;">//é»˜è®¤å€¼ä¸º128ï¼Œä¸ºæœ€å¤§ä¸Šé™<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(ret&nbsp;==&nbsp;-</span><span style="color:#ff0000;">1</span><span style="color:#000000;">)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cerr&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;listen&nbsp;failed!&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(</span><span style="color:#ff0000;">1</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;listen&nbsp;success&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;socklen_t&nbsp;clientaddr_len,&nbsp;IP_len;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clientaddr_len&nbsp;=&nbsp;</span><span style="color:#0000ff;">sizeof</span><span style="color:#000000;">(clientaddr);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;ready&nbsp;accept&nbsp;client&nbsp;......&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cfd&nbsp;=&nbsp;accept(lfd,&nbsp;(</span><span style="color:#0000ff;">struct</span><span style="color:#000000;">&nbsp;sockaddr&nbsp;*)&amp;clientaddr,&nbsp;&amp;clientaddr_len);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(cfd&nbsp;==&nbsp;-</span><span style="color:#ff0000;">1</span><span style="color:#000000;">)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cerr&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;accept&nbsp;failed!&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(</span><span style="color:#ff0000;">1</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inet_ntop(AF_INET,&nbsp;&amp;clientaddr.sin_addr.s_addr,&nbsp;cIP,&nbsp;</span><span style="color:#0000ff;">sizeof</span><span style="color:#000000;">(cIP));<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;accept&nbsp;success!&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;client&nbsp;IP:&nbsp;&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;cIP&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;client&nbsp;Port:&nbsp;&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;ntohs(clientaddr.sin_port)&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">while</span><span style="color:#000000;">&nbsp;(</span><span style="color:#ff0000;">1</span><span style="color:#000000;">)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n&nbsp;=&nbsp;read(cfd,&nbsp;buf,&nbsp;</span><span style="color:#0000ff;">sizeof</span><span style="color:#000000;">(buf));<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">for</span><span style="color:#000000;">&nbsp;(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;i&nbsp;=&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;&nbsp;i&nbsp;&lt;&nbsp;n;&nbsp;++i)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buf[i]&nbsp;=&nbsp;toupper(buf[i]);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;è½¬æ¢ä¸ºå¤§å†™&nbsp;å‡½æ•°<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;tolower&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è½¬æ¢ä¸ºå°å†™&nbsp;å‡½æ•°<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;write(cfd,&nbsp;buf,&nbsp;n);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;close(lfd);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;close(cfd);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;<BR>
}</span></div></td></tr></table></div>
<br>
<br><font color=black size = 5><a name="bc13">å®¢æˆ·ç«¯</a></font>
<br><div style="width:100%;border:1px #e3e3e3 solid;"><div style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;border-bottom:1px solid #e3e3e3;margin-top:5px;color:#000000;">&nbsp;C++ Code&nbsp;</div><table style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;vertical-align:text-top;line-height:15px;" border="0" cellspacing="0" cellpadding="0"><tr><td style="color:#008284;background-color:#e3e3e3;vertical-align:text-top;"><div style="margin:7px;text-align:right;white-space:nowrap;"><nobr>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44<br>45<br>46<br>47<br>48<br>49<br>50<br>51<br>52<br>53<br>54<br></nobr></div></td><td style="background-color:#008284;padding:1px;"><div style="border:1px #008284 solid;"></div></td><td style="background-color:#efefef;width:100%;vertical-align:text-top;color:#000000;"><div style="margin:7px;"><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;stdio.h&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;iostream&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;stdlib.h&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;string.h&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;memsetå¤´<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;strings.h&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;bzeroå¤´<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;sys/socket.h&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;unistd.h&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;arpa/inet.h&gt;<BR>
</span><span style="color:#0000ff;">using</span><span style="color:#000000;">&nbsp;</span><span style="color:#0000ff;">namespace</span><span style="color:#000000;">&nbsp;std;<BR>
</span><span style="color:#0000ff;">const</span><span style="color:#000000;">&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;SERV_PORT&nbsp;=&nbsp;</span><span style="color:#ff0000;">6666</span><span style="color:#000000;">;<BR>
</span><span style="color:#0000ff;">const</span><span style="color:#000000;">&nbsp;</span><span style="color:#8000ff;">char</span><span style="color:#000000;">*&nbsp;SERV_IP&nbsp;=&nbsp;</span><span style="color:#800000;">&quot;127.0.0.1&quot;</span><span style="color:#000000;">;<BR>
<BR>
</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;main()<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;cfd;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;ret;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;n;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#8000ff;">char</span><span style="color:#000000;">&nbsp;buf[BUFSIZ];<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">struct</span><span style="color:#000000;">&nbsp;sockaddr_in&nbsp;saddr;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;socklen_t&nbsp;saddr_len;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cfd&nbsp;=&nbsp;socket(AF_INET,&nbsp;SOCK_STREAM,&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(cfd&nbsp;==&nbsp;-</span><span style="color:#ff0000;">1</span><span style="color:#000000;">)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cerr&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;create&nbsp;socket&nbsp;failed!&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(</span><span style="color:#ff0000;">1</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;å°†ä¸€æ®µå†…å­˜ç©ºé—´æ¸…æˆä»»æ„å€¼&nbsp;&nbsp;&nbsp;&nbsp;bzero()&nbsp;å‡½æ•°ä¸ºæ¸…0<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;bzero(&amp;saddr,&nbsp;sizeof(saddr));<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;memset(&amp;saddr,&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">,&nbsp;</span><span style="color:#0000ff;">sizeof</span><span style="color:#000000;">(saddr));<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;saddr.sin_family&nbsp;=&nbsp;AF_INET;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;saddr.sin_port&nbsp;=&nbsp;htons(SERV_PORT);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;inet_pton(AF_INET,&nbsp;SERV_IP,&nbsp;&amp;saddr.sin_addr.s_addr);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(ret&nbsp;==&nbsp;-</span><span style="color:#ff0000;">1</span><span style="color:#000000;">)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cerr&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;inet_pton&nbsp;error!&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(</span><span style="color:#ff0000;">1</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;connect(cfd,&nbsp;(</span><span style="color:#0000ff;">struct</span><span style="color:#000000;">&nbsp;sockaddr&nbsp;*)&amp;saddr,&nbsp;</span><span style="color:#0000ff;">sizeof</span><span style="color:#000000;">(saddr));<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(ret&nbsp;==&nbsp;-</span><span style="color:#ff0000;">1</span><span style="color:#000000;">)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cerr&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;connect&nbsp;failed!&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(</span><span style="color:#ff0000;">1</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cout&nbsp;&lt;&lt;&nbsp;</span><span style="color:#800000;">&quot;connect&nbsp;success!&quot;</span><span style="color:#000000;">&nbsp;&lt;&lt;&nbsp;endl;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">while</span><span style="color:#000000;">(</span><span style="color:#ff0000;">1</span><span style="color:#000000;">)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fgets(buf,&nbsp;</span><span style="color:#0000ff;">sizeof</span><span style="color:#000000;">(buf),&nbsp;stdin);&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;fgetä¼šåœ¨å­—ä¸²åè¾¹åŠ &nbsp;'\0'<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;write(cfd,&nbsp;buf,&nbsp;strlen(buf));<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n&nbsp;=&nbsp;read(cfd,&nbsp;buf,&nbsp;</span><span style="color:#0000ff;">sizeof</span><span style="color:#000000;">(buf));<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;write(STDOUT_FILENO,&nbsp;buf,&nbsp;n);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;close&nbsp;(cfd);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;<BR>
}</span></div></td></tr></table></div>
<br> âœ¦ ç”±äºå®¢æˆ·ç«¯ä¸éœ€è¦å›ºå®šçš„ç«¯å£å·ï¼Œå› æ­¤ä¸å¿…è°ƒç”¨bind()ï¼Œå®¢æˆ·ç«¯çš„ç«¯å£å·ç”±å†…æ ¸è‡ªåŠ¨åˆ†é…ã€‚æ³¨æ„ï¼Œå®¢æˆ·ç«¯ä¸æ˜¯ä¸å…è®¸è°ƒç”¨bind()ï¼Œåªæ˜¯æ²¡æœ‰å¿…è¦è°ƒç”¨bind()å›ºå®šä¸€ä¸ªç«¯å£å·ï¼ŒæœåŠ¡å™¨ä¹Ÿä¸æ˜¯å¿…é¡»è°ƒç”¨bind()ï¼Œä½†å¦‚æœæœåŠ¡å™¨ä¸è°ƒç”¨bind()ï¼Œå†…æ ¸ä¼šè‡ªåŠ¨ç»™æœåŠ¡å™¨åˆ†é…ç›‘å¬ç«¯å£ï¼Œæ¯æ¬¡å¯åŠ¨æœåŠ¡å™¨æ—¶ç«¯å£å·éƒ½ä¸ä¸€æ ·ï¼Œå®¢æˆ·ç«¯è¦è¿æ¥æœåŠ¡å™¨å°±ä¼šé‡åˆ°éº»çƒ¦ã€‚
<br> ğŸ¤  å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å¯åŠ¨åå¯ä»¥ä½¿ç”¨netstatå‘½ä»¤æŸ¥çœ‹é“¾æ¥æƒ…å†µï¼š netstat -apn|grep 6666
<br>
<br><font color=black size = 5><a name="bc14">å‡ºé”™å¤„ç†å°è£…å‡½æ•°</a></font>
<br> âœ¦ ä¸Šé¢çš„ä¾‹å­ä¸ä»…åŠŸèƒ½ç®€å•ï¼Œè€Œä¸”ç®€å•åˆ°å‡ ä¹æ²¡æœ‰ä»€ä¹ˆé”™è¯¯å¤„ç†ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œç³»ç»Ÿè°ƒç”¨ä¸èƒ½ä¿è¯æ¯æ¬¡éƒ½æˆåŠŸï¼Œå¿…é¡»è¿›è¡Œå‡ºé”™å¤„ç†ï¼Œè¿™æ ·ä¸€æ–¹é¢å¯ä»¥ä¿è¯ç¨‹åºé€»è¾‘æ­£å¸¸ï¼Œå¦ä¸€æ–¹é¢å¯ä»¥è¿…é€Ÿå¾—åˆ°æ•…éšœä¿¡æ¯ã€‚
<br> âœ¦ ä¸ºä½¿é”™è¯¯å¤„ç†çš„ä»£ç ä¸å½±å“ä¸»ç¨‹åºçš„å¯è¯»æ€§ï¼Œæˆ‘ä»¬æŠŠä¸socketç›¸å…³çš„ä¸€äº›ç³»ç»Ÿå‡½æ•°åŠ ä¸Šé”™è¯¯å¤„ç†ä»£ç åŒ…è£…æˆæ–°çš„å‡½æ•°ï¼Œåšæˆä¸€ä¸ªæ¨¡å—wrap.cï¼š
<br> â™š wrap.cpp
<br>div style=&quot;width:100%;border:1px #e3e3e3 solid;&quot;&gt;<div style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;border-bottom:1px solid #e3e3e3;margin-top:5px;color:#000000;">&nbsp;C++ Code&nbsp;</div><table style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;vertical-align:text-top;line-height:15px;" border="0" cellspacing="0" cellpadding="0"><tr><td style="color:#008284;background-color:#e3e3e3;vertical-align:text-top;"><div style="margin:7px;text-align:right;white-space:nowrap;"><nobr>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44<br>45<br>46<br>47<br>48<br>49<br>50<br>51<br>52<br>53<br>54<br>55<br>56<br>57<br>58<br>59<br>60<br>61<br>62<br>63<br>64<br>65<br>66<br>67<br>68<br>69<br>70<br>71<br>72<br>73<br>74<br>75<br>76<br>77<br>78<br>79<br>80<br>81<br>82<br>83<br>84<br>85<br>86<br>87<br>88<br>89<br>90<br>91<br>92<br>93<br>94<br>95<br>96<br>97<br>98<br>99<br>100<br>101<br>102<br>103<br>104<br>105<br>106<br>107<br>108<br>109<br>110<br>111<br>112<br>113<br>114<br>115<br>116<br>117<br>118<br>119<br>120<br>121<br>122<br>123<br>124<br>125<br>126<br>127<br>128<br>129<br>130<br>131<br>132<br>133<br>134<br>135<br>136<br>137<br>138<br>139<br>140<br>141<br>142<br>143<br>144<br>145<br>146<br>147<br>148<br>149<br>150<br>151<br>152<br>153<br>154<br>155<br>156<br>157<br>158<br>159<br>160<br>161<br>162<br>163<br>164<br>165<br>166<br></nobr></div></td><td style="background-color:#008284;padding:1px;"><div style="border:1px #008284 solid;"></div></td><td style="background-color:#efefef;width:100%;vertical-align:text-top;color:#000000;"><div style="margin:7px;"><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;stdlib.h&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;errno.h&gt;<BR>
</span><span style="color:#0000ff;">#include</span><span style="color:#000000;">&nbsp;&lt;sys/socket.h&gt;<BR>
</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;perr_exit(</span><span style="color:#0000ff;">const</span><span style="color:#000000;">&nbsp;</span><span style="color:#8000ff;">char</span><span style="color:#000000;">&nbsp;*s)<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;perror(s);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;exit(</span><span style="color:#ff0000;">1</span><span style="color:#000000;">);<BR>
}<BR>
</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;Accept(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;fd,&nbsp;</span><span style="color:#0000ff;">struct</span><span style="color:#000000;">&nbsp;sockaddr&nbsp;*sa,&nbsp;socklen_t&nbsp;*salenptr)<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;n;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;again:<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(&nbsp;(n&nbsp;=&nbsp;accept(fd,&nbsp;sa,&nbsp;salenptr))&nbsp;&lt;&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">)&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;((errno&nbsp;==&nbsp;ECONNABORTED)&nbsp;||&nbsp;(errno&nbsp;==&nbsp;EINTR))<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">goto</span><span style="color:#000000;">&nbsp;again;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">else</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;perr_exit(</span><span style="color:#800000;">&quot;accept&nbsp;error&quot;</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;n;<BR>
}<BR>
</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;Bind(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;fd,&nbsp;</span><span style="color:#0000ff;">const</span><span style="color:#000000;">&nbsp;</span><span style="color:#0000ff;">struct</span><span style="color:#000000;">&nbsp;sockaddr&nbsp;*sa,&nbsp;socklen_t&nbsp;salen)<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;n;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;((n&nbsp;=&nbsp;bind(fd,&nbsp;sa,&nbsp;salen))&nbsp;&lt;&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;perr_exit(</span><span style="color:#800000;">&quot;bind&nbsp;error&quot;</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;n;<BR>
}<BR>
</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;Connect(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;fd,&nbsp;</span><span style="color:#0000ff;">const</span><span style="color:#000000;">&nbsp;</span><span style="color:#0000ff;">struct</span><span style="color:#000000;">&nbsp;sockaddr&nbsp;*sa,&nbsp;socklen_t&nbsp;salen)<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;n;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;((n&nbsp;=&nbsp;connect(fd,&nbsp;sa,&nbsp;salen))&nbsp;&lt;&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;perr_exit(</span><span style="color:#800000;">&quot;connect&nbsp;error&quot;</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;n;<BR>
}<BR>
</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;Listen(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;fd,&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;backlog)<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;n;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;((n&nbsp;=&nbsp;listen(fd,&nbsp;backlog))&nbsp;&lt;&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;perr_exit(</span><span style="color:#800000;">&quot;listen&nbsp;error&quot;</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;n;<BR>
}<BR>
</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;Socket(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;family,&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;type,&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;protocol)<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;n;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(&nbsp;(n&nbsp;=&nbsp;socket(family,&nbsp;type,&nbsp;protocol))&nbsp;&lt;&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;perr_exit(</span><span style="color:#800000;">&quot;socket&nbsp;error&quot;</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;n;<BR>
}<BR>
ssize_t&nbsp;Read(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;fd,&nbsp;</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;*ptr,&nbsp;size_t&nbsp;nbytes)<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;ssize_t&nbsp;n;<BR>
again:<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(&nbsp;(n&nbsp;=&nbsp;read(fd,&nbsp;ptr,&nbsp;nbytes))&nbsp;==&nbsp;-</span><span style="color:#ff0000;">1</span><span style="color:#000000;">)&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(errno&nbsp;==&nbsp;EINTR)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">goto</span><span style="color:#000000;">&nbsp;again;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">else</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;-</span><span style="color:#ff0000;">1</span><span style="color:#000000;">;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;n;<BR>
}<BR>
ssize_t&nbsp;Write(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;fd,&nbsp;</span><span style="color:#0000ff;">const</span><span style="color:#000000;">&nbsp;</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;*ptr,&nbsp;size_t&nbsp;nbytes)<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;ssize_t&nbsp;n;<BR>
again:<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(&nbsp;(n&nbsp;=&nbsp;write(fd,&nbsp;ptr,&nbsp;nbytes))&nbsp;==&nbsp;-</span><span style="color:#ff0000;">1</span><span style="color:#000000;">)&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(errno&nbsp;==&nbsp;EINTR)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">goto</span><span style="color:#000000;">&nbsp;again;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">else</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;-</span><span style="color:#ff0000;">1</span><span style="color:#000000;">;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;n;<BR>
}<BR>
</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;Close(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;fd)<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;n;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;((n&nbsp;=&nbsp;close(fd))&nbsp;==&nbsp;-</span><span style="color:#ff0000;">1</span><span style="color:#000000;">)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;perr_exit(</span><span style="color:#800000;">&quot;close&nbsp;error&quot;</span><span style="color:#000000;">);<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;n;<BR>
}<BR>
</span><span style="color:#008000;">/*&nbsp;å‚æ•°ä¸‰ï¼šåº”è¯¥è¯»å–çš„å­—èŠ‚æ•°&nbsp;*/</span><span style="color:#000000;"><BR>
ssize_t&nbsp;Readn(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;fd,&nbsp;</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;*vptr,&nbsp;size_t&nbsp;n)<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;size_t&nbsp;nleft;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;unsigned&nbsp;int&nbsp;å‰©ä½™æœªè¯»å–çš„å­—èŠ‚æ•°<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;ssize_t&nbsp;nread;&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;int&nbsp;å®é™…è¯»åˆ°çš„å­—èŠ‚æ•°<BR>
</span><span style="color:#000000;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#8000ff;">char</span><span style="color:#000000;">&nbsp;*ptr;<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;ptr&nbsp;=&nbsp;vptr;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;nleft&nbsp;=&nbsp;n;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#008000;">//&nbsp;n&nbsp;æœªè¯»å–å­—èŠ‚æ•°<BR>
</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">while</span><span style="color:#000000;">&nbsp;(nleft&nbsp;&gt;&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">)&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(&nbsp;(nread&nbsp;=&nbsp;read(fd,&nbsp;ptr,&nbsp;nleft))&nbsp;&lt;&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">)&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(errno&nbsp;==&nbsp;EINTR)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nread&nbsp;=&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">else</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;-</span><span style="color:#ff0000;">1</span><span style="color:#000000;">;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;</span><span style="color:#0000ff;">else</span><span style="color:#000000;">&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(nread&nbsp;==&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">break</span><span style="color:#000000;">;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nleft&nbsp;-=&nbsp;nread;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr&nbsp;+=&nbsp;nread;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;n&nbsp;-&nbsp;nleft;<BR>
}<BR>
<BR>
ssize_t&nbsp;Writen(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;fd,&nbsp;</span><span style="color:#0000ff;">const</span><span style="color:#000000;">&nbsp;</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;*vptr,&nbsp;size_t&nbsp;n)<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;size_t&nbsp;nleft;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;ssize_t&nbsp;nwritten;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">const</span><span style="color:#000000;">&nbsp;</span><span style="color:#8000ff;">char</span><span style="color:#000000;">&nbsp;*ptr;<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;ptr&nbsp;=&nbsp;vptr;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;nleft&nbsp;=&nbsp;n;<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">while</span><span style="color:#000000;">&nbsp;(nleft&nbsp;&gt;&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">)&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(&nbsp;(nwritten&nbsp;=&nbsp;write(fd,&nbsp;ptr,&nbsp;nleft))&nbsp;&lt;=&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">)&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(nwritten&nbsp;&lt;&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">&nbsp;&amp;&amp;&nbsp;errno&nbsp;==&nbsp;EINTR)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nwritten&nbsp;=&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">else</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;-</span><span style="color:#ff0000;">1</span><span style="color:#000000;">;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nleft&nbsp;-=&nbsp;nwritten;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr&nbsp;+=&nbsp;nwritten;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;n;<BR>
}<BR>
<BR>
</span><span style="color:#0000ff;">static</span><span style="color:#000000;">&nbsp;ssize_t&nbsp;my_read(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;fd,&nbsp;</span><span style="color:#8000ff;">char</span><span style="color:#000000;">&nbsp;*ptr)<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">static</span><span style="color:#000000;">&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;read_cnt;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">static</span><span style="color:#000000;">&nbsp;</span><span style="color:#8000ff;">char</span><span style="color:#000000;">&nbsp;*read_ptr;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">static</span><span style="color:#000000;">&nbsp;</span><span style="color:#8000ff;">char</span><span style="color:#000000;">&nbsp;read_buf[</span><span style="color:#ff0000;">100</span><span style="color:#000000;">];<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(read_cnt&nbsp;&lt;=&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">)&nbsp;{<BR>
again:<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;((read_cnt&nbsp;=&nbsp;read(fd,&nbsp;read_buf,&nbsp;</span><span style="color:#0000ff;">sizeof</span><span style="color:#000000;">(read_buf)))&nbsp;&lt;&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">)&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(errno&nbsp;==&nbsp;EINTR)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">goto</span><span style="color:#000000;">&nbsp;again;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;-</span><span style="color:#ff0000;">1</span><span style="color:#000000;">;&nbsp;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;</span><span style="color:#0000ff;">else</span><span style="color:#000000;">&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(read_cnt&nbsp;==&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;read_ptr&nbsp;=&nbsp;read_buf;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;read_cnt--;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;*ptr&nbsp;=&nbsp;*read_ptr++;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;</span><span style="color:#ff0000;">1</span><span style="color:#000000;">;<BR>
}<BR>
<BR>
ssize_t&nbsp;Readline(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;fd,&nbsp;</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;*vptr,&nbsp;size_t&nbsp;maxlen)<BR>
{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;ssize_t&nbsp;n,&nbsp;rc;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#8000ff;">char</span><span style="color:#000000;">&nbsp;c,&nbsp;*ptr;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;ptr&nbsp;=&nbsp;vptr;<BR>
<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">for</span><span style="color:#000000;">&nbsp;(n&nbsp;=&nbsp;</span><span style="color:#ff0000;">1</span><span style="color:#000000;">;&nbsp;n&nbsp;&lt;&nbsp;maxlen;&nbsp;n++)&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(&nbsp;(rc&nbsp;=&nbsp;my_read(fd,&nbsp;&amp;c))&nbsp;==&nbsp;</span><span style="color:#ff0000;">1</span><span style="color:#000000;">)&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*ptr++&nbsp;=&nbsp;c;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(c&nbsp;==&nbsp;</span><span style="color:#800000;">'\n'</span><span style="color:#000000;">)<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">break</span><span style="color:#000000;">;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;</span><span style="color:#0000ff;">else</span><span style="color:#000000;">&nbsp;</span><span style="color:#0000ff;">if</span><span style="color:#000000;">&nbsp;(rc&nbsp;==&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">)&nbsp;{<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*ptr&nbsp;=&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;n&nbsp;-&nbsp;</span><span style="color:#ff0000;">1</span><span style="color:#000000;">;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;</span><span style="color:#0000ff;">else</span><span style="color:#000000;"><BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;-</span><span style="color:#ff0000;">1</span><span style="color:#000000;">;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;}<BR>
&nbsp;&nbsp;&nbsp;&nbsp;*ptr&nbsp;=&nbsp;</span><span style="color:#ff0000;">0</span><span style="color:#000000;">;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#0000ff;">return</span><span style="color:#000000;">&nbsp;n;<BR>
}</span></div></td></tr></table></div>
<br> â™š wrap.h
<br><div style="width:100%;border:1px #e3e3e3 solid;"><div style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;border-bottom:1px solid #e3e3e3;margin-top:5px;color:#000000;">&nbsp;C++ Code&nbsp;</div><table style="width:100%;font-family:'Consolas', 'Courier New';font-size:12px;vertical-align:text-top;line-height:15px;" border="0" cellspacing="0" cellpadding="0"><tr><td style="color:#008284;background-color:#e3e3e3;vertical-align:text-top;"><div style="margin:7px;text-align:right;white-space:nowrap;"><nobr>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br></nobr></div></td><td style="background-color:#008284;padding:1px;"><div style="border:1px #008284 solid;"></div></td><td style="background-color:#efefef;width:100%;vertical-align:text-top;color:#000000;"><div style="margin:7px;"><span style="color:#0000ff;">#ifndef</span><span style="color:#000000;">&nbsp;__WRAP_H_<BR>
</span><span style="color:#0000ff;">#define</span><span style="color:#000000;">&nbsp;__WRAP_H_<BR>
</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;perr_exit(</span><span style="color:#0000ff;">const</span><span style="color:#000000;">&nbsp;</span><span style="color:#8000ff;">char</span><span style="color:#000000;">&nbsp;*s);<BR>
</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;Accept(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;fd,&nbsp;</span><span style="color:#0000ff;">struct</span><span style="color:#000000;">&nbsp;sockaddr&nbsp;*sa,&nbsp;socklen_t&nbsp;*salenptr);<BR>
</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;Bind(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;fd,&nbsp;</span><span style="color:#0000ff;">const</span><span style="color:#000000;">&nbsp;</span><span style="color:#0000ff;">struct</span><span style="color:#000000;">&nbsp;sockaddr&nbsp;*sa,&nbsp;socklen_t&nbsp;salen);<BR>
</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;Connect(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;fd,&nbsp;</span><span style="color:#0000ff;">const</span><span style="color:#000000;">&nbsp;</span><span style="color:#0000ff;">struct</span><span style="color:#000000;">&nbsp;sockaddr&nbsp;*sa,&nbsp;socklen_t&nbsp;salen);<BR>
</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;Listen(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;fd,&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;backlog);<BR>
</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;Socket(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;family,&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;type,&nbsp;</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;protocol);<BR>
ssize_t&nbsp;Read(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;fd,&nbsp;</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;*ptr,&nbsp;size_t&nbsp;nbytes);<BR>
ssize_t&nbsp;Write(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;fd,&nbsp;</span><span style="color:#0000ff;">const</span><span style="color:#000000;">&nbsp;</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;*ptr,&nbsp;size_t&nbsp;nbytes);<BR>
</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;Close(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;fd);<BR>
ssize_t&nbsp;Readn(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;fd,&nbsp;</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;*vptr,&nbsp;size_t&nbsp;n);<BR>
ssize_t&nbsp;Writen(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;fd,&nbsp;</span><span style="color:#0000ff;">const</span><span style="color:#000000;">&nbsp;</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;*vptr,&nbsp;size_t&nbsp;n);<BR>
ssize_t&nbsp;my_read(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;fd,&nbsp;</span><span style="color:#8000ff;">char</span><span style="color:#000000;">&nbsp;*ptr);<BR>
ssize_t&nbsp;Readline(</span><span style="color:#8000ff;">int</span><span style="color:#000000;">&nbsp;fd,&nbsp;</span><span style="color:#8000ff;">void</span><span style="color:#000000;">&nbsp;*vptr,&nbsp;size_t&nbsp;maxlen);<BR>
</span><span style="color:#0000ff;">#endif</span></div></td></tr></table></div>
<br>
<br><font color=red size = 5><a name="bc15">readè¿”å›å€¼æ€»ç»“</a></font>
<br> â™š æ­£å¸¸æƒ…å†µï¼š&gt; 0ï¼Œå®é™…è¯»åˆ°çš„å­—èŠ‚æ•°
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0ã€å®é™…è¿”å›1024ï¼šbuf = 1024å­—èŠ‚
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1ã€è¯»åˆ°æ–‡ä»¶ç»“å°¾ï¼š&lt; buf    50
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2ã€è¿”å›é€€å‡º(è¯»åˆ°æ–‡ä»¶æœ«å°¾ã€ç®¡é“ã€socket)ï¼Œæœ«å°¾-å¯¹ç«¯å…³é—­ = 0
<br> â™š è¿”å› -1ï¼šå‡ºç°å¼‚å¸¸
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; é€šè¿‡ errno è¿›è¡Œè¿›ä¸€æ­¥ç»†åˆ†
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0ã€errno = EINTR    è¢«ä¿¡å·ä¸­æ–­
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1ã€errno = EAGAIN / EWOULDBLOCK    ä»¥éé˜»å¡æ–¹å¼è¯»å¹¶ä¸”æ— æ•°æ®
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2ã€errno = å…¶å®ƒå€¼    çœŸæ­£é”™è¯¯ï¼Œcerr â†’ exit(1)</p>

<p><br><br><br>
<font color = gray size = 3>å¦‚æœ‰é”™è¯¯ï¼Œæ¬¢è¿æŒ‡æ­£ï¼</font></p></div>
        <div class="post_footer">
          
          <div class="meta">
            <div class="info">
              <span class="field tags">
                <i class="remixicon-stack-line"></i>
                
                <a href="https://oubc.github.io/tags/linux/">Linux</a>
                
              </span>
            </div>
          </div>
          
        </div>
      </div>
      
      
    </div>
  </div>
  <a id="back_to_top" href="#" class="back_to_top"><span>â–³</span></a>
</div>
<footer class="footer">
  <div class="powered_by">
    <a href="https://wxt.sinaimg.cn/thumb300/007Diza3ly1g4l9lmg4aog3074074gnf.gif?tags=%5B%5D">I </a>
	<a href="">love</a>
    <a href="https://wxt.sinaimg.cn/thumb300/007Diza3ly1g4l9lmfm2eg306o06o74u.gif?tags=%5B%5D"> you </a>
    <a href="https://wxt.sinaimg.cn/thumb300/007Diza3ly1g4njrx4tpcj30fn0bq3zg.jpg?tags=%5B%5D">three </a>
	<a href="https://wxt.sinaimg.cn/thumb300/007Diza3ly1g4njrx64ctg307s07swfy.gif?tags=%5B%5D">thousand</a>
    <a href="https://www.kugou.com/song/#hash=96426C78381DE98DC31A5846FC274CBF&album_id=646623"> times.</a>
  </div>

  <div class="footer_slogan">
    <span>å®¶åº­ã€æ¢¦æƒ³ã€å†…å¿ƒçš„å¹³é™</span>
  </div>
</footer>



<script src="https://oubc.github.io/js/jquery-3.3.1.min.js"></script>
<script src="https://oubc.github.io/js/zozo.js"></script>
<script src="https://oubc.github.io/js/highlight.pack.js"></script>
<link  href="https://oubc.github.io/css/fancybox.min.css" rel="stylesheet">
<script src="https://oubc.github.io/js/fancybox.min.js"></script>

<script>hljs.initHighlightingOnLoad()</script>


  <script type="text/javascript" async src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[\[','\]\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});

MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<style>
code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
}
</style>






</body>
</html>
